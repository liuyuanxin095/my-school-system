<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ ¡è€ƒå‹¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Microsoft JhengHei', sans-serif; height: 100vh; overflow: hidden; }
        .clock-container { font-size: 4rem; font-weight: bold; color: #343a40; font-family: monospace; }
        .date-container { font-size: 1.5rem; color: #6c757d; margin-bottom: 2rem; }
        .input-area { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* çµæœå¡ç‰‡å‹•ç•« */
        .result-card { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1050; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .avatar-circle { width: 180px; height: 180px; border-radius: 50%; border: 5px solid white; object-fit: cover; margin-bottom: 20px; }
        .status-text { font-size: 3rem; font-weight: bold; margin: 20px 0; padding: 10px 30px; border-radius: 50px; }
        
        /* æ•™è·å“¡æŒ‰éˆ•å€ */
        .emp-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 600px; }
        .btn-punch { height: 120px; font-size: 1.5rem; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* å›é¦–é æŒ‰éˆ• */
        .home-btn { position: absolute; top: 20px; right: 20px; }
    </style>
</head>
<body>

<a href="login.html" class="btn btn-outline-secondary home-btn"><i class="bi bi-box-arrow-right"></i> å›ç™»å…¥é </a>

<div class="container h-100 d-flex flex-column justify-content-center align-items-center text-center">
    
    <div id="clock" class="clock-container">00:00:00</div>
    <div id="date" class="date-container">YYYY-MM-DD Week</div>

    <div class="input-area w-100">
        <h4 class="mb-4 fw-bold text-primary"><i class="bi bi-person-badge"></i> åˆ·å¡ / è¼¸å…¥ç·¨è™Ÿ</h4>
        <div class="input-group input-group-lg mb-3">
            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
            <input type="text" id="inputScan" class="form-control text-center fs-4" placeholder="è«‹æƒææˆ–è¼¸å…¥..." autofocus autocomplete="off">
        </div>
        <div class="text-muted small">å­¸ç”Ÿï¼šè¼¸å…¥å­¸è™Ÿæˆ–åˆ·å¡<br>æ•™è·å“¡ï¼šè¼¸å…¥ç·¨è™Ÿ(éœ€å¯†ç¢¼)æˆ–åˆ·å¡</div>
    </div>
</div>

<div class="modal fade" id="pwdModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold text-dark"><i class="bi bi-lock-fill"></i> èº«åˆ†é©—è­‰</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="resetInput()"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="pwdAvatar" src="" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;">
                <h4 id="pwdName" class="mb-3">---</h4>
                <p class="text-muted">è«‹è¼¸å…¥æ‚¨çš„è€ƒå‹¤å¯†ç¢¼</p>
                <input type="password" id="authPwd" class="form-control form-control-lg text-center font-monospace mb-3" maxlength="6" placeholder="******">
                <button class="btn btn-warning w-100 btn-lg" onclick="verifyEmpPassword()">é©—è­‰</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">è«‹é¸æ“‡æ‰“å¡é …ç›®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="resetInput()"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <img id="actionAvatar" src="" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;">
                    <h3 id="actionName" class="d-inline-block ms-3 align-middle">---</h3>
                </div>
                <div class="emp-actions mx-auto">
                    <button class="btn btn-primary btn-punch" onclick="submitEmpPunch('WORK_IN')">
                        <i class="bi bi-sun-fill fs-1 mb-2"></i> ä¸Šç­
                    </button>
                    <button class="btn btn-secondary btn-punch" onclick="submitEmpPunch('WORK_OUT')">
                        <i class="bi bi-moon-stars-fill fs-1 mb-2"></i> ä¸‹ç­
                    </button>
                    <button class="btn btn-danger btn-punch" onclick="submitEmpPunch('OT_IN')">
                        <i class="bi bi-lightning-charge-fill fs-1 mb-2"></i> åŠ ç­ä¸Šç­
                    </button>
                    <button class="btn btn-success btn-punch" onclick="submitEmpPunch('OT_OUT')">
                        <i class="bi bi-house-door-fill fs-1 mb-2"></i> åŠ ç­ä¸‹ç­
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="resultOverlay" class="result-card" onclick="closeResult()">
    <img id="resPhoto" src="" class="avatar-circle">
    <div id="resName" class="display-4 fw-bold">---</div>
    <div id="resId" class="h3 text-white-50 font-monospace">---</div>
    <div id="resStatus" class="status-text">---</div>
    <div id="resTime" class="h4 mt-3">---</div>
    <div class="mt-5 text-white-50 small">é»æ“Šä»»æ„è™•é—œé–‰</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/config.js"></script>

<script>
    let currentEmp = null;
    let inputSource = '';

    document.addEventListener('DOMContentLoaded', () => {
        // æª¢æŸ¥è¨­å®šæª”
        if (typeof window.db === 'undefined') {
            Swal.fire('éŒ¯èª¤', 'æ‰¾ä¸åˆ° js/config.jsï¼Œè«‹æª¢æŸ¥æª”æ¡ˆä½ç½®', 'error');
            return;
        }

        updateTime();
        setInterval(updateTime, 1000);
        
        const input = document.getElementById('inputScan');
        input.focus();
        
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') processInput();
        });

        document.body.addEventListener('click', (e) => {
            if(!e.target.closest('.modal') && !e.target.closest('input')) input.focus();
        });
    });

    function updateTime() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false });
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('date').textContent = now.toLocaleDateString('zh-TW', options);
    }

    async function processInput() {
        const inputEl = document.getElementById('inputScan');
        const val = inputEl.value.trim();
        if (!val) return;

        inputEl.disabled = true;

        try {
            // 1. æ‰¾å­¸ç”Ÿ
            const { data: students } = await window.db.from('students')
                .select('*')
                .or(`student_id.eq.${val},card_number.eq.${val}`);

            if (students && students.length > 0) {
                await handleStudentAttendance(students[0], val);
                resetInput();
                return;
            }

            // 2. æ‰¾æ•™è·å“¡
            const { data: employees } = await window.db.from('employees')
                .select('*')
                .or(`employee_id.eq.${val},card_number.eq.${val}`)
                .single();

            if (employees) {
                currentEmp = employees;
                if (val === employees.employee_id) {
                    inputSource = 'ID_PWD';
                    showPwdModal();
                } else {
                    inputSource = 'CARD';
                    showActionModal();
                }
            } else {
                Swal.fire({ icon: 'error', title: 'æŸ¥ç„¡è³‡æ–™', text: 'æ‰¾ä¸åˆ°æ­¤ç·¨è™Ÿæˆ–å¡ç‰‡', timer: 1500, showConfirmButton: false });
                resetInput();
            }

        } catch (err) {
            console.error(err);
            if (err.code === 'PGRST116') { // æŸ¥ç„¡è³‡æ–™
                 Swal.fire({ icon: 'error', title: 'æŸ¥ç„¡è³‡æ–™', timer: 1500, showConfirmButton: false });
            } else {
                 Swal.fire('ç³»çµ±éŒ¯èª¤', err.message, 'error');
            }
            resetInput();
        }
    }

    // --- å­¸ç”Ÿé‚è¼¯ ---
    async function handleStudentAttendance(stu, source) {
        const todayStart = new Date(); todayStart.setHours(0,0,0,0);
        const { data: logs } = await window.db.from('attendance_logs')
            .select('*')
            .eq('student_id', stu.id)
            .gte('check_time', todayStart.toISOString())
            .order('check_time', { ascending: false })
            .limit(1);

        let type = 'IN';
        if (logs && logs.length > 0 && logs[0].check_type === 'IN') type = 'OUT';

        await window.db.from('attendance_logs').insert([{
            student_id: stu.id, check_type: type, input_source: source
        }]);

        showResult(stu.name_zh, stu.student_id, stu.photo_url, type === 'IN' ? 'âœ… åˆ°æ ¡' : 'ğŸ‘‹ é›¢æ ¡', type === 'IN' ? '#198754' : '#ffc107');
    }

    // --- æ•™è·å“¡é‚è¼¯ ---
    function showPwdModal() {
        const photo = currentEmp.photo_url || `https://ui-avatars.com/api/?name=${currentEmp.name}`;
        document.getElementById('pwdAvatar').src = photo;
        document.getElementById('pwdName').textContent = currentEmp.name;
        document.getElementById('authPwd').value = '';
        
        // é€™è£¡éœ€è¦ Bootstrap JS
        const modal = new bootstrap.Modal(document.getElementById('pwdModal'));
        modal.show();
        
        setTimeout(() => document.getElementById('authPwd').focus(), 500);
        
        document.getElementById('authPwd').onkeypress = (e) => {
            if(e.key === 'Enter') verifyEmpPassword();
        };
    }

    function verifyEmpPassword() {
        const pwd = document.getElementById('authPwd').value;
        if (pwd === currentEmp.clock_in_password) {
            bootstrap.Modal.getInstance(document.getElementById('pwdModal')).hide();
            showActionModal();
        } else {
            Swal.fire('éŒ¯èª¤', 'å¯†ç¢¼ä¸æ­£ç¢º', 'error');
            document.getElementById('authPwd').value = '';
        }
    }

    function showActionModal() {
        const photo = currentEmp.photo_url || `https://ui-avatars.com/api/?name=${currentEmp.name}`;
        document.getElementById('actionAvatar').src = photo;
        document.getElementById('actionName').textContent = currentEmp.name;
        
        const modal = new bootstrap.Modal(document.getElementById('actionModal'));
        modal.show();
    }

    async function submitEmpPunch(type) {
        bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
        
        const { error } = await window.db.from('employee_attendance_logs').insert([{
            employee_id: currentEmp.id,
            check_type: type,
            input_source: inputSource
        }]);

        if (error) {
            Swal.fire('éŒ¯èª¤', error.message, 'error');
        } else {
            let statusText = '', color = '';
            switch(type) {
                case 'WORK_IN': statusText = 'ğŸŒ ä¸Šç­'; color = '#0d6efd'; break;
                case 'WORK_OUT': statusText = 'ğŸŒ™ ä¸‹ç­'; color = '#6c757d'; break;
                case 'OT_IN': statusText = 'ğŸ’ª åŠ ç­ä¸Š'; color = '#dc3545'; break;
                case 'OT_OUT': statusText = 'ğŸ  åŠ ç­ä¸‹'; color = '#198754'; break;
            }
            showResult(currentEmp.name, currentEmp.employee_id, currentEmp.photo_url, statusText, color);
        }
        resetInput();
    }

    // --- é€šç”¨ UI ---
    function showResult(name, id, photo, status, color) {
        const overlay = document.getElementById('resultOverlay');
        document.getElementById('resName').textContent = name;
        document.getElementById('resId').textContent = id;
        document.getElementById('resPhoto').src = photo || `https://ui-avatars.com/api/?name=${name}`;
        
        const sEl = document.getElementById('resStatus');
        sEl.textContent = status;
        sEl.style.backgroundColor = color;
        
        document.getElementById('resTime').textContent = new Date().toLocaleTimeString();
        overlay.style.display = 'flex';
        setTimeout(closeResult, 3000);
    }

    function closeResult() {
        document.getElementById('resultOverlay').style.display = 'none';
        resetInput();
    }

    function resetInput() {
        const el = document.getElementById('inputScan');
        el.value = '';
        el.disabled = false;
        el.focus();
        currentEmp = null;
    }
</script>
</body>
</html>
