<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課表檢視與調整</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .schedule-table th, .schedule-table td { text-align: center; vertical-align: middle; height: 80px; }
        .cell-content { font-size: 0.9rem; }
        .sub-name { font-weight: bold; display: block; font-size: 1rem; color: #0d6efd; }
        .tea-name { font-size: 0.8rem; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary"><i class="bi bi-table"></i> 課表檢視與調整</h3>
        <a href="course_dashboard.html" class="btn btn-outline-secondary"><i class="bi bi-arrow-return-left"></i> 回儀表板</a>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body d-flex align-items-center gap-3">
            <label class="fw-bold">檢視對象：</label>
            <select id="viewType" class="form-select w-auto">
                <option value="class">班級課表</option>
                </select>
            <select id="targetSelect" class="form-select w-auto fw-bold" onchange="loadSchedule()">
                <option value="">(請選擇)</option>
            </select>
            <button class="btn btn-primary" onclick="loadSchedule()">查詢</button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-bordered schedule-table mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="10%">節次</th>
                        <th width="18%">週一</th>
                        <th width="18%">週二</th>
                        <th width="18%">週三</th>
                        <th width="18%">週四</th>
                        <th width="18%">週五</th>
                    </tr>
                </thead>
                <tbody id="scheduleBody">
                    <tr><td colspan="6" class="text-muted py-5">請選擇班級以檢視課表</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="../../js/config.js"></script>
<script>
    let currentSemester = null;
    let allPeriods = [];
    let teacherMap = {};

    document.addEventListener('DOMContentLoaded', async () => {
        // Robust semester fetch
        let { data: sem } = await window.db.from('semester_settings').select('*').eq('is_active_for_scheduling', true).maybeSingle();
        if(!sem) {
             const { data: latest } = await window.db.from('semester_settings').select('*').order('academic_year', {ascending:false}).limit(1).maybeSingle();
             sem = latest;
        }
        if(!sem) { Swal.fire('錯誤', '無學期資料', 'error'); return; }
        currentSemester = sem;

        // 載入班級選項
        const { data: classes } = await window.db.from('classes').select('*').order('grade_level').order('class_name');
        const sel = document.getElementById('targetSelect');
        classes.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.grade_level}年 ${c.class_name}</option>`);

        // 載入節次架構
        const { data: periods } = await window.db.from('period_settings').select('*').eq('academic_year', sem.academic_year).eq('semester', sem.semester).eq('is_class_period', true).order('sort_order');
        allPeriods = periods;

        // 載入老師名稱對照
        const { data: tea } = await window.db.from('employees').select('employee_id, name');
        if(tea) tea.forEach(t => teacherMap[t.employee_id] = t.name);
    });

    async function loadSchedule() {
        const classId = document.getElementById('targetSelect').value;
        if(!classId) return;

        // 繪製空表
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = '';
        allPeriods.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td class="bg-light fw-bold">${p.period_name}</td>
                    <td id="c-1-${p.sort_order}"></td>
                    <td id="c-2-${p.sort_order}"></td>
                    <td id="c-3-${p.sort_order}"></td>
                    <td id="c-4-${p.sort_order}"></td>
                    <td id="c-5-${p.sort_order}"></td>
                </tr>
            `;
        });

        // 讀取資料
        const { data: sch } = await window.db.from('course_schedules')
            .select('*, subjects(name)')
            .eq('academic_year', currentSemester.academic_year)
            .eq('semester', currentSemester.semester)
            .eq('class_id', classId);

        if(sch) {
            sch.forEach(s => {
                const cell = document.getElementById(`c-${s.weekday}-${s.period_order}`);
                if(cell) {
                    const tName = teacherMap[s.teacher_id] || s.teacher_id;
                    cell.innerHTML = `
                        <div class="cell-content">
                            <span class="sub-name">${s.subjects.name}</span>
                            <span class="tea-name">${tName}</span>
                        </div>
                    `;
                }
            });
        }
    }
</script>
</body>
</html>
