<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動排課</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; } .log-box { height: 400px; overflow-y: auto; background: #000; color: #0f0; font-family: monospace; padding: 15px; border-radius: 5px; }</style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary"><i class="bi bi-cpu"></i> 自動排課</h3>
        <a href="course_dashboard.html" class="btn btn-outline-secondary"><i class="bi bi-arrow-return-left"></i> 回儀表板</a>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body text-center py-5">
            <h5 class="mb-4">系統將依據「班級開課」與「教師配課」資料進行運算</h5>
            <div class="d-flex justify-content-center gap-3 align-items-center">
                <button id="startBtn" class="btn btn-lg btn-primary px-5 rounded-pill shadow" onclick="runAutoSchedule()">
                    <i class="bi bi-play-fill"></i> 開始自動排課
                </button>
            </div>
            <div id="statusText" class="mt-3 text-muted">準備就緒</div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white">運算日誌</div>
        <div class="card-body p-0">
            <div id="consoleLog" class="log-box"></div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    let currentSemester = null;
    let allPeriods = [];

    document.addEventListener('DOMContentLoaded', async () => {
        // Robust fetch
        let { data: sem } = await window.db.from('semester_settings').select('*').eq('is_active_for_scheduling', true).maybeSingle();
        if(!sem) {
             const { data: latest } = await window.db.from('semester_settings').select('*').order('academic_year', {ascending:false}).limit(1).maybeSingle();
             sem = latest;
        }
        if(!sem) { Swal.fire('錯誤', '無學期資料', 'error'); return; }
        currentSemester = sem;
        log(`讀取學期：${sem.academic_year}-${sem.semester}`);

        const { data: periods } = await window.db.from('period_settings').select('*').eq('academic_year', sem.academic_year).eq('semester', sem.semester).eq('is_class_period', true).order('sort_order');
        allPeriods = periods;
        log(`讀取排課節次：${periods.length} 節`);
    });

    function log(msg) {
        const box = document.getElementById('consoleLog');
        box.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
        box.scrollTop = box.scrollHeight;
    }

    async function runAutoSchedule() {
        const btn = document.getElementById('startBtn');
        const status = document.getElementById('statusText');
        
        if(!confirm('確定執行？舊課表將被清空！')) return;

        btn.disabled = true;
        status.textContent = "運算中...";
        document.getElementById('consoleLog').innerHTML = '';

        try {
            log("1. 清空舊課表...");
            await window.db.from('course_schedules').delete().eq('academic_year', currentSemester.academic_year).eq('semester', currentSemester.semester);
            
            log("2. 讀取配課資料...");
            const { data: assigns } = await window.db.from('teaching_assignments').select('*, subjects(name)').eq('academic_year', currentSemester.academic_year).eq('semester', currentSemester.semester);
            
            if(!assigns || !assigns.length) throw new Error("無配課資料");

            // 簡易排課邏輯 (之後會升級讀取 1,1,2)
            // 目前先用簡單迴圈填入
            let results = [];
            let occupied = {}; // key: day-period-class / day-period-teacher

            function check(d, p, c, t) {
                return occupied[`${d}-${p}-C${c}`] || occupied[`${d}-${p}-T${t}`];
            }
            function book(d, p, c, t) {
                occupied[`${d}-${p}-C${c}`] = true;
                occupied[`${d}-${p}-T${t}`] = true;
            }

            for(let task of assigns) {
                log(`排: 班級${task.class_id} ${task.subjects.name}`);
                let count = 0;
                for(let d=1; d<=5; d++) {
                    for(let p of allPeriods) {
                        if(count >= task.hours_per_week) break;
                        if(!check(d, p.sort_order, task.class_id, task.teacher_id)) {
                            book(d, p.sort_order, task.class_id, task.teacher_id);
                            results.push({
                                academic_year: currentSemester.academic_year,
                                semester: currentSemester.semester,
                                class_id: task.class_id,
                                subject_id: task.subject_id,
                                teacher_id: task.teacher_id,
                                weekday: d,
                                period_order: p.sort_order
                            });
                            count++;
                        }
                    }
                }
            }

            log("3. 寫入資料庫...");
            const chunkSize = 50;
            for (let i = 0; i < results.length; i += chunkSize) {
                await window.db.from('course_schedules').insert(results.slice(i, i + chunkSize));
            }
            
            status.textContent = "完成！正在跳轉...";
            log("排課完成！即將跳轉...");
            
            setTimeout(() => {
                window.location.href = 'schedule_view.html';
            }, 1000);

        } catch (err) {
            log(`錯誤: ${err.message}`);
            status.textContent = "錯誤";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
