<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師配課作業</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .table-input { border: none; background: transparent; width: 100%; text-align: center; }
        .table-input:focus { outline: 1px solid #86b7fe; background: white; }
        .teacher-select, .subject-select { border: 1px solid transparent; background: transparent; width: 100%; }
        .teacher-select:focus, .subject-select:focus { outline: 1px solid #86b7fe; background: white; border-color: #ced4da; }
        .homeroom-info { background-color: #e9ecef; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-success"><i class="bi bi-person-video3"></i> 教師配課作業</h3>
            <small class="text-muted">
                目前作業學期：<span id="activeSemText" class="fw-bold text-dark">載入中...</span>
            </small>
        </div>
        <div>
            <a href="course_dashboard.html" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-return-left"></i> 回儀表板
            </a>
            <button class="btn btn-primary" onclick="saveAssignments()">
                <i class="bi bi-save"></i> 儲存配課結果
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body d-flex align-items-center gap-3 flex-wrap">
            <div class="d-flex align-items-center">
                <label class="fw-bold text-nowrap me-2">選擇班級：</label>
                <select id="classSelect" class="form-select w-auto fw-bold" onchange="loadAssignments()">
                    <option value="">(請先選擇班級)</option>
                </select>
            </div>
            
            <div class="vr mx-2 d-none d-md-block"></div>
            
            <div class="homeroom-info">
                <i class="bi bi-info-circle-fill text-primary"></i> 
                本班導師：<span id="homeroomTeacher" class="text-dark fw-bold">-</span>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">課程與授課教師設定</h5>
            <div>
                <button class="btn btn-sm btn-warning text-dark me-2" onclick="autoAssignHomeroom()">
                    <i class="bi bi-magic"></i> 自動配給導師
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="addRow()">
                    <i class="bi bi-plus-lg"></i> 新增科目
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover table-bordered mb-0 align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th width="35%">科目名稱</th>
                        <th width="20%">每週節數</th>
                        <th width="35%">授課教師</th>
                        <th width="10%">操作</th>
                    </tr>
                </thead>
                <tbody id="assignTable">
                    <tr><td colspan="4" class="text-center py-5 text-muted">請選擇上方班級以開始配課</td></tr>
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td class="text-end fw-bold">合計節數：</td>
                        <td class="fw-bold text-primary" id="totalHours">0</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<script src="../../js/config.js"></script>
<script>
    // 全域變數
    let currentSemester = null;
    let subjectsMap = [];
    let teachersMap = [];
    let currentHomeroomId = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await initData();
    });

    async function initData() {
        console.log("正在初始化資料...");

        // A. 嘗試抓取「排課中」的學期
        let { data: sem, error } = await window.db.from('semester_settings')
            .select('*')
            .eq('is_active_for_scheduling', true)
            .single();

        // 如果找不到 active 的，嘗試抓最新的一筆當作備案 (Fallback)
        if (!sem || error) {
            console.warn("找不到排課學期，嘗試抓取最新學期...");
            const { data: latestSem } = await window.db.from('semester_settings')
                .select('*')
                .order('academic_year', { ascending: false })
                .order('semester', { ascending: true }) // 這裡假設 1 < 2
                .limit(1)
                .single();
            
            if (latestSem) {
                sem = latestSem;
                console.log("已自動切換為最新學期:", sem);
                // 提示使用者
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                });
                Toast.fire({ icon: 'info', title: '自動載入最新學期 (非設定值)' });
            }
        }

        // 如果還是沒有資料，那就真的無法運作了
        if (!sem) {
            Swal.fire({
                title: '無法載入學期',
                text: '系統找不到任何學期資料。請先至「基本設定」建立並設定一個學期。',
                icon: 'error',
                confirmButtonText: '前往設定'
            }).then((result) => {
                if(result.isConfirmed) window.location.href = 'course_settings.html';
            });
            return;
        }

        // 設定全域變數與 UI
        currentSemester = sem;
        
        let semName = sem.semester;
        if (sem.semester === '1') semName = '上學期';
        else if (sem.semester === '2') semName = '下學期';
        else if (sem.semester === 'W') semName = '寒輔';
        else if (sem.semester === 'S') semName = '暑輔';
        
        let sysName = sem.system_type === 'kindergarten' ? '幼兒' : 
                      (sem.system_type === 'elementary' ? '國小' : '國高中');

        document.getElementById('activeSemText').textContent = `${sem.academic_year} 學年 ${semName} (${sysName})`;

        // B. 抓班級列表
        const { data: classes } = await window.db.from('classes')
            .select('id, class_name, grade_level, homeroom_teacher_id')
            .order('grade_level')
            .order('class_name');
            
        const cSelect = document.getElementById('classSelect');
        window.allClasses = classes || []; 
        
        if (classes) {
            classes.forEach(c => {
                cSelect.innerHTML += `<option value="${c.id}">${c.grade_level}年 ${c.class_name}</option>`;
            });
        }

        // C. 抓科目
        const { data: subs } = await window.db.from('subjects').select('*').order('code');
        subjectsMap = subs || [];

        // D. 抓老師
        const { data: teachers } = await window.db.from('employees').select('employee_id, name').order('employee_id');
        teachersMap = teachers || [];
    }

    async function loadAssignments() {
        const classId = document.getElementById('classSelect').value;
        const tbody = document.getElementById('assignTable');
        const teacherSpan = document.getElementById('homeroomTeacher');
        
        tbody.innerHTML = '';
        document.getElementById('totalHours').textContent = '0';
        teacherSpan.textContent = '-';
        currentHomeroomId = null;

        if (!classId) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">請選擇上方班級以開始配課</td></tr>';
            return;
        }

        const cls = window.allClasses.find(c => c.id == classId);
        if (cls && cls.homeroom_teacher_id) {
            const t = teachersMap.find(tm => tm.employee_id === cls.homeroom_teacher_id);
            teacherSpan.textContent = t ? `${t.name} (${t.employee_id})` : '(無對應資料)';
            currentHomeroomId = cls.homeroom_teacher_id;
        }

        const { data: assigns, error } = await window.db.from('teaching_assignments')
            .select('*')
            .eq('academic_year', currentSemester.academic_year)
            .eq('semester', currentSemester.semester)
            .eq('class_id', classId)
            .order('id');

        if (assigns && assigns.length > 0) {
            assigns.forEach(a => addRow(a));
        } else {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">尚無配課資料，請按「新增科目」開始設定</td></tr>';
        }
        calculateTotal();
    }

    function addRow(data = null) {
        const tbody = document.getElementById('assignTable');
        if(tbody.querySelector('td[colspan]')) tbody.innerHTML = '';

        const tr = document.createElement('tr');
        tr.className = 'assign-row';

        let subOpts = '<option value="">(選擇科目)</option>';
        subjectsMap.forEach(s => {
            const selected = (data && data.subject_id === s.id) ? 'selected' : '';
            subOpts += `<option value="${s.id}" data-hours="${s.default_hours}" ${selected}>${s.name}</option>`;
        });

        let teaOpts = '<option value="">(未指定)</option>';
        teachersMap.forEach(t => {
            const selected = (data && data.teacher_id === t.employee_id) ? 'selected' : '';
            teaOpts += `<option value="${t.employee_id}" ${selected}>${t.name}</option>`;
        });

        tr.innerHTML = `
            <td>
                <select class="form-select subject-select fw-bold" onchange="autoFillHours(this)">${subOpts}</select>
            </td>
            <td>
                <input type="number" class="form-control table-input hours-input" value="${data ? data.hours_per_week : 0}" min="0" onchange="calculateTotal()">
            </td>
            <td>
                <select class="form-select teacher-select">${teaOpts}</select>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        if(!data) calculateTotal();
    }

    window.autoFillHours = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        const defaultHours = option.getAttribute('data-hours');
        if (defaultHours) {
            const row = selectEl.closest('tr');
            row.querySelector('.hours-input').value = defaultHours;
            calculateTotal();
        }
    }

    window.removeRow = (btn) => {
        btn.closest('tr').remove();
        calculateTotal();
    }

    window.calculateTotal = () => {
        let total = 0;
        document.querySelectorAll('.hours-input').forEach(inp => {
            total += parseInt(inp.value || 0);
        });
        document.getElementById('totalHours').textContent = total;
    }

    window.autoAssignHomeroom = () => {
        if (!currentHomeroomId) {
            Swal.fire('無法自動配課', '此班級尚未設定導師，無法執行自動配給。', 'warning');
            return;
        }
        const teacherSelects = document.querySelectorAll('.teacher-select');
        let count = 0;
        teacherSelects.forEach(sel => {
            if (sel.value === "") {
                sel.value = currentHomeroomId;
                count++;
            }
        });
        if (count > 0) {
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 1500
            });
            Toast.fire({ icon: 'success', title: `已自動為 ${count} 個科目指定導師` });
        } else {
            Swal.fire('提示', '目前沒有「未指定」的科目', 'info');
        }
    }

    async function saveAssignments() {
        const classId = document.getElementById('classSelect').value;
        if (!classId) { Swal.fire('提示', '請先選擇班級', 'warning'); return; }

        const rows = document.querySelectorAll('.assign-row');
        const payload = [];
        
        for (let row of rows) {
            const subId = row.querySelector('.subject-select').value;
            const teaId = row.querySelector('.teacher-select').value;
            const hours = row.querySelector('.hours-input').value;

            if (subId) {
                payload.push({
                    academic_year: currentSemester.academic_year,
                    semester: currentSemester.semester,
                    class_id: classId,
                    subject_id: subId,
                    teacher_id: teaId || null,
                    hours_per_week: hours || 0
                });
            }
        }

        try {
            const { data: oldData } = await window.db.from('teaching_assignments')
                .select('subject_id, period_distribution')
                .eq('academic_year', currentSemester.academic_year)
                .eq('semester', currentSemester.semester)
                .eq('class_id', classId);
                
            const distMap = {};
            if(oldData) oldData.forEach(d => distMap[d.subject_id] = d.period_distribution);

            await window.db.from('teaching_assignments').delete()
                .eq('academic_year', currentSemester.academic_year)
                .eq('semester', currentSemester.semester)
                .eq('class_id', classId);

            payload.forEach(p => {
                if (distMap[p.subject_id]) p.period_distribution = distMap[p.subject_id];
            });

            if (payload.length > 0) {
                const { error: insErr } = await window.db.from('teaching_assignments').insert(payload);
                if (insErr) throw insErr;
            }

            Swal.fire({
                icon: 'success', 
                title: '儲存成功', 
                text: `已更新 ${payload.length} 筆配課資料`,
                timer: 1500,
                showConfirmButton: false
            });

        } catch (err) {
            Swal.fire('儲存失敗', err.message, 'error');
        }
    }
</script>
</body>
</html>
