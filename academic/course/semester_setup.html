<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學期設定</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }</style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary"><i class="bi bi-calendar-check"></i> 學期設定</h3>
        <a href="course_dashboard.html" class="btn btn-outline-secondary"><i class="bi bi-arrow-return-left"></i> 回儀表板</a>
    </div>
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="alert alert-primary">
                <i class="bi bi-info-circle-fill"></i> 請選擇本系統目前要進行排課作業的學期。設定後，所有的開課資料將會綁定至該學期。
            </div>
            <table class="table table-hover align-middle">
                <thead class="table-light"><tr><th>學年度</th><th>學期</th><th>狀態</th><th>操作</th></tr></thead>
                <tbody id="semTable"></tbody>
            </table>
        </div>
    </div>
</div>
<script src="../../js/config.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', loadSemesters);
    async function loadSemesters() {
        const { data: list } = await window.db.from('semester_settings').select('*').order('academic_year', { ascending: false }).order('semester', { ascending: true });
        const tbody = document.getElementById('semTable'); tbody.innerHTML = '';
        const uniqueSem = new Map();
        list.forEach(sem => {
            const key = `${sem.academic_year}-${sem.semester}`;
            if (!uniqueSem.has(key)) uniqueSem.set(key, sem);
            if (sem.is_active_for_scheduling) uniqueSem.get(key).isActiveGlobal = true;
        });
        uniqueSem.forEach(sem => {
            let semName = sem.semester === '1' ? '上學期' : (sem.semester === '2' ? '下學期' : (sem.semester === 'W' ? '寒輔' : '暑輔'));
            const btnHtml = sem.isActiveGlobal 
                ? '<button class="btn btn-sm btn-outline-secondary" disabled>使用中</button>' 
                : `<button class="btn btn-sm btn-primary" onclick="setActive('${sem.academic_year}', '${sem.semester}')">設為排課學期</button>`;
            tbody.innerHTML += `<tr class="${sem.isActiveGlobal?'table-success':''}"><td>${sem.academic_year}</td><td>${semName}</td><td>${sem.isActiveGlobal?'<span class="badge bg-success">排課中</span>':''}</td><td>${btnHtml}</td></tr>`;
        });
    }
    async function setActive(y, s) {
        await window.db.from('semester_settings').update({ is_active_for_scheduling: false }).neq('id', 0);
        await window.db.from('semester_settings').update({ is_active_for_scheduling: true }).eq('academic_year', y).eq('semester', s);
        Swal.fire('成功', '已切換學期', 'success').then(loadSemesters);
    }
</script>
</body>
</html>
