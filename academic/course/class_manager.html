<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級資料維護</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }</style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-people-fill"></i> 班級資料維護</h3>
        <div>
            <button class="btn btn-success me-2" onclick="syncModule()">
                <i class="bi bi-arrow-repeat"></i> 同步開班模組
            </button>
            <a href="course_dashboard.html" class="btn btn-outline-secondary me-2">回儀表板</a>
            <button class="btn btn-primary" onclick="openModal()"><i class="bi bi-plus-lg"></i> 新增班級</button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>年級</th>
                        <th>班級名稱</th>
                        <th>班導師</th>
                        <th>教室</th>
                        <th class="text-end">操作</th>
                    </tr>
                </thead>
                <tbody id="clsTable"><tr><td colspan="5" class="text-center py-5">載入中...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="clsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">班級編輯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-3"><label>年級</label><input type="number" id="m_grade" class="form-control" placeholder="例: 7"></div>
                <div class="mb-3"><label>班級名稱</label><input type="text" id="m_name" class="form-control" placeholder="例: 701"></div>
                <div class="mb-3"><label>導師 (選填)</label><input type="text" id="m_teacher" class="form-control"></div>
                <div class="mb-3"><label>指定教室 (選填)</label><input type="text" id="m_room" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveData()">儲存</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../js/config.js"></script>
<script>
    let clsModal;
    document.addEventListener('DOMContentLoaded', () => {
        clsModal = new bootstrap.Modal(document.getElementById('clsModal'));
        if(window.db) loadClasses(); else setTimeout(loadClasses, 500);
    });

    async function loadClasses() {
        const { data, error } = await window.db.from('classes').select('*').order('grade').order('class_name');
        const tbody = document.getElementById('clsTable');
        tbody.innerHTML = '';
        if(error || !data) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5">無資料</td></tr>`; return; }

        data.forEach(c => {
            tbody.innerHTML += `
                <tr>
                    <td>${c.grade}</td>
                    <td class="fw-bold">${c.class_name}</td>
                    <td>${c.homeroom_teacher || '-'}</td>
                    <td>${c.classroom_id || '-'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick='openModal(${JSON.stringify(c)})'><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="delClass('${c.id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    // 同步功能 (暫時 alert)
    function syncModule() {
        Swal.fire('系統訊息', '此功能將連接「開班模組」進行資料同步 (開發中)', 'info');
    }

    window.openModal = (d) => {
        document.getElementById('editId').value = d?d.id:'';
        document.getElementById('m_grade').value = d?d.grade:'';
        document.getElementById('m_name').value = d?d.class_name:'';
        document.getElementById('m_teacher').value = d?d.homeroom_teacher:'';
        document.getElementById('m_room').value = d?d.classroom_id:'';
        clsModal.show();
    }
    window.saveData = async () => {
        const id = document.getElementById('editId').value;
        const payload = {
            grade: document.getElementById('m_grade').value,
            class_name: document.getElementById('m_name').value,
            homeroom_teacher: document.getElementById('m_teacher').value,
            classroom_id: document.getElementById('m_room').value
        };
        if(!payload.class_name) return Swal.fire('必填未填','','warning');
        
        let error;
        if(id) error = (await window.db.from('classes').update(payload).eq('id',id)).error;
        else error = (await window.db.from('classes').insert([payload])).error;
        
        if(error) Swal.fire('錯誤',error.message,'error');
        else { clsModal.hide(); loadClasses(); Swal.fire('成功','','success'); }
    }
    window.delClass = async (id) => {
        if(confirm('確定刪除？')) { await window.db.from('classes').delete().eq('id',id); loadClasses(); }
    }
</script>
</body>
</html>
