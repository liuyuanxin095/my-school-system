<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師排課設定</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .step-card { border-left: 5px solid #0d6efd; background: white; padding: 15px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .hour-input { width: 70px; text-align: center; border: 1px solid #ced4da; border-radius: 4px; padding: 4px; }
        .hour-input:focus { border-color: #0d6efd; outline: none; background-color: #f0f8ff; }
        /* 固定表頭 */
        .table-sticky th { position: sticky; top: 0; background-color: #e9ecef; z-index: 10; }
        .table-container { max-height: 600px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 5px; }
        .sum-cell { font-weight: bold; color: #0d6efd; }
        .floating-save { position: fixed; bottom: 30px; right: 30px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-people-fill"></i> 教師排課與時數設定</h3>
        <a href="../course_dashboard.html" class="btn btn-outline-secondary">回儀表板</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="step-card">
                <h6 class="fw-bold text-secondary">Step 1. 選擇學期</h6>
                <select id="semesterSelect" class="form-select form-select-lg" onchange="loadTeachers()">
                    <option value="114-1">114學年度 第1學期</option>
                    <option value="114-2">114學年度 第2學期</option>
                    <option value="115-1">115學年度 第1學期</option>
                </select>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="step-card border-success" style="border-left-color: #198754;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="fw-bold text-success">Step 2. 同步人資資料</h6>
                        <small class="text-muted">將從人資系統載入「具備排課身份」的教師。若該學期已有資料，則不會覆蓋原有時數設定。</small>
                    </div>
                    <button class="btn btn-success" onclick="syncFromHR()">
                        <i class="bi bi-arrow-repeat"></i> 執行同步
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="step-card border-warning" style="border-left-color: #ffc107;">
        <h6 class="fw-bold text-dark mb-3">Step 3. 設定時數 (直接修改數值)</h6>
        
        <div class="table-container">
            <table class="table table-hover align-middle mb-0 table-sticky">
                <thead class="text-center">
                    <tr>
                        <th width="100">代碼</th>
                        <th width="150">姓名</th>
                        <th>基本鐘點</th>
                        <th>輔導</th>
                        <th>代課</th>
                        <th>兼課</th>
                        <th>監考</th>
                        <th>其他</th>
                        <th width="80">合計</th>
                        <th width="80">操作</th>
                    </tr>
                </thead>
                <tbody id="teacherTable">
                    <tr><td colspan="10" class="text-center py-5 text-muted">請選擇學期並載入資料...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="mt-2 text-muted small">
            <i class="bi bi-info-circle"></i> 修改後請務必點擊右下角「儲存變更」按鈕。
        </div>
    </div>
</div>

<button class="btn btn-primary btn-lg rounded-pill px-4 floating-save" onclick="saveAll()">
    <i class="bi bi-save-fill"></i> 儲存變更
</button>

<script src="../../js/config.js"></script>
<script>
    let currentTeachers = [];

    document.addEventListener('DOMContentLoaded', () => {
        // 預設載入資料
        loadTeachers();
    });

    // 1. 載入該學期的教師列表
    async function loadTeachers() {
        const semester = document.getElementById('semesterSelect').value;
        const tbody = document.getElementById('teacherTable');
        
        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-5">載入中...</td></tr>';

        const { data, error } = await window.db.from('course_teachers')
            .select('*')
            .eq('semester_code', semester)
            .order('teacher_code'); // 依照代碼排序

        if (error) {
            Swal.fire('錯誤', '無法讀取資料', 'error');
            return;
        }

        currentTeachers = data || [];
        renderTable();
    }

    // 2. 渲染表格 (Excel 風格)
    function renderTable() {
        const tbody = document.getElementById('teacherTable');
        tbody.innerHTML = '';

        if (currentTeachers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-5 text-muted">本學期尚無教師資料，請按上方「執行同步」</td></tr>';
            return;
        }

        currentTeachers.forEach((t, index) => {
            const sum = (t.hours_basic||0) + (t.hours_counseling||0) + (t.hours_substitute||0) + 
                        (t.hours_part_time||0) + (t.hours_proctor||0) + (t.hours_other||0);

            // 生成輸入框 HTML
            const input = (field, val) => `
                <input type="number" class="hour-input" value="${val}" 
                    onchange="updateLocalData(${index}, '${field}', this.value)" onfocus="this.select()">
            `;

            tbody.innerHTML += `
                <tr>
                    <td class="text-center font-monospace fw-bold">${t.teacher_code || '-'}</td>
                    <td class="text-center fw-bold">${t.teacher_name}</td>
                    <td class="text-center">${input('hours_basic', t.hours_basic)}</td>
                    <td class="text-center">${input('hours_counseling', t.hours_counseling)}</td>
                    <td class="text-center">${input('hours_substitute', t.hours_substitute)}</td>
                    <td class="text-center">${input('hours_part_time', t.hours_part_time)}</td>
                    <td class="text-center">${input('hours_proctor', t.hours_proctor)}</td>
                    <td class="text-center">${input('hours_other', t.hours_other)}</td>
                    <td class="text-center sum-cell" id="sum-${index}">${sum}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeTeacher(${t.id})" title="從本學期移除">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    // 3. 本地資料更新 (當使用者修改格子時)
    window.updateLocalData = (index, field, value) => {
        const val = parseInt(value) || 0;
        currentTeachers[index][field] = val;
        
        // 即時計算合計
        const t = currentTeachers[index];
        const sum = (t.hours_basic||0) + (t.hours_counseling||0) + (t.hours_substitute||0) + 
                    (t.hours_part_time||0) + (t.hours_proctor||0) + (t.hours_other||0);
        document.getElementById(`sum-${index}`).textContent = sum;
    }

    // 4. 同步人資系統
    async function syncFromHR() {
        const semester = document.getElementById('semesterSelect').value;

        // A. 抓取人資系統中「具備排課身份」的員工
        const { data: hrData, error: hrError } = await window.db.from('employees')
            .select('id, name, teacher_code, is_scheduling')
            .eq('is_scheduling', true)
            .neq('status', 'resigned'); // 排除離職

        if (hrError) { Swal.fire('同步失敗', '讀取人資資料錯誤: ' + hrError.message, 'error'); return; }
        if (!hrData || hrData.length === 0) { Swal.fire('無資料', '人資系統中沒有設定「具備排課身份」的員工', 'warning'); return; }

        // B. 比對現有資料 (避免重複)
        // 建立現有 ID Set
        const existingIds = new Set(currentTeachers.map(t => t.employee_id));
        const newEntries = [];

        hrData.forEach(emp => {
            if (!existingIds.has(emp.id)) {
                newEntries.push({
                    semester_code: semester,
                    employee_id: emp.id,
                    teacher_name: emp.name,
                    teacher_code: emp.teacher_code || 'T' + emp.id // 若無代碼暫用 ID
                });
            }
        });

        if (newEntries.length === 0) {
            Swal.fire('同步完成', '目前資料已是最新，無新增人員。', 'info');
            return;
        }

        // C. 寫入新資料
        const { error: insError } = await window.db.from('course_teachers').insert(newEntries);
        
        if (insError) {
            Swal.fire('寫入失敗', insError.message, 'error');
        } else {
            Swal.fire('同步成功', `已新增 ${newEntries.length} 位教師至本學期`, 'success');
            loadTeachers();
        }
    }

    // 5. 批次儲存
    async function saveAll() {
        const btn = document.querySelector('.floating-save');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 儲存中...';
        btn.disabled = true;

        try {
            // 準備要更新的資料 (只取需要的欄位)
            const updates = currentTeachers.map(t => ({
                id: t.id,
                hours_basic: t.hours_basic,
                hours_counseling: t.hours_counseling,
                hours_substitute: t.hours_substitute,
                hours_part_time: t.hours_part_time,
                hours_proctor: t.hours_proctor,
                hours_other: t.hours_other,
                updated_at: new Date()
            }));

            const { error } = await window.db.from('course_teachers').upsert(updates);

            if (error) throw error;

            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, background: '#198754', color: '#fff'
            });
            Toast.fire({ icon: 'success', title: '設定已儲存' });

        } catch (err) {
            Swal.fire('儲存失敗', err.message, 'error');
        } finally {
            btn.innerHTML = '<i class="bi bi-save-fill"></i> 儲存變更';
            btn.disabled = false;
        }
    }

    // 6. 移除教師
    async function removeTeacher(id) {
        if (confirm('確定要從本學期清單中移除這位教師嗎？(不會刪除人資資料)')) {
            await window.db.from('course_teachers').delete().eq('id', id);
            loadTeachers();
        }
    }
</script>
</body>
</html>
