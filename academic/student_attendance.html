<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿè€ƒå‹¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #e9ecef; font-family: 'Microsoft JhengHei', sans-serif; height: 100vh; overflow: hidden; }
        
        /* å·¦å´æ§åˆ¶å€ */
        .control-panel { height: 100%; background: white; padding: 40px; display: flex; flex-direction: column; justify-content: center; border-right: 1px solid #dee2e6; }
        .clock-display { font-size: 3.5rem; font-weight: bold; color: #212529; font-family: monospace; letter-spacing: 2px; }
        .date-display { font-size: 1.2rem; color: #6c757d; margin-bottom: 30px; }
        
        /* å³å´é¡¯ç¤ºå€ */
        .display-panel { height: 100%; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; }
        
        /* å­¸ç”Ÿè³‡è¨Šå¡ */
        .student-card { 
            background: white; width: 80%; max-width: 600px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 40px; text-align: center;
            display: none; /* é è¨­éš±è—ï¼Œåˆ·å¡å¾Œé¡¯ç¤º */
            animation: popIn 0.3s ease-out;
        }
        
        .stu-photo { 
            width: 200px; height: 200px; border-radius: 50%; object-fit: cover; 
            border: 5px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .stu-name { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; }
        .stu-id { font-size: 1.5rem; color: #6c757d; font-family: monospace; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-box { 
            margin-top: 30px; padding: 15px; border-radius: 10px; 
            font-size: 2rem; font-weight: bold; color: white;
        }
        .status-in { background-color: #198754; box-shadow: 0 5px 15px rgba(25, 135, 84, 0.4); }
        .status-out { background-color: #ffc107; color: #000; box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4); }

        /* å¾…æ©Ÿç•«é¢ */
        .standby-msg { color: #adb5bd; text-align: center; }
        .standby-icon { font-size: 5rem; margin-bottom: 20px; }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container-fluid h-100">
    <div class="row h-100">
        <div class="col-md-5 control-panel shadow">
            <div class="text-center mb-5">
                <h2 class="fw-bold text-primary mb-4"><i class="bi bi-person-bounding-box"></i> å­¸ç”Ÿè€ƒå‹¤ç³»çµ±</h2>
                <div id="clock" class="clock-display">00:00:00</div>
                <div id="date" class="date-display">YYYY-MM-DD Week</div>
            </div>

            <div class="card bg-light border-0">
                <div class="card-body">
                    <label class="form-label fw-bold text-muted">è«‹è¼¸å…¥å­¸è™Ÿæˆ–æ„Ÿæ‡‰å¡ç‰‡ï¼š</label>
                    <input type="text" id="inputScan" class="form-control form-control-lg text-center fs-4" placeholder="ç­‰å¾…è¼¸å…¥..." autofocus autocomplete="off">
                    <div class="d-grid mt-3">
                        <button class="btn btn-primary btn-lg" onclick="processInput()">
                            <i class="bi bi-upc-scan"></i> æ‰‹å‹•é€å‡º
                        </button>
                    </div>
                    <div class="form-text text-center mt-2">æ”¯æ´ Barcode / QRCode / RFID è®€å¡æ©Ÿ</div>
                </div>
            </div>
            
            <div class="mt-auto">
                <h6 class="text-muted border-bottom pb-2">æœ€è¿‘ç´€éŒ„</h6>
                <ul id="logList" class="list-group list-group-flush small" style="max-height: 150px; overflow-y: auto;">
                    </ul>
            </div>
        </div>

        <div class="col-md-7 display-panel">
            
            <div id="standbyView" class="standby-msg">
                <i class="bi bi-card-checklist standby-icon"></i>
                <h1>è«‹åˆ·å¡æˆ–è¼¸å…¥å­¸è™Ÿ</h1>
                <p class="fs-4">ç³»çµ±å¾…å‘½ä¸­...</p>
            </div>

            <div id="resultCard" class="student-card">
                <img id="resPhoto" src="" class="stu-photo">
                <h2 id="resName" class="stu-name">---</h2>
                <div id="resId" class="stu-id">---</div>
                
                <div id="resStatus" class="status-box">---</div>
                <div id="resTime" class="mt-3 text-muted fs-5">åˆ·å¡æ™‚é–“ï¼š--:--:--</div>
            </div>

        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    let isProcessing = false; // é˜²æ­¢é€£åˆ·

    // 1. åˆå§‹åŒ–èˆ‡æ™‚é˜
    document.addEventListener('DOMContentLoaded', () => {
        updateTime();
        setInterval(updateTime, 1000);
        
        // ç›£è½ Enter éµ (åˆ·å¡æ©Ÿé€šå¸¸æœƒé€å‡º Enter)
        const input = document.getElementById('inputScan');
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') processInput();
        });

        // é»æ“Šä»»ä½•åœ°æ–¹éƒ½æŠŠç„¦é»é‚„çµ¦è¼¸å…¥æ¡† (Kiosk æ¨¡å¼)
        document.body.addEventListener('click', () => {
            document.getElementById('inputScan').focus();
        });
    });

    function updateTime() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false });
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('date').textContent = now.toLocaleDateString('zh-TW', options);
    }

    // 2. è™•ç†è¼¸å…¥ (æ ¸å¿ƒé‚è¼¯)
    async function processInput() {
        if (isProcessing) return;
        const inputEl = document.getElementById('inputScan');
        const val = inputEl.value.trim();

        if (!val) return;

        isProcessing = true;
        inputEl.disabled = true; // æš«æ™‚é–å®š

        try {
            // A. æœå°‹å­¸ç”Ÿ (å­¸è™Ÿ OR å¡è™Ÿ)
            const { data: students, error } = await window.db.from('students')
                .select('*')
                .or(`student_id.eq.${val},card_number.eq.${val}`);

            if (error) throw error;

            if (!students || students.length === 0) {
                // æ‰¾ä¸åˆ°å­¸ç”Ÿ
                showError('æŸ¥ç„¡æ­¤å­¸ç”Ÿè³‡æ–™');
            } else {
                const stu = students[0];
                await handleAttendance(stu, val);
            }

        } catch (err) {
            console.error(err);
            showError('ç³»çµ±éŒ¯èª¤');
        } finally {
            // é‡ç½®è¼¸å…¥æ¡†
            inputEl.value = '';
            inputEl.disabled = false;
            inputEl.focus();
            isProcessing = false;
        }
    }

    // 3. åˆ¤æ–·é€²å‡ºä¸¦å¯«å…¥ç´€éŒ„
    async function handleAttendance(stu, source) {
        // å…ˆæŸ¥è©²å­¸ç”Ÿã€Œä»Šå¤©ã€æœ€å¾Œä¸€ç­†ç´€éŒ„
        const todayStart = new Date();
        todayStart.setHours(0,0,0,0);
        
        const { data: logs } = await window.db.from('attendance_logs')
            .select('*')
            .eq('student_id', stu.id)
            .gte('check_time', todayStart.toISOString())
            .order('check_time', { ascending: false })
            .limit(1);

        // é‚è¼¯ï¼šå¦‚æœæ²’ç´€éŒ„ -> é€²æ ¡ (IN)
        //       å¦‚æœä¸Šä¸€ç­†æ˜¯ IN -> é›¢æ ¡ (OUT)
        //       å¦‚æœä¸Šä¸€ç­†æ˜¯ OUT -> é€²æ ¡ (IN)
        let type = 'IN';
        if (logs && logs.length > 0) {
            if (logs[0].check_type === 'IN') type = 'OUT';
        }

        // å¯«å…¥è³‡æ–™åº«
        const { error } = await window.db.from('attendance_logs').insert([{
            student_id: stu.id,
            check_type: type,
            input_source: source
        }]);

        if (error) throw error;

        // é¡¯ç¤ºçµæœ
        showResult(stu, type);
    }

    // 4. é¡¯ç¤ºçµæœ UI
    function showResult(stu, type) {
        // åˆ‡æ›é¡¯ç¤ºé¢æ¿
        document.getElementById('standbyView').style.display = 'none';
        const card = document.getElementById('resultCard');
        card.style.display = 'block';
        
        // é‡æ–°è§¸ç™¼å‹•ç•«
        card.style.animation = 'none';
        card.offsetHeight; /* trigger reflow */
        card.style.animation = 'popIn 0.3s ease-out';

        // å¡«å…¥è³‡æ–™
        document.getElementById('resName').textContent = stu.name_zh;
        document.getElementById('resId').textContent = stu.student_id;
        
        // ç…§ç‰‡ (å¦‚æœæ²’ç…§ç‰‡ç”¨é è¨­)
        const photoUrl = stu.photo_url || `https://ui-avatars.com/api/?name=${stu.name_zh}&size=200&background=random`;
        document.getElementById('resPhoto').src = photoUrl;

        // ç‹€æ…‹æ¨£å¼
        const statusBox = document.getElementById('resStatus');
        if (type === 'IN') {
            statusBox.textContent = "âœ… ä¸Šå­¸ / åˆ°æ ¡";
            statusBox.className = "status-box status-in";
        } else {
            statusBox.textContent = "ğŸ‘‹ æ”¾å­¸ / é›¢æ ¡";
            statusBox.className = "status-box status-out";
        }

        const nowTime = new Date().toLocaleTimeString();
        document.getElementById('resTime').textContent = `åˆ·å¡æ™‚é–“ï¼š${nowTime}`;

        // åŠ å…¥å·¦å´æ¸…å–®
        addLogItem(stu.name_zh, type, nowTime);
    }

    function showError(msg) {
        const Toast = Swal.mixin({
            toast: true, position: 'top', showConfirmButton: false, timer: 2000,
            background: '#dc3545', color: '#fff'
        });
        Toast.fire({ icon: 'error', title: msg });
        
        // ä¹Ÿå¯ä»¥æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ (é¸ç”¨)
        // new Audio('../assets/error.mp3').play();
    }

    function addLogItem(name, type, time) {
        const list = document.getElementById('logList');
        const badge = type === 'IN' ? '<span class="badge bg-success">åˆ°æ ¡</span>' : '<span class="badge bg-warning text-dark">é›¢æ ¡</span>';
        
        const item = document.createElement('li');
        item.className = "list-group-item d-flex justify-content-between align-items-center";
        item.innerHTML = `
            <div>${badge} <strong>${name}</strong></div>
            <span class="text-muted small">${time}</span>
        `;
        
        list.prepend(item); // åŠ åœ¨æœ€ä¸Šé¢
        if (list.children.length > 10) list.lastElementChild.remove(); // ä¿æŒåˆ—è¡¨é•·åº¦
    }
</script>
</body>
</html>
