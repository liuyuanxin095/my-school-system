<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編輯學生資料</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }</style>
</head>
<body>
<div class="container" style="max-width: 800px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">編輯學生資料</h3>
        <a href="student_list.html" class="btn btn-outline-secondary">返回列表</a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">基本資料</div>
        <div class="card-body">
            <input type="hidden" id="studentDbId">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">學號</label>
                    <input type="text" class="form-control" id="studentId" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-control" id="studentName">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">入學日期</label>
                    <input type="date" class="form-control" id="enrollDate">
                </div>
                <div class="col-md-6">
                    <label class="form-label">就讀年級</label>
                    <input type="text" class="form-control" id="grade" placeholder="例如：一年級">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">聯絡電話</label>
                <input type="text" class="form-control" id="phone">
            </div>
            <div class="mb-3">
                <label class="form-label">地址</label>
                <input type="text" class="form-control" id="address">
            </div>
            <div class="text-end">
                <button class="btn btn-primary" onclick="saveStudent()">儲存變更</button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-light fw-bold">歷年就讀班級紀錄</div>
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>學期</th>
                        <th>課程名稱</th>
                        <th>授課老師</th>
                        <th>狀態</th>
                    </tr>
                </thead>
                <tbody id="historyTable">
                    <tr><td colspan="4" class="text-center text-muted">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    // 取得 URL 參數中的 id
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    document.addEventListener('DOMContentLoaded', () => {
        if (!id) {
            Swal.fire('錯誤', '無效的學生 ID', 'error').then(() => window.location.href = 'student_list.html');
            return;
        }
        loadStudentData();
        loadClassHistory(); // 載入班級紀錄
    });

    async function loadStudentData() {
        const { data, error } = await window.db.from('students').select('*').eq('id', id).single();
        if (error) return console.error(error);
        
        document.getElementById('studentDbId').value = data.id;
        document.getElementById('studentId').value = data.student_id;
        document.getElementById('studentName').value = data.name;
        document.getElementById('enrollDate').value = data.enrollment_date;
        document.getElementById('grade').value = data.grade;
        document.getElementById('phone').value = data.phone;
        document.getElementById('address').value = data.address;
    }

    async function saveStudent() {
        const payload = {
            name: document.getElementById('studentName').value,
            enrollment_date: document.getElementById('enrollDate').value || null,
            grade: document.getElementById('grade').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value
        };

        const { error } = await window.db.from('students').update(payload).eq('id', id);
        if (error) Swal.fire('儲存失敗', error.message, 'error');
        else Swal.fire('成功', '學生資料已更新', 'success');
    }

    // ★★★ 載入該學生的班級歷史 ★★★
    async function loadClassHistory() {
        // 透過 student_classes 關聯表，並 Inner Join classes 表
        const { data, error } = await window.db
            .from('student_classes')
            .select(`
                created_at,
                classes (
                    semester,
                    course_name,
                    teacher_name,
                    status
                )
            `)
            .eq('student_id', id)
            // 這裡我們假設希望看到最新的班級在上面，可以用 classes 的 semester 或 id 排序
            // 但因為 Supabase 關聯排序限制，我們先抓回來再前端排序比較簡單
            ;

        const tbody = document.getElementById('historyTable');
        tbody.innerHTML = '';

        if (error) {
            console.error(error);
            tbody.innerHTML = '<tr><td colspan="4" class="text-danger">無法讀取班級紀錄</td></tr>';
            return;
        }

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">尚無參加任何班級</td></tr>';
            return;
        }

        // 前端排序：學期 (字串比較, 例如 "112-2" > "112-1")
        data.sort((a, b) => {
            const semA = a.classes?.semester || '';
            const semB = b.classes?.semester || '';
            return semB.localeCompare(semA); // 降序
        });

        data.forEach(item => {
            const cls = item.classes;
            if(!cls) return; // 防呆

            // 狀態標籤
            let statusBadge = '<span class="badge bg-success">進行中</span>';
            if(cls.status === 'closed') statusBadge = '<span class="badge bg-secondary">已結業</span>';

            tbody.innerHTML += `
                <tr>
                    <td><span class="fw-bold">${cls.semester}</span></td>
                    <td>${cls.course_name}</td>
                    <td>${cls.teacher_name || '-'}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        });
    }
</script>
</body>
</html>
