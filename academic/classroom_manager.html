<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教室與作息管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }</style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary"><i class="bi bi-building"></i> 教室與作息管理</h3>
        <a href="course_dashboard.html" class="btn btn-outline-secondary"><i class="bi bi-arrow-return-left"></i> 回儀表板</a>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-room">教室資料</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-period">節數作息</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-room">
            <div class="mb-3 text-end">
                <button class="btn btn-success btn-sm" onclick="importRooms()">Excel 匯入</button>
                <button class="btn btn-primary btn-sm" onclick="addRoom()">新增教室</button>
            </div>
            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>代碼</th><th>分校</th><th>名稱</th><th>類型</th><th>操作</th></tr></thead><tbody id="roomBody"></tbody></table>
        </div>
        <div class="tab-pane fade" id="tab-period">
            <div class="mb-3 d-flex justify-content-between">
                <span class="text-danger fw-bold" id="periodSemHint">正在讀取學期...</span>
                <div>
                    <button class="btn btn-warning btn-sm" onclick="initDefault()">預設值</button>
                    <button class="btn btn-success btn-sm" onclick="savePeriods()">儲存設定</button>
                </div>
            </div>
            <table class="table table-bordered text-center align-middle"><thead class="table-light"><tr><th>序</th><th>名稱</th><th>開始</th><th>結束</th><th>排課</th><th>刪</th></tr></thead><tbody id="periodBody"></tbody></table>
            <button class="btn btn-outline-primary btn-sm w-100" onclick="addP()">+ 新增</button>
        </div>
    </div>
</div>
<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let activeSem = null;
    document.addEventListener('DOMContentLoaded', async () => {
        loadRooms();
        // 抓學期
        const { data } = await window.db.from('semester_settings').select('*').eq('is_active_for_scheduling', true).maybeSingle();
        if(data) {
            activeSem = data;
            document.getElementById('periodSemHint').textContent = `針對學期：${data.academic_year}-${data.semester}`;
            document.getElementById('periodSemHint').className = 'text-primary fw-bold';
            loadPeriods();
        } else {
            document.getElementById('periodSemHint').textContent = '未設定排課學期，無法設定作息';
        }
    });

    // 教室邏輯
    async function loadRooms() {
        const { data } = await window.db.from('classrooms').select('*').order('full_code');
        const t = document.getElementById('roomBody'); t.innerHTML='';
        data.forEach(r => t.innerHTML += `<tr><td class="fw-bold">${r.full_code||''}</td><td>${r.campus}</td><td>${r.name}</td><td>${r.type==='special'?'專科':'一般'}</td><td><button class="btn btn-sm btn-outline-danger" onclick="delRoom(${r.id})"><i class="bi bi-trash"></i></button></td></tr>`);
    }
    async function addRoom() {
        // 簡易實作，完整版可參考上一個版本
        const { value: f } = await Swal.fire({
            title: '新增教室',
            html: `<select id="sw-c" class="form-select mb-2"><option value="A">A本部</option><option value="B">B文化</option></select><input id="sw-n" class="form-control mb-2" placeholder="號碼(101)"><input id="sw-nm" class="form-control" placeholder="名稱">`,
            preConfirm: () => ({ campus: document.getElementById('sw-c').value, code_num: document.getElementById('sw-n').value, name: document.getElementById('sw-nm').value })
        });
        if(f) {
            f.full_code = f.campus + f.code_num;
            await window.db.from('classrooms').insert([f]); loadRooms();
        }
    }
    async function delRoom(id) { if(confirm('刪除?')) { await window.db.from('classrooms').delete().eq('id',id); loadRooms(); } }
    
    // 作息邏輯
    async function loadPeriods() {
        if(!activeSem) return;
        const { data } = await window.db.from('period_settings').select('*').eq('academic_year', activeSem.academic_year).eq('semester', activeSem.semester).order('sort_order');
        const t = document.getElementById('periodBody'); t.innerHTML = '';
        if(data) data.forEach(renderP);
    }
    function renderP(d={}) {
        const i = document.getElementById('periodBody').children.length + 1;
        document.getElementById('periodBody').innerHTML += `<tr class="p-row"><td><input class="form-control form-control-sm text-center p-ord" value="${d.sort_order||i}"></td><td><input class="form-control form-control-sm p-name" value="${d.period_name||''}"></td><td><input type="time" class="form-control form-control-sm p-s" value="${d.start_time||''}"></td><td><input type="time" class="form-control form-control-sm p-e" value="${d.end_time||''}"></td><td><input type="checkbox" class="p-on" ${d.is_class_period?'checked':''}></td><td><button class="btn btn-sm text-danger" onclick="this.closest('tr').remove()">X</button></td></tr>`;
    }
    function addP() { renderP(); }
    function initDefault() { 
        document.getElementById('periodBody').innerHTML=''; 
        [{sort_order:1, period_name:'第一節', start_time:'08:10', end_time:'09:00', is_class_period:true},
         {sort_order:2, period_name:'第二節', start_time:'09:10', end_time:'10:00', is_class_period:true}].forEach(renderP);
    }
    async function savePeriods() {
        if(!activeSem) return;
        const rows = document.querySelectorAll('.p-row');
        const pl = [];
        rows.forEach(r => pl.push({
            academic_year: activeSem.academic_year, semester: activeSem.semester,
            sort_order: r.querySelector('.p-ord').value, period_name: r.querySelector('.p-name').value,
            start_time: r.querySelector('.p-s').value, end_time: r.querySelector('.p-e').value,
            is_class_period: r.querySelector('.p-on').checked
        }));
        await window.db.from('period_settings').delete().eq('academic_year', activeSem.academic_year).eq('semester', activeSem.semester);
        await window.db.from('period_settings').insert(pl);
        Swal.fire('成功', '已儲存', 'success');
    }
</script>
</body>
</html>
