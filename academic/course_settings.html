<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程基礎設定</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .nav-tabs .nav-link { color: #495057; font-weight: bold; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-top: 3px solid #0d6efd; }
        .tab-content { background: white; padding: 20px; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 5px 5px; }
        .action-btn { width: 32px; height: 32px; padding: 0; line-height: 32px; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-primary"><i class="bi bi-sliders"></i> 基本開課資料維護</h3>
            <small class="text-muted">設定學期、科目、教室與作息時間</small>
        </div>
        <a href="course_dashboard.html" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-return-left"></i> 回儀表板
        </a>
    </div>

    <ul class="nav nav-tabs" id="settingTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="sem-tab" data-bs-toggle="tab" data-bs-target="#pane-sem" type="button">學期連動設定</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="subj-tab" data-bs-toggle="tab" data-bs-target="#pane-subj" type="button">課程科目管理</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="room-tab" data-bs-toggle="tab" data-bs-target="#pane-room" type="button">教室資料管理</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="period-tab" data-bs-toggle="tab" data-bs-target="#pane-period" type="button">節數與作息</button>
        </li>
    </ul>

    <div class="tab-content shadow-sm">
        
        <div class="tab-pane fade show active" id="pane-sem">
            <div class="alert alert-info">
                <i class="bi bi-info-circle-fill"></i> 請選擇本系統目前要進行排課作業的學期。設定後，所有的開課資料將會綁定至該學期。
            </div>
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>學制</th>
                        <th>學年度</th>
                        <th>學期</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="semTable"></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="pane-subj">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold">全校科目列表</h5>
                <button class="btn btn-primary btn-sm" onclick="addSubject()">
                    <i class="bi bi-plus-lg"></i> 新增科目
                </button>
            </div>
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>代碼</th>
                        <th>科目名稱</th>
                        <th>領域/類別</th>
                        <th>預設節數</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="subjTable"></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="pane-room">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold">專科教室列表</h5>
                <button class="btn btn-primary btn-sm" onclick="addClassroom()">
                    <i class="bi bi-plus-lg"></i> 新增教室
                </button>
            </div>
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>教室名稱</th>
                        <th>類型</th>
                        <th>容納人數</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="roomTable"></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="pane-period">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold">每日作息時間表</h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="initDefaultPeriods()">
                        <i class="bi bi-arrow-repeat"></i> 載入預設值
                    </button>
                    <button class="btn btn-success btn-sm" onclick="savePeriods()">
                        <i class="bi bi-save"></i> 儲存作息設定
                    </button>
                </div>
            </div>
            <div class="alert alert-warning py-2 small">注意：請務必先在「學期連動設定」中選定學期，此處設定將套用於該學期。</div>
            <table class="table table-bordered text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th width="10%">排序</th>
                        <th width="25%">節次名稱</th>
                        <th width="25%">開始時間</th>
                        <th width="25%">結束時間</th>
                        <th width="15%">排課節次</th>
                        <th width="10%">刪除</th>
                    </tr>
                </thead>
                <tbody id="periodTable"></tbody>
            </table>
            <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="addPeriodRow()">
                <i class="bi bi-plus"></i> 增加一列
            </button>
        </div>

    </div>
</div>

<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 共用：取得目前的 Active 學期 ---
    let currentSemesterId = null;

    async function checkActiveSemester() {
        const { data } = await window.db.from('semester_settings')
            .select('*')
            .eq('is_active_for_scheduling', true)
            .single();
        
        if (data) {
            currentSemesterId = data.id;
            return data; // 回傳學期物件
        }
        return null;
    }

    // --- Tab 1: 學期連動設定 ---
    async function loadSemesters() {
        const { data: list } = await window.db.from('semester_settings')
            .select('*')
            .order('academic_year', { ascending: false })
            .order('semester', { ascending: true });
        
        const tbody = document.getElementById('semTable');
        tbody.innerHTML = '';

        list.forEach(sem => {
            let semName = sem.semester;
            if(semName === '1') semName = '上學期';
            else if(semName === '2') semName = '下學期';
            else if(semName === 'W') semName = '寒輔';
            else if(semName === 'S') semName = '暑輔';

            let typeName = sem.system_type;
            if(typeName === 'kindergarten') typeName = '幼兒園';
            if(typeName === 'elementary') typeName = '國小部';
            if(typeName === 'high_school') typeName = '國高中部';

            const isActive = sem.is_active_for_scheduling;
            const statusBadge = isActive 
                ? '<span class="badge bg-success">排課中</span>' 
                : '<span class="badge bg-secondary">非使用中</span>';
            
            const btnHtml = isActive 
                ? '<button class="btn btn-sm btn-outline-secondary" disabled>使用中</button>'
                : `<button class="btn btn-sm btn-primary" onclick="setActiveSem(${sem.id})">設為排課學期</button>`;

            tbody.innerHTML += `
                <tr class="${isActive ? 'table-success' : ''}">
                    <td>${typeName}</td>
                    <td>${sem.academic_year}</td>
                    <td>${semName}</td>
                    <td>${statusBadge}</td>
                    <td>${btnHtml}</td>
                </tr>
            `;
        });
    }

    async function setActiveSem(id) {
        // 呼叫資料庫函數 (Step 1 建立的)
        const { error } = await window.db.rpc('set_active_semester', { target_id: id });
        if(error) Swal.fire('錯誤', error.message, 'error');
        else {
            await Swal.fire('成功', '已切換排課學期', 'success');
            loadSemesters();
            // 切換學期後，重整節次表
            checkActiveSemester().then(data => {
                if(data) loadPeriods(data.academic_year, data.semester);
            });
        }
    }

    // --- Tab 2: 科目管理 ---
    async function loadSubjects() {
        const { data: list } = await window.db.from('subjects').select('*').order('code');
        const tbody = document.getElementById('subjTable');
        tbody.innerHTML = '';
        list.forEach(s => {
            tbody.innerHTML += `
                <tr>
                    <td>${s.code || '-'}</td>
                    <td class="fw-bold">${s.name}</td>
                    <td>${s.category || ''}</td>
                    <td>${s.default_hours}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger action-btn" onclick="delSubject(${s.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    async function addSubject() {
        const { value: formValues } = await Swal.fire({
            title: '新增科目',
            html: `
                <input id="swal-code" class="form-control mb-2" placeholder="科目代碼 (例: C01)">
                <input id="swal-name" class="form-control mb-2" placeholder="科目名稱 (例: 國語)">
                <input id="swal-cat" class="form-control mb-2" placeholder="領域/類別 (例: 語文)">
                <input id="swal-hours" type="number" class="form-control mb-2" placeholder="預設每週節數" value="4">
            `,
            focusConfirm: false,
            preConfirm: () => {
                return {
                    code: document.getElementById('swal-code').value,
                    name: document.getElementById('swal-name').value,
                    category: document.getElementById('swal-cat').value,
                    default_hours: document.getElementById('swal-hours').value
                }
            }
        });

        if (formValues) {
            await window.db.from('subjects').insert([formValues]);
            loadSubjects();
        }
    }

    async function delSubject(id) {
        if(confirm('確定刪除此科目？')) {
            await window.db.from('subjects').delete().eq('id', id);
            loadSubjects();
        }
    }

    // --- Tab 3: 教室管理 ---
    async function loadClassrooms() {
        const { data: list } = await window.db.from('classrooms').select('*').order('name');
        const tbody = document.getElementById('roomTable');
        tbody.innerHTML = '';
        list.forEach(r => {
            let typeName = r.type === 'special' ? '專科教室' : '一般教室';
            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold">${r.name}</td>
                    <td>${typeName}</td>
                    <td>${r.capacity || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger action-btn" onclick="delClassroom(${r.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    async function addClassroom() {
        const { value: formValues } = await Swal.fire({
            title: '新增教室',
            html: `
                <input id="swal-rname" class="form-control mb-2" placeholder="教室名稱 (例: 音樂教室)">
                <select id="swal-rtype" class="form-select mb-2">
                    <option value="special">專科教室</option>
                    <option value="general">一般教室</option>
                </select>
                <input id="swal-rcap" type="number" class="form-control mb-2" placeholder="容納人數" value="30">
            `,
            preConfirm: () => {
                return {
                    name: document.getElementById('swal-rname').value,
                    type: document.getElementById('swal-rtype').value,
                    capacity: document.getElementById('swal-rcap').value
                }
            }
        });

        if (formValues) {
            await window.db.from('classrooms').insert([formValues]);
            loadClassrooms();
        }
    }

    async function delClassroom(id) {
        if(confirm('確定刪除此教室？')) {
            await window.db.from('classrooms').delete().eq('id', id);
            loadClassrooms();
        }
    }

    // --- Tab 4: 節數與作息 ---
    // 這部分要跟「當前選中的學期」連動
    async function loadPeriods(year, sem) {
        // 先清空
        const tbody = document.getElementById('periodTable');
        tbody.innerHTML = '';

        if (!year || !sem) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-danger py-4">請先在「學期連動設定」選擇一個排課學期</td></tr>';
            return;
        }

        const { data: list } = await window.db.from('period_settings')
            .select('*')
            .eq('academic_year', year)
            .eq('semester', sem)
            .order('sort_order');

        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-muted py-4">目前無設定，請點選「載入預設值」</td></tr>';
            return;
        }

        list.forEach(p => {
            renderPeriodRow(p);
        });
    }

    function renderPeriodRow(data = {}) {
        const tbody = document.getElementById('periodTable');
        // 如果目前是空訊息，先清掉
        if(tbody.querySelector('td[colspan]')) tbody.innerHTML = '';

        const index = tbody.children.length + 1;
        const tr = document.createElement('tr');
        tr.className = 'period-row';
        tr.innerHTML = `
            <td><input type="number" class="form-control form-control-sm text-center p-order" value="${data.sort_order || index}"></td>
            <td><input type="text" class="form-control form-control-sm p-name" value="${data.period_name || ''}"></td>
            <td><input type="time" class="form-control form-control-sm p-start" value="${data.start_time || ''}"></td>
            <td><input type="time" class="form-control form-control-sm p-end" value="${data.end_time || ''}"></td>
            <td>
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input p-isclass" type="checkbox" ${data.is_class_period ? 'checked' : ''}>
                </div>
            </td>
            <td><button class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('tr').remove()"><i class="bi bi-x-lg"></i></button></td>
        `;
        tbody.appendChild(tr);
    }

    function addPeriodRow() {
        renderPeriodRow();
    }

    // 載入預設值
    function initDefaultPeriods() {
        if(!confirm('這將會清空目前表格並填入預設值，確定嗎？')) return;
        const defaults = [
            { sort_order: 1, period_name: '早自習', start_time: '07:50', end_time: '08:10', is_class_period: false },
            { sort_order: 2, period_name: '第一節', start_time: '08:15', end_time: '09:00', is_class_period: true },
            { sort_order: 3, period_name: '第二節', start_time: '09:10', end_time: '09:55', is_class_period: true },
            { sort_order: 4, period_name: '第三節', start_time: '10:10', end_time: '10:55', is_class_period: true },
            { sort_order: 5, period_name: '第四節', start_time: '11:05', end_time: '11:50', is_class_period: true },
            { sort_order: 6, period_name: '午休時間', start_time: '11:50', end_time: '13:00', is_class_period: false },
            { sort_order: 7, period_name: '第五節', start_time: '13:05', end_time: '13:50', is_class_period: true },
            { sort_order: 8, period_name: '第六節', start_time: '14:00', end_time: '14:45', is_class_period: true },
            { sort_order: 9, period_name: '第七節', start_time: '14:55', end_time: '15:40', is_class_period: true },
            { sort_order: 10, period_name: '打掃時間', start_time: '15:40', end_time: '16:00', is_class_period: false },
        ];
        document.getElementById('periodTable').innerHTML = '';
        defaults.forEach(d => renderPeriodRow(d));
    }

    async function savePeriods() {
        const activeSem = await checkActiveSemester();
        if(!activeSem) { Swal.fire('錯誤', '請先到「學期連動設定」選擇一個使用中的學期', 'error'); return; }

        const rows = document.querySelectorAll('.period-row');
        const periodData = [];
        
        rows.forEach(row => {
            periodData.push({
                academic_year: activeSem.academic_year,
                semester: activeSem.semester,
                sort_order: row.querySelector('.p-order').value,
                period_name: row.querySelector('.p-name').value,
                start_time: row.querySelector('.p-start').value,
                end_time: row.querySelector('.p-end').value,
                is_class_period: row.querySelector('.p-isclass').checked
            });
        });

        // 先刪除舊的 (該學期的)，再新增
        await window.db.from('period_settings')
            .delete()
            .eq('academic_year', activeSem.academic_year)
            .eq('semester', activeSem.semester);
        
        const { error } = await window.db.from('period_settings').insert(periodData);
        if(error) Swal.fire('儲存失敗', error.message, 'error');
        else Swal.fire('成功', '作息設定已更新', 'success');
    }

    // --- 初始化 ---
    document.addEventListener('DOMContentLoaded', () => {
        loadSemesters();
        loadSubjects();
        loadClassrooms();
        
        // 檢查是否有選中的學期，若有則載入作息
        checkActiveSemester().then(data => {
            if(data) loadPeriods(data.academic_year, data.semester);
        });
    });

</script>
</body>
</html>
