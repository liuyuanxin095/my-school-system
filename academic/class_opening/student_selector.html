<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>選取班級學生</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>body { background-color: #f8f9fa; padding: 20px; }</style>
</head>
<body>
    <div class="card shadow-sm h-100">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 text-primary fw-bold" id="titleDisplay">班級學生管理</h5>
            <div class="mt-2">
                <input type="text" class="form-control" id="search" placeholder="搜尋學生..." onkeyup="filter()">
            </div>
        </div>
        <div class="card-body p-0" style="height: 500px; overflow-y: auto;">
            <table class="table table-hover mb-0">
                <thead class="table-light sticky-top">
                    <tr><th class="text-center" width="60">選取</th><th>學號</th><th>姓名</th><th>年級</th></tr>
                </thead>
                <tbody id="listBody">
                    <tr><td colspan="4" class="text-center py-4"><div class="spinner-border text-secondary"></div></td></tr>
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <span class="fw-bold">已選取：<span id="count" class="text-primary">0</span> 人</span>
            <button class="btn btn-success" onclick="save()">儲存名單</button>
        </div>
    </div>

    <script src="../../js/config.js"></script>
    
    <script>
        const params = new URLSearchParams(location.search);
        const classId = params.get('class_id');
        const className = params.get('class_name');
        if(className) document.getElementById('titleDisplay').textContent = `管理學生：${className}`;

        let allStudents = [];
        let enrolledSet = new Set();

        window.onload = async () => {
            if(!classId) return Swal.fire('錯誤', '無班級ID', 'error');
            
            // 撈學生
            const { data: sData } = await window.db.from('students').select('*').order('student_id');
            allStudents = sData || [];
            
            // 撈已選
            const { data: eData } = await window.db.from('student_classes').select('student_id').eq('class_id', classId);
            if(eData) eData.forEach(e => enrolledSet.add(e.student_id));
            
            render();
        }

        function render() {
            const tbody = document.getElementById('listBody');
            tbody.innerHTML = '';
            const txt = document.getElementById('search').value.toLowerCase();
            
            let count = 0;
            allStudents.forEach(s => {
                if(txt && !s.name.includes(txt) && !s.student_id.includes(txt)) return;
                
                const isChecked = enrolledSet.has(s.id);
                if(isChecked) count++;
                
                tbody.innerHTML += `
                    <tr onclick="toggle(${s.id})" style="cursor:pointer" class="${isChecked?'table-success':''}">
                        <td class="text-center"><input type="checkbox" class="form-check-input" id="chk_${s.id}" ${isChecked?'checked':''}></td>
                        <td>${s.student_id}</td>
                        <td>${s.name}</td>
                        <td>${s.grade||'-'}</td>
                    </tr>
                `;
            });
            document.getElementById('count').textContent = count;
        }

        window.toggle = (id) => {
            // 如果點擊的是 checkbox 本身，不要再觸發一次
            if(event.target.type !== 'checkbox') {
                const chk = document.getElementById('chk_'+id);
                chk.checked = !chk.checked;
            }
            const chk = document.getElementById('chk_'+id);
            if(chk.checked) enrolledSet.add(id); else enrolledSet.delete(id);
            render();
        }

        window.filter = () => render();

        window.save = async () => {
            Swal.fire({title:'儲存中...', didOpen:()=>Swal.showLoading()});
            try {
                // 先刪除舊的
                await window.db.from('student_classes').delete().eq('class_id', classId);
                // 插入新的
                const inserts = Array.from(enrolledSet).map(sid => ({ class_id: classId, student_id: sid }));
                if(inserts.length > 0) await window.db.from('student_classes').insert(inserts);
                
                await Swal.fire('成功', '名單已更新', 'success');
                if(window.opener) window.opener.loadClasses(); // 重新整理父視窗
                window.close();
            } catch(e) { Swal.fire('錯誤', e.message, 'error'); }
        }
    </script>
</body>
</html>
