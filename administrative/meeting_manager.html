<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會議記錄與通知</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }</style>
</head>
<body>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-calendar-event-fill"></i> 會議記錄與通知</h3>
        <button class="btn btn-primary" onclick="openMeetingModal()"><i class="bi bi-plus-lg"></i> 新增會議記錄</button>
    </div>
    <div class="card shadow-sm border-0"><div class="card-body"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>日期</th><th>類別</th><th>名稱</th><th>地點</th><th>主席</th><th>操作</th></tr></thead><tbody id="meetingTable"></tbody></table></div></div>
</div>

<div class="modal fade" id="meetingModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">會議資料</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
    <input type="hidden" id="meetingId">
    <div class="row g-3 mb-3">
        <div class="col-md-3"><label>類別</label><select class="form-select" id="categoryId"></select></div>
        <div class="col-md-5"><label>名稱 *</label><input type="text" class="form-control" id="meetingName"></div>
        <div class="col-md-2"><label>時間</label><input type="datetime-local" class="form-control" id="meetingTime"></div>
        <div class="col-md-2"><label>地點</label><input type="text" class="form-control" id="meetingLocation"></div>
    </div>
    <div class="mb-3"><label>主席</label><input type="text" class="form-control" id="chairPerson" placeholder="請輸入主席姓名"></div>
    <div class="row g-3"><div class="col-md-6"><label>議程</label><textarea class="form-control" id="agenda" rows="5"></textarea></div><div class="col-md-6"><label>記錄</label><textarea class="form-control" id="minutes" rows="5"></textarea></div></div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="saveMeeting()">儲存</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="../js/config.js"></script>

<script>
    if (typeof window.db === 'undefined') { Swal.fire('錯誤', '找不到 js/config.js', 'error'); }

    const meetingModal = new bootstrap.Modal(document.getElementById('meetingModal'));
    
    document.addEventListener('DOMContentLoaded', () => { 
        loadMeetings(); 
        loadCategories(); 
    });

    async function loadCategories() {
        if (!window.db) return;
        const { data } = await window.db.from('meeting_categories').select('*');
        if(data) {
            const sel = document.getElementById('categoryId');
            sel.innerHTML = '<option value="">請選擇</option>';
            data.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }
    }

    async function loadMeetings() {
        if (!window.db) return;
        const { data, error } = await window.db.from('meetings').select('*, meeting_categories(name)').order('meeting_time', { ascending: false });
        if(error) return console.error(error);
        
        const tbody = document.getElementById('meetingTable');
        tbody.innerHTML = '';
        if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">無資料</td></tr>'; return;}
        
        data.forEach(m => {
            const timeStr = m.meeting_time ? new Date(m.meeting_time).toLocaleString() : '';
            tbody.innerHTML += `<tr><td>${timeStr}</td><td>${m.meeting_categories?.name||'-'}</td><td class="fw-bold">${m.name}</td><td>${m.location||''}</td><td>${m.chair_person||''}</td><td><button class="btn btn-sm btn-primary">詳情</button></td></tr>`;
        });
    }

    window.openMeetingModal = () => { 
        document.getElementById('meetingId').value=''; 
        document.getElementById('meetingName').value=''; 
        meetingModal.show(); 
    }
    
    window.saveMeeting = async () => {
        const payload = {
            category_id: document.getElementById('categoryId').value || null,
            name: document.getElementById('meetingName').value,
            meeting_time: document.getElementById('meetingTime').value || null,
            location: document.getElementById('meetingLocation').value,
            chair_person: document.getElementById('chairPerson').value,
            agenda: document.getElementById('agenda').value,
            minutes: document.getElementById('minutes').value
        };
        if(!payload.name) return Swal.fire('錯誤', '請輸入會議名稱', 'error');

        const { error } = await window.db.from('meetings').insert([payload]);
        if (error) Swal.fire('儲存失敗', error.message, 'error'); 
        else { meetingModal.hide(); loadMeetings(); Swal.fire('成功', '已儲存', 'success'); }
    }
</script>
</body>
</html>
