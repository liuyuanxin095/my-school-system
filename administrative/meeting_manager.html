<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會議記錄與通知</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .user-tag { background-color: #e9ecef; border-radius: 15px; padding: 2px 10px; margin-right: 5px; display: inline-block; font-size: 0.9rem; margin-bottom: 5px; }
        .user-tag i { cursor: pointer; margin-left: 5px; color: #dc3545; }
        .readonly-field { background-color: #fff !important; cursor: pointer; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-calendar-event-fill"></i> 會議記錄與通知</h3>
        <button class="btn btn-primary" onclick="openMeetingModal()"><i class="bi bi-plus-lg"></i> 新增會議記錄</button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>日期</th>
                        <th>會議類別</th>
                        <th>會議名稱</th>
                        <th>地點</th>
                        <th>主席</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="meetingTable"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="meetingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">會議資料維護</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="meetingId">
                
                <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">基本資訊</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label">會議類別</label>
                        <select class="form-select" id="categoryId"></select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">會議名稱</label>
                        <input type="text" class="form-control" id="meetingName" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">會議時間</label>
                        <input type="datetime-local" class="form-control" id="meetingTime">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">會議地點</label>
                        <input type="text" class="form-control" id="meetingLocation">
                    </div>
                </div>

                <h6 class="text-primary fw-bold mb-3 border-bottom pb-2 mt-4">人員設定</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">主席 (單選)</label>
                        <div class="input-group" onclick="openUserSelector('chair')">
                            <input type="text" class="form-control readonly-field" id="chairDisplay" placeholder="點擊選擇..." readonly>
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                        </div>
                        <input type="hidden" id="chairData"> </div>
                    <div class="col-md-6">
                        <label class="form-label">記錄者 (單選)</label>
                        <div class="input-group" onclick="openUserSelector('recorder')">
                            <input type="text" class="form-control readonly-field" id="recorderDisplay" placeholder="點擊選擇..." readonly>
                            <span class="input-group-text"><i class="bi bi-pencil"></i></span>
                        </div>
                        <input type="hidden" id="recorderData">
                    </div>
                    <div class="col-12">
                        <label class="form-label">與會人員 (多選)</label>
                        <div class="form-control readonly-field" style="min-height: 38px;" id="attendeesDisplay" onclick="openUserSelector('attendees')">
                            <span class="text-muted small">點擊選擇與會人員...</span>
                        </div>
                        <input type="hidden" id="attendeesData"> </div>
                    <div class="col-12">
                        <label class="form-label">列席人員 (手動輸入或選取)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="observersInput" placeholder="請輸入姓名，多位請用逗號隔開">
                            <button class="btn btn-outline-secondary" type="button" onclick="openUserSelector('observers')">從名單選取加入</button>
                        </div>
                    </div>
                </div>

                <h6 class="text-primary fw-bold mb-3 border-bottom pb-2 mt-4">會議內容</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">會議議程</label>
                        <textarea class="form-control" id="agenda" rows="6"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">會議記錄</label>
                        <textarea class="form-control" id="minutes" rows="6"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span class="text-muted me-auto small">* 簽核功能將於表單系統上線後整合</span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" onclick="saveMeeting()">儲存會議記錄</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="userSelectorModal" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">選擇人員</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-3" id="userSearch" placeholder="搜尋姓名..." onkeyup="filterUsers()">
                <div class="list-group" id="userListGroup">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmUserSelection()">確定選擇</button>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    let currentSelectorType = ''; // 'chair', 'recorder', 'attendees', 'observers'
    let allUsers = []; // 快取使用者資料
    const meetingModal = new bootstrap.Modal(document.getElementById('meetingModal'));
    const userModal = new bootstrap.Modal(document.getElementById('userSelectorModal'));

    document.addEventListener('DOMContentLoaded', async () => {
        loadMeetings();
        loadCategories();
        // 預先載入使用者資料
        const { data } = await window.db.from('system_users').select('id, name, ref_id');
        allUsers = data || [];
    });

    // --- 載入資料函式 ---
    async function loadCategories() {
        const { data } = await window.db.from('meeting_categories').select('*');
        const select = document.getElementById('categoryId');
        select.innerHTML = '<option value="">請選擇類別...</option>';
        data.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    }

    async function loadMeetings() {
        const { data } = await window.db
            .from('meetings')
            .select(`*, meeting_categories(name)`)
            .order('meeting_time', { ascending: false });
        
        const tbody = document.getElementById('meetingTable');
        tbody.innerHTML = '';
        
        if(data) {
            data.forEach(m => {
                const chairName = m.chair_person ? m.chair_person.name : '-';
                const timeStr = m.meeting_time ? new Date(m.meeting_time).toLocaleString() : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${timeStr}</td>
                        <td><span class="badge bg-secondary">${m.meeting_categories?.name || '未分類'}</span></td>
                        <td class="fw-bold">${m.name}</td>
                        <td>${m.location || ''}</td>
                        <td>${chairName}</td>
                        <td>${m.approval_status === 'draft' ? '草稿' : '已簽核'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editMeeting(${m.id})">編輯</button>
                        </td>
                    </tr>
                `;
            });
        }
    }

    // --- 編輯/新增邏輯 ---
    window.openMeetingModal = () => {
        document.getElementById('meetingId').value = '';
        // 清空欄位
        document.getElementById('meetingName').value = '';
        document.getElementById('meetingLocation').value = '';
        document.getElementById('agenda').value = '';
        document.getElementById('minutes').value = '';
        // 清空人員資料
        setSingleUser('chair', null);
        setSingleUser('recorder', null);
        setMultiUser('attendees', []);
        document.getElementById('observersInput').value = '';
        
        meetingModal.show();
    }

    window.editMeeting = async (id) => {
        const { data } = await window.db.from('meetings').select('*').eq('id', id).single();
        if(data) {
            document.getElementById('meetingId').value = data.id;
            document.getElementById('categoryId').value = data.category_id;
            document.getElementById('meetingName').value = data.name;
            document.getElementById('meetingTime').value = data.meeting_time ? data.meeting_time.slice(0, 16) : '';
            document.getElementById('meetingLocation').value = data.location;
            
            setSingleUser('chair', data.chair_person);
            setSingleUser('recorder', data.recorder);
            setMultiUser('attendees', data.attendees || []);
            document.getElementById('observersInput').value = data.observers || '';
            
            document.getElementById('agenda').value = data.agenda;
            document.getElementById('minutes').value = data.minutes;
            
            meetingModal.show();
        }
    }

    window.saveMeeting = async () => {
        const id = document.getElementById('meetingId').value;
        const payload = {
            category_id: document.getElementById('categoryId').value || null,
            name: document.getElementById('meetingName').value,
            meeting_time: document.getElementById('meetingTime').value || null,
            location: document.getElementById('meetingLocation').value,
            chair_person: getJsonData('chairData'),
            recorder: getJsonData('recorderData'),
            attendees: getJsonData('attendeesData'),
            observers: document.getElementById('observersInput').value,
            agenda: document.getElementById('agenda').value,
            minutes: document.getElementById('minutes').value
        };

        if(!payload.name) return Swal.fire('請輸入會議名稱');

        if(id) {
            await window.db.from('meetings').update(payload).eq('id', id);
        } else {
            await window.db.from('meetings').insert([payload]);
        }
        meetingModal.hide();
        loadMeetings();
        Swal.fire('已儲存');
    }

    function getJsonData(elementId) {
        const val = document.getElementById(elementId).value;
        return val ? JSON.parse(val) : null;
    }

    // --- 人員選擇器邏輯 (核心) ---
    window.openUserSelector = (type) => {
        currentSelectorType = type;
        const listGroup = document.getElementById('userListGroup');
        listGroup.innerHTML = '';

        // 判斷是否為多選
        const isMulti = (type === 'attendees' || type === 'observers');
        const inputType = isMulti ? 'checkbox' : 'radio';

        // 渲染列表
        allUsers.forEach(u => {
            listGroup.innerHTML += `
                <label class="list-group-item">
                    <input class="form-check-input me-2 user-check" type="${inputType}" name="userSelect" value="${u.id}" data-name="${u.name}">
                    ${u.name} <small class="text-muted">(${u.ref_id || '無編號'})</small>
                </label>
            `;
        });
        
        // 如果是編輯，嘗試勾選已選項目 (這裡簡化處理，若需完美回填需比對ID)
        userModal.show();
    }

    window.filterUsers = () => {
        const term = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('#userListGroup label').forEach(el => {
            const text = el.textContent.toLowerCase();
            el.style.display = text.includes(term) ? '' : 'none';
        });
    }

    window.confirmUserSelection = () => {
        const checked = document.querySelectorAll('.user-check:checked');
        const selected = Array.from(checked).map(c => ({
            id: c.value, 
            name: c.getAttribute('data-name')
        }));

        if (currentSelectorType === 'chair') {
            setSingleUser('chair', selected[0] || null);
        } else if (currentSelectorType === 'recorder') {
            setSingleUser('recorder', selected[0] || null);
        } else if (currentSelectorType === 'attendees') {
            // 與會人員：追加或覆蓋？目前邏輯是覆蓋，若要追加需讀取舊資料
            // 這裡做簡單的：將這次選的加入顯示
            // 為了完整性，我們先讀取舊的
            const oldData = getJsonData('attendeesData') || [];
            // 合併並去重
            const newData = [...oldData, ...selected].filter((v,i,a)=>a.findIndex(t=>(t.id===v.id))===i);
            setMultiUser('attendees', newData);
        } else if (currentSelectorType === 'observers') {
            // 列席人員：直接把名字串接進 input
            const input = document.getElementById('observersInput');
            const newNames = selected.map(s => s.name).join(', ');
            input.value = input.value ? (input.value + ', ' + newNames) : newNames;
        }

        userModal.hide();
    }

    // --- UI 顯示 helpers ---
    function setSingleUser(type, userObj) {
        if(userObj) {
            document.getElementById(`${type}Display`).value = userObj.name;
            document.getElementById(`${type}Data`).value = JSON.stringify(userObj);
        } else {
            document.getElementById(`${type}Display`).value = '';
            document.getElementById(`${type}Data`).value = '';
        }
    }

    function setMultiUser(type, userArray) {
        const displayDiv = document.getElementById(`${type}Display`);
        const hiddenInput = document.getElementById(`${type}Data`);
        
        hiddenInput.value = JSON.stringify(userArray);
        displayDiv.innerHTML = '';
        
        if (userArray.length === 0) {
            displayDiv.innerHTML = '<span class="text-muted small">點擊選擇...</span>';
            return;
        }

        userArray.forEach((u, index) => {
            // 這裡可以做一個 "X" 按鈕來移除陣列中的人
            displayDiv.innerHTML += `
                <span class="user-tag">
                    ${u.name} 
                    <i class="bi bi-x-circle-fill" onclick="removeMultiUser('${type}', ${index}); event.stopPropagation();"></i>
                </span>
            `;
        });
    }

    window.removeMultiUser = (type, index) => {
        const hiddenInput = document.getElementById(`${type}Data`);
        const list = JSON.parse(hiddenInput.value);
        list.splice(index, 1);
        setMultiUser(type, list);
    }
</script>
</body>
</html>
