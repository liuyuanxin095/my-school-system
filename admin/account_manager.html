<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .role-badge { width: 100px; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-shield-lock-fill"></i> 帳號管理</h3>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="syncEmployees()">
                <i class="bi bi-arrow-repeat"></i> 同步教職員帳號
            </button>
            <button class="btn btn-success" onclick="syncStudents()">
                <i class="bi bi-people-fill"></i> 同步學生帳號
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="d-flex mb-3 gap-2">
                <input type="text" id="searchInput" class="form-control w-auto" placeholder="搜尋帳號或姓名..." onkeyup="filterAccounts()">
                <select id="roleFilter" class="form-select w-auto" onchange="filterAccounts()">
                    <option value="">所有身分</option>
                    <option value="student">學生</option>
                    <option value="teacher">教師</option>
                    <option value="staff">職員</option>
                    <option value="admin">管理員</option>
                </select>
            </div>

            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>帳號</th>
                        <th>姓名</th>
                        <th>身分 (Role)</th>
                        <th>密碼權限</th>
                        <th class="text-end">操作</th>
                    </tr>
                </thead>
                <tbody id="accTable">
                    <tr><td colspan="5" class="text-center py-5">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    let allAccounts = [];

    document.addEventListener('DOMContentLoaded', loadAccounts);

    // 1. 載入帳號列表
    async function loadAccounts() {
        const { data, error } = await window.db.from('app_accounts').select('*').order('username');
        if (error) { console.error(error); return; }
        allAccounts = data || [];
        filterAccounts();
    }

    // 2. 渲染與篩選
    function filterAccounts() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const role = document.getElementById('roleFilter').value;
        const tbody = document.getElementById('accTable');
        tbody.innerHTML = '';

        const filtered = allAccounts.filter(acc => {
            const matchKey = (acc.username + acc.name).toLowerCase().includes(key);
            const matchRole = role ? acc.role === role : true;
            return matchKey && matchRole;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">無符合資料</td></tr>';
            return;
        }

        filtered.forEach(acc => {
            let roleColor = 'bg-secondary';
            if (acc.role === 'admin') roleColor = 'bg-danger';
            if (acc.role === 'teacher') roleColor = 'bg-success';
            if (acc.role === 'student') roleColor = 'bg-info text-dark';

            let pwdStatus = acc.can_change_password 
                ? '<span class="text-success"><i class="bi bi-check-circle"></i> 可修改</span>' 
                : '<span class="text-muted"><i class="bi bi-lock-fill"></i> 不可修改 (永不過期)</span>';

            // 學生不能有權限設定按鈕，其他人有
            let actionBtn = '';
            if (!acc.is_student) {
                actionBtn = `<button class="btn btn-sm btn-outline-dark" onclick="editPermission('${acc.username}', '${acc.role}')"><i class="bi bi-gear"></i> 權限設定</button>`;
            } else {
                actionBtn = `<span class="text-muted small">學生帳號自動管理</span>`;
            }

            tbody.innerHTML += `
                <tr>
                    <td class="font-monospace fw-bold">${acc.username}</td>
                    <td>${acc.name || '-'}</td>
                    <td><span class="badge ${roleColor} role-badge">${acc.role}</span></td>
                    <td>${pwdStatus}</td>
                    <td class="text-end">${actionBtn}</td>
                </tr>
            `;
        });
    }

    // 3. 同步學生帳號
    async function syncStudents() {
        // 先詢問
        const confirm = await Swal.fire({
            title: '確定同步學生帳號？',
            text: "這將為所有「學籍資料」中的學生建立登入帳號。\n預設帳號：學號\n預設密碼：身分證字號",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '開始同步'
        });

        if (!confirm.isConfirmed) return;

        Swal.fire({ title: '同步中...', didOpen: () => Swal.showLoading() });

        // A. 抓取所有學生資料
        const { data: students } = await window.db.from('students').select('id, student_id, id_number, name_zh');
        
        if (!students || students.length === 0) {
            Swal.fire('無資料', '目前沒有學生學籍資料可同步', 'info');
            return;
        }

        // B. 準備寫入 payload
        const accounts = students.map(s => {
            if (!s.student_id || !s.id_number) return null; // 略過資料不全的
            return {
                username: s.student_id,
                password: s.id_number, // 實務上建議加密，此處依需求存明碼或簡單處理
                role: 'student',
                name: s.name_zh,
                ref_id: s.id,
                is_student: true,
                can_change_password: false // 學生不可改密碼
            };
        }).filter(x => x); // 過濾掉 null

        // C. 寫入 (Upsert: 如果帳號存在就更新，不存在就新增)
        const { error } = await window.db.from('app_accounts').upsert(accounts, { onConflict: 'username' });

        if (error) {
            Swal.fire('同步失敗', error.message, 'error');
        } else {
            Swal.fire('同步完成', `已處理 ${accounts.length} 筆學生帳號`, 'success');
            loadAccounts();
        }
    }

    // 4. 同步教職員帳號 (輔助功能)
    async function syncEmployees() {
        const { data: emps } = await window.db.from('employees').select('id, employee_id, name, role');
        if (!emps) return;

        const accounts = emps.map(e => ({
            username: e.employee_id,
            password: '000', // 教職員預設密碼，可自行更改規則
            role: e.role || 'staff',
            name: e.name,
            ref_id: e.id,
            is_student: false,
            can_change_password: true
        }));

        await window.db.from('app_accounts').upsert(accounts, { onConflict: 'username' });
        Swal.fire('成功', '教職員帳號已同步 (預設密碼: 000)', 'success');
        loadAccounts();
    }

    // 5. 獨立設定帳號權限 (針對非學生)
    async function editPermission(username, currentRole) {
        const { value: newRole } = await Swal.fire({
            title: `設定帳號 ${username} 的權限`,
            input: 'select',
            inputOptions: {
                'admin': '系統管理員',
                'teacher': '教師',
                'staff': '職員'
            },
            inputValue: currentRole,
            showCancelButton: true
        });

        if (newRole) {
            await window.db.from('app_accounts').update({ role: newRole }).eq('username', username);
            Swal.fire('已更新', '權限已變更', 'success');
            loadAccounts();
        }
    }
</script>
</body>
</html>
