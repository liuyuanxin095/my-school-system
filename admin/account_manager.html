<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .role-badge { width: 100px; }
        .btn-sync-emp { background-color: #0d6efd; color: white; border: none; }
        .btn-sync-emp:hover { background-color: #0b5ed7; }
        .btn-sync-stu { background-color: #198754; color: white; border: none; }
        .btn-sync-stu:hover { background-color: #157347; }
        .status-suspended { text-decoration: line-through; color: #adb5bd; }
        .action-btn-group .btn { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
        .sync-info { font-size: 0.75rem; color: #6c757d; margin-top: 5px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-shield-lock-fill"></i> 帳號管理</h3>
        <div>
            <button class="btn btn-dark me-2 shadow-sm" onclick="openManualAdd()">
                <i class="bi bi-person-plus-fill"></i> 手動新增
            </button>

            <div class="d-inline-block text-center me-2">
                <button class="btn btn-sync-emp shadow-sm" onclick="syncEmployees(true)">
                    <i class="bi bi-briefcase-fill"></i> 同步教職員
                </button>
                <span id="empSyncTime" class="sync-info">未同步</span>
            </div>
            <div class="d-inline-block text-center">
                <button class="btn btn-sync-stu shadow-sm" onclick="syncStudents(true)">
                    <i class="bi bi-mortarboard-fill"></i> 同步學生
                </button>
                <span id="stuSyncTime" class="sync-info">未同步</span>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="d-flex mb-3 gap-2">
                <input type="text" id="searchInput" class="form-control w-auto" placeholder="搜尋帳號或姓名..." onkeyup="filterAccounts()">
                <select id="roleFilter" class="form-select w-auto" onchange="filterAccounts()">
                    <option value="">所有身分</option>
                    <option value="student">學生</option>
                    <option value="teacher">教師</option>
                    <option value="staff">職員</option>
                    <option value="admin">管理員</option>
                </select>
                <select id="statusFilter" class="form-select w-auto" onchange="filterAccounts()">
                    <option value="">所有狀態</option>
                    <option value="active">正常</option>
                    <option value="suspended">停用</option>
                </select>
                <button class="btn btn-outline-secondary ms-auto" onclick="loadAccounts()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>帳號</th>
                        <th>姓名</th>
                        <th>身分</th>
                        <th>狀態</th>
                        <th>密碼權限</th>
                        <th class="text-end" width="280">操作</th>
                    </tr>
                </thead>
                <tbody id="accTable">
                    <tr><td colspan="6" class="text-center py-5">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">編輯帳號</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="e_username_key">
                <div class="mb-3">
                    <label>帳號 (無法修改)</label>
                    <input type="text" id="e_username" class="form-control" disabled>
                </div>
                <div class="mb-3">
                    <label>姓名</label>
                    <input type="text" id="e_name" class="form-control">
                </div>
                <div class="mb-3">
                    <label>系統權限</label>
                    <select id="e_role" class="form-select">
                        <option value="admin">系統管理員</option>
                        <option value="teacher">教師</option>
                        <option value="staff">職員</option>
                        <option value="student">學生</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>帳號狀態</label>
                    <select id="e_status" class="form-select">
                        <option value="active">正常啟用</option>
                        <option value="suspended">停用 (禁止登入)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">儲存變更</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">手動新增帳號</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>帳號 <span class="text-danger">*</span></label>
                    <input type="text" id="a_username" class="form-control" placeholder="請輸入帳號">
                </div>
                <div class="mb-3">
                    <label>密碼 <span class="text-danger">*</span></label>
                    <input type="text" id="a_password" class="form-control" placeholder="預設密碼">
                </div>
                <div class="mb-3">
                    <label>姓名 <span class="text-danger">*</span></label>
                    <input type="text" id="a_name" class="form-control">
                </div>
                <div class="mb-3">
                    <label>權限</label>
                    <select id="a_role" class="form-select">
                        <option value="staff">職員</option>
                        <option value="teacher">教師</option>
                        <option value="admin">管理員</option>
                        <option value="student">學生</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-dark" onclick="saveNewAccount()">建立</button>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allAccounts = [];
    let editModal, addModal;

    document.addEventListener('DOMContentLoaded', () => {
        editModal = new bootstrap.Modal(document.getElementById('editModal'));
        addModal = new bootstrap.Modal(document.getElementById('addModal'));
        
        loadSyncTime();
        loadAccounts();
        
        // 自動檢查同步 (每天一次)
        checkAutoSync();
    });

    // 1. 載入與篩選
    async function loadAccounts() {
        const { data, error } = await window.db.from('system_users').select('*').order('username');
        if (error) { Swal.fire('讀取錯誤', error.message, 'error'); return; }
        allAccounts = data || [];
        filterAccounts();
    }

    function filterAccounts() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;
        const tbody = document.getElementById('accTable');
        tbody.innerHTML = '';

        const filtered = allAccounts.filter(acc => {
            const matchKey = (acc.username + acc.name).toLowerCase().includes(key);
            const matchRole = role ? acc.role === role : true;
            const matchStatus = status ? (acc.status || 'active') === status : true;
            return matchKey && matchRole && matchStatus;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">無符合資料</td></tr>';
            return;
        }

        filtered.forEach(acc => {
            const isSuspended = acc.status === 'suspended';
            let roleBadge = 'bg-secondary';
            if (acc.role === 'admin') roleBadge = 'bg-danger';
            if (acc.role === 'teacher') roleBadge = 'bg-success';
            if (acc.role === 'student') roleBadge = 'bg-info text-dark';

            let statusHtml = isSuspended 
                ? '<span class="badge bg-secondary">停用</span>' 
                : '<span class="badge bg-success">正常</span>';
            
            let rowStyle = isSuspended ? 'opacity: 0.6;' : '';
            let pwdAuth = acc.can_change_password ? '<i class="bi bi-check text-success"></i>' : '<i class="bi bi-lock-fill text-muted"></i>';

            tbody.innerHTML += `
                <tr style="${rowStyle}">
                    <td class="font-monospace fw-bold">${acc.username}</td>
                    <td>${acc.name || '-'}</td>
                    <td><span class="badge ${roleBadge} role-badge">${acc.role}</span></td>
                    <td>${statusHtml}</td>
                    <td class="text-center">${pwdAuth}</td>
                    <td class="text-end">
                        <div class="action-btn-group">
                            <button class="btn btn-outline-primary" title="編輯" onclick='openEdit(${JSON.stringify(acc)})'>
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-warning text-dark" title="還原預設密碼" onclick="resetPassword('${acc.username}', '${acc.role}', '${acc.id_number}')">
                                <i class="bi bi-key"></i>
                            </button>
                            ${isSuspended 
                                ? `<button class="btn btn-outline-success" title="啟用" onclick="toggleStatus('${acc.username}', 'active')"><i class="bi bi-play-fill"></i></button>`
                                : `<button class="btn btn-outline-dark" title="停用" onclick="toggleStatus('${acc.username}', 'suspended')"><i class="bi bi-pause-fill"></i></button>`
                            }
                            <button class="btn btn-outline-danger" title="刪除帳號" onclick="deleteAccount('${acc.username}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    // 2. 同步邏輯 (包含自動更新時間)
    function loadSyncTime() {
        const t1 = localStorage.getItem('lastSync_emp');
        const t2 = localStorage.getItem('lastSync_stu');
        if(t1) document.getElementById('empSyncTime').textContent = t1;
        if(t2) document.getElementById('stuSyncTime').textContent = t2;
    }

    function updateSyncTime(type) {
        const nowStr = new Date().toLocaleString('zh-TW', { hour12: false });
        localStorage.setItem(`lastSync_${type}`, nowStr);
        localStorage.setItem(`lastSyncTimeCheck`, Date.now()); // 紀錄 timestamp 供自動檢查
        loadSyncTime();
    }

    // 自動同步檢查
    function checkAutoSync() {
        const lastCheck = localStorage.getItem('lastSyncTimeCheck');
        const oneDay = 24 * 60 * 60 * 1000;
        
        // 如果從未同步過，或距離上次同步超過 24 小時
        if (!lastCheck || (Date.now() - parseInt(lastCheck)) > oneDay) {
            console.log('執行每日自動同步...');
            // 靜默執行，不跳 Alert
            syncEmployees(false);
            syncStudents(false);
        }
    }

    async function syncEmployees(showAlert = true) {
        if(showAlert && !(await confirmSync('教職員', '預設密碼 = 身分證字號 + @'))) return;
        
        try {
            const { data: emps, error } = await window.db.from('employees').select('*');
            if (error) throw error;
            if (!emps) return;

            const upsertData = emps.map(e => {
                if (!e.employee_id) return null;
                let pwd = '0000';
                if (e.id_number) pwd = e.id_number + '@';
                return {
                    username: e.employee_id, password: pwd, role: e.role || 'staff',
                    name: e.name, ref_id: e.id, is_student: false, can_change_password: true,
                    status: e.status || 'active', id_number: e.id_number
                };
            }).filter(x => x);

            const { error: upsertErr } = await window.db.from('system_users').upsert(upsertData, { onConflict: 'username' });
            if (upsertErr) throw upsertErr;
            
            updateSyncTime('emp');
            if(showAlert) Swal.fire('同步完成', `更新 ${upsertData.length} 筆資料`, 'success');
            loadAccounts();
        } catch (e) { if(showAlert) Swal.fire('錯誤', e.message, 'error'); }
    }

    async function syncStudents(showAlert = true) {
        if(showAlert && !(await confirmSync('學生', '預設密碼 = 身分證字號'))) return;

        try {
            const { data: stus, error } = await window.db.from('students').select('*');
            if (error) throw error;

            const upsertData = stus.map(s => {
                if (!s.student_id) return null;
                return {
                    username: s.student_id, password: s.id_number || '0000', role: 'student',
                    name: s.name_zh, ref_id: s.id, is_student: true, can_change_password: false,
                    status: s.status === 'active' ? 'active' : 'suspended', id_number: s.id_number
                };
            }).filter(x => x);

            const { error: upsertErr } = await window.db.from('system_users').upsert(upsertData, { onConflict: 'username' });
            if (upsertErr) throw upsertErr;

            updateSyncTime('stu');
            if(showAlert) Swal.fire('同步完成', `更新 ${upsertData.length} 筆資料`, 'success');
            loadAccounts();
        } catch (e) { if(showAlert) Swal.fire('錯誤', e.message, 'error'); }
    }

    async function confirmSync(type, rule) {
        const res = await Swal.fire({
            title: `同步${type}帳號？`,
            html: `系統將自動建立/更新帳號。<br><strong>${rule}</strong>`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: '開始同步'
        });
        return res.isConfirmed;
    }

    // 3. 手動新增
    window.openManualAdd = () => {
        document.getElementById('a_username').value = '';
        document.getElementById('a_password').value = '';
        document.getElementById('a_name').value = '';
        addModal.show();
    }

    window.saveNewAccount = async () => {
        const payload = {
            username: document.getElementById('a_username').value.trim(),
            password: document.getElementById('a_password').value.trim(),
            name: document.getElementById('a_name').value.trim(),
            role: document.getElementById('a_role').value,
            status: 'active',
            is_student: document.getElementById('a_role').value === 'student',
            can_change_password: true
        };

        if(!payload.username || !payload.password || !payload.name) {
            Swal.fire('欄位未填', '請填寫所有欄位', 'warning'); return;
        }

        const { error } = await window.db.from('system_users').insert([payload]);
        if(error) Swal.fire('建立失敗', error.message, 'error');
        else {
            addModal.hide();
            Swal.fire('成功', '帳號已建立', 'success');
            loadAccounts();
        }
    }

    // 4. 刪除帳號
    window.deleteAccount = async (username) => {
        const confirm = await Swal.fire({
            title: '刪除帳號？',
            text: `確定要刪除 ${username} 嗎？此動作無法復原。`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: '刪除'
        });

        if (confirm.isConfirmed) {
            const { error } = await window.db.from('system_users').delete().eq('username', username);
            if(error) Swal.fire('失敗', error.message, 'error');
            else {
                Swal.fire('已刪除', '帳號已移除', 'success');
                loadAccounts();
            }
        }
    }

    // 5. 編輯與其他功能 (維持原樣)
    window.openEdit = (acc) => {
        document.getElementById('e_username_key').value = acc.username;
        document.getElementById('e_username').value = acc.username;
        document.getElementById('e_name').value = acc.name;
        document.getElementById('e_role').value = acc.role;
        document.getElementById('e_status').value = acc.status || 'active';
        editModal.show();
    }
    window.saveEdit = async () => {
        const username = document.getElementById('e_username_key').value;
        const updates = { name: document.getElementById('e_name').value, role: document.getElementById('e_role').value, status: document.getElementById('e_status').value };
        const { error } = await window.db.from('system_users').update(updates).eq('username', username);
        if(error) Swal.fire('失敗', error.message, 'error'); else { editModal.hide(); Swal.fire('成功', '已更新', 'success'); loadAccounts(); }
    }
    window.resetPassword = async (username, role, idNumber) => {
        let newPwd = idNumber && idNumber!=='null' ? (role!=='student' ? idNumber+'@' : idNumber) : '0000';
        if((await Swal.fire({title:'還原預設密碼？', html:`還原為：<b>${newPwd}</b>`, icon:'warning', showCancelButton:true})).isConfirmed) {
            await window.db.from('system_users').update({password:newPwd}).eq('username', username); Swal.fire('成功', '密碼已還原', 'success');
        }
    }
    window.toggleStatus = async (username, status) => { await window.db.from('system_users').update({status}).eq('username',username); loadAccounts(); }
</script>
</body>
</html>
