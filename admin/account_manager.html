<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .role-badge { width: 100px; }
        /* 區分按鈕樣式 */
        .btn-sync-emp { background-color: #0d6efd; color: white; border: none; }
        .btn-sync-emp:hover { background-color: #0b5ed7; }
        .btn-sync-stu { background-color: #198754; color: white; border: none; }
        .btn-sync-stu:hover { background-color: #157347; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-shield-lock-fill"></i> 帳號管理</h3>
        <div>
            <button class="btn btn-sync-emp me-2 shadow-sm" onclick="syncEmployees()">
                <i class="bi bi-briefcase-fill"></i> 同步教職員帳號
            </button>
            <button class="btn btn-sync-stu shadow-sm" onclick="syncStudents()">
                <i class="bi bi-mortarboard-fill"></i> 同步學生帳號
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="d-flex mb-3 gap-2">
                <input type="text" id="searchInput" class="form-control w-auto" placeholder="搜尋帳號或姓名..." onkeyup="filterAccounts()">
                <select id="roleFilter" class="form-select w-auto" onchange="filterAccounts()">
                    <option value="">所有身分</option>
                    <option value="student">學生</option>
                    <option value="teacher">教師</option>
                    <option value="staff">職員</option>
                    <option value="admin">管理員</option>
                </select>
                <button class="btn btn-outline-secondary ms-auto" onclick="loadAccounts()">
                    <i class="bi bi-arrow-clockwise"></i> 重新整理
                </button>
            </div>

            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>帳號 (Username)</th>
                        <th>姓名</th>
                        <th>身分 (Role)</th>
                        <th>密碼權限</th>
                        <th class="text-end">操作</th>
                    </tr>
                </thead>
                <tbody id="accTable">
                    <tr><td colspan="5" class="text-center py-5">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    let allAccounts = [];

    document.addEventListener('DOMContentLoaded', loadAccounts);

    // 1. 載入帳號列表 (從 system_users)
    async function loadAccounts() {
        const { data, error } = await window.db.from('system_users').select('*').order('username');
        
        if (error) { 
            console.error(error); 
            Swal.fire('讀取錯誤', '無法讀取帳號資料 (system_users)', 'error');
            return; 
        }
        
        allAccounts = data || [];
        filterAccounts();
    }

    // 2. 渲染與篩選
    function filterAccounts() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const role = document.getElementById('roleFilter').value;
        const tbody = document.getElementById('accTable');
        tbody.innerHTML = '';

        const filtered = allAccounts.filter(acc => {
            const name = acc.name || '';
            const username = acc.username || '';
            const matchKey = (username + name).toLowerCase().includes(key);
            const matchRole = role ? acc.role === role : true;
            return matchKey && matchRole;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">無符合資料</td></tr>';
            return;
        }

        filtered.forEach(acc => {
            let roleColor = 'bg-secondary';
            if (acc.role === 'admin') roleColor = 'bg-danger';
            if (acc.role === 'teacher') roleColor = 'bg-success';
            if (acc.role === 'student') roleColor = 'bg-info text-dark';

            let pwdStatus = acc.can_change_password 
                ? '<span class="text-success small"><i class="bi bi-check-circle"></i> 可修改</span>' 
                : '<span class="text-muted small"><i class="bi bi-lock-fill"></i> 鎖定 (學生預設)</span>';

            // 學生不能有權限設定按鈕，其他人有
            let actionBtn = '';
            if (!acc.is_student) {
                actionBtn = `<button class="btn btn-sm btn-outline-dark" onclick="editPermission('${acc.username}', '${acc.role}')"><i class="bi bi-gear"></i> 權限設定</button>`;
            } else {
                actionBtn = `<span class="text-muted small">由學籍資料管理</span>`;
            }

            tbody.innerHTML += `
                <tr>
                    <td class="font-monospace fw-bold text-primary">${acc.username}</td>
                    <td>${acc.name || '-'}</td>
                    <td><span class="badge ${roleColor} role-badge">${acc.role}</span></td>
                    <td>${pwdStatus}</td>
                    <td class="text-end">${actionBtn}</td>
                </tr>
            `;
        });
    }

    // 3. 同步教職員帳號 (從 employees -> system_users)
    async function syncEmployees() {
        const confirm = await Swal.fire({
            title: '同步教職員資料？',
            text: "系統將讀取「人事資料管理」清單，自動建立或更新帳號權限。\n預設密碼：0000",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#0d6efd', // 藍色
            confirmButtonText: '開始同步'
        });

        if (!confirm.isConfirmed) return;
        Swal.fire({ title: '處理中...', didOpen: () => Swal.showLoading() });

        try {
            // A. 讀取員工表
            const { data: emps } = await window.db.from('employees').select('id, employee_id, name, role');
            if (!emps || emps.length === 0) throw new Error("人事資料庫無資料");

            // B. 準備資料
            // 邏輯：如果帳號已存在，我們只更新 name, role, ref_id (不覆蓋密碼)
            // 但 Supabase upsert 預設是全覆蓋。為了保留舊密碼，我們需要一點技巧。
            // 簡化做法：我們先全部讀出來，比對一下。或者直接 Upsert 但忽略 password (需要寫 SQL function，比較麻煩)
            // 這裡採用 JS 邏輯：先查 system_users，如果存在就用舊密碼，不存在就用 '0000'
            
            // 先抓現有帳號 Map
            const existingMap = {};
            allAccounts.forEach(a => existingMap[a.username] = a.password);

            const upsertData = emps.map(e => {
                const oldPwd = existingMap[e.employee_id];
                return {
                    username: e.employee_id,
                    password: oldPwd || '0000', // 有舊密碼用舊的，沒有用 0000
                    role: e.role || 'staff',
                    name: e.name,
                    ref_id: e.id,
                    is_student: false,
                    can_change_password: true
                };
            });

            // C. 寫入
            const { error } = await window.db.from('system_users').upsert(upsertData, { onConflict: 'username' });
            if (error) throw error;

            Swal.fire('同步完成', `已更新 ${upsertData.length} 筆教職員帳號`, 'success');
            loadAccounts();

        } catch (err) {
            Swal.fire('同步失敗', err.message, 'error');
        }
    }

    // 4. 同步學生帳號 (從 students -> system_users)
    async function syncStudents() {
        const confirm = await Swal.fire({
            title: '同步學生帳號？',
            text: "帳號 = 學號\n密碼 = 身分證字號\n此操作會鎖定學生修改密碼權限。",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#198754', // 綠色
            confirmButtonText: '確認同步'
        });

        if (!confirm.isConfirmed) return;
        Swal.fire({ title: '處理中...', didOpen: () => Swal.showLoading() });

        try {
            // A. 讀取學生表
            const { data: stus } = await window.db.from('students').select('id, student_id, id_number, name_zh');
            
            if (!stus || stus.length === 0) throw new Error("學籍資料庫無資料");

            // B. 準備資料
            const upsertData = stus.map(s => {
                if (!s.student_id || !s.id_number) return null;
                return {
                    username: s.student_id,
                    password: s.id_number, // 學生密碼強制設為身分證字號 (重置)
                    role: 'student',
                    name: s.name_zh,
                    ref_id: s.id,
                    is_student: true,
                    can_change_password: false // 鎖定
                };
            }).filter(x => x);

            // C. 寫入
            const { error } = await window.db.from('system_users').upsert(upsertData, { onConflict: 'username' });
            if (error) throw error;

            Swal.fire('同步完成', `已更新 ${upsertData.length} 筆學生帳號`, 'success');
            loadAccounts();

        } catch (err) {
            Swal.fire('同步失敗', err.message, 'error');
        }
    }

    // 5. 獨立設定帳號權限
    async function editPermission(username, currentRole) {
        const { value: newRole } = await Swal.fire({
            title: `設定帳號 ${username} 的權限`,
            input: 'select',
            inputOptions: {
                'admin': '系統管理員',
                'teacher': '教師',
                'staff': '職員'
            },
            inputValue: currentRole,
            showCancelButton: true
        });

        if (newRole) {
            await window.db.from('system_users').update({ role: newRole }).eq('username', username);
            Swal.fire('已更新', '權限已變更', 'success');
            loadAccounts();
        }
    }
</script>
</body>
</html>
