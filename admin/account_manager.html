<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>帳號權限管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light p-4">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-shield-lock-fill"></i> 帳號權限管理</h3>
        <div class="btn-group">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="bi bi-person-plus-fill"></i> 手動新增
            </button>
            <button id="syncBtn" class="btn btn-warning text-dark">
                <i class="bi bi-arrow-repeat"></i> 同步教職員
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th>狀態</th>
                        <th>帳號</th>
                        <th>姓名</th>
                        <th>角色</th>
                        <th>密碼</th>
                        <th>到期日</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">新增帳號</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="mb-3">
                        <label>帳號 (ID)</label>
                        <input type="text" id="m_username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>姓名</label>
                        <input type="text" id="m_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>角色</label>
                        <select id="m_role" class="form-select">
                            <option value="staff">教職員</option>
                            <option value="student">學生</option>
                            <option value="admin">管理員</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveUserBtn" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    async function loadUsers() {
        const { data: users, error } = await window.db.from('system_users').select('*').order('username');
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';
        
        if(error) return;

        users.forEach(user => {
            const isExpired = user.expiry_date && user.expiry_date < new Date().toISOString().split('T')[0];
            const statusBadge = (!user.is_active || isExpired) 
                ? '<span class="badge bg-danger">停用</span>' 
                : '<span class="badge bg-success">正常</span>';
            
            tbody.innerHTML += `
                <tr>
                    <td>${statusBadge}</td>
                    <td class="fw-bold">${user.username}</td>
                    <td>${user.name}</td>
                    <td>${user.role}</td>
                    <td class="text-muted">******</td>
                    <td>${user.expiry_date || '<span class="text-muted">-</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-warning" onclick="resetPassword('${user.username}')" title="還原密碼">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.username}')" title="刪除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    // 儲存
    document.getElementById('saveUserBtn').addEventListener('click', async () => {
        const data = {
            username: document.getElementById('m_username').value,
            name: document.getElementById('m_name').value,
            password: '123456', // 預設密碼
            role: document.getElementById('m_role').value,
            is_active: true
        };
        const { error } = await window.db.from('system_users').upsert([data]);
        if(!error) {
            alert('成功');
            location.reload();
        }
    });

    // 刪除
    window.deleteUser = async (id) => {
        if(confirm('確定刪除?')) {
            await window.db.from('system_users').delete().eq('username', id);
            loadUsers();
        }
    };

    // 還原密碼
    window.resetPassword = async (id) => {
        if(confirm('確定還原成預設密碼 (身分證)?')) {
            // 先去抓員工資料
            const { data: emp } = await window.db.from('employees').select('national_id').eq('employee_id', id).single();
            if(emp) {
                await window.db.from('system_users').update({ password: emp.national_id }).eq('username', id);
                alert('已還原');
            } else {
                alert('找不到該員工資料，無法還原');
            }
        }
    };

    // 同步
    document.getElementById('syncBtn').addEventListener('click', async () => {
        if(!confirm('確定同步?')) return;
        const { data: emps } = await window.db.from('employees').select('*').eq('status', 'active');
        for(let emp of emps) {
            const { data: exist } = await window.db.from('system_users').select('username').eq('username', emp.employee_id).single();
            if(!exist) {
                await window.db.from('system_users').insert([{
                    username: emp.employee_id,
                    name: emp.name,
                    password: emp.national_id,
                    role: 'staff',
                    is_active: true
                }]);
            }
        }
        alert('同步完成');
        loadUsers();
    });

    loadUsers();
</script>
</body>
</html>
