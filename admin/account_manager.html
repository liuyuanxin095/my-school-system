<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帳號管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .btn-sync-emp { background-color: #0d6efd; color: white; border: none; }
        .btn-sync-emp:hover { background-color: #0b5ed7; }
        .btn-sync-stu { background-color: #198754; color: white; border: none; }
        .btn-sync-stu:hover { background-color: #157347; }
        .status-suspended { text-decoration: line-through; color: #adb5bd; }
        .action-btn-group .btn { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark"><i class="bi bi-shield-lock-fill"></i> 帳號管理</h3>
        <div>
            <button class="btn btn-sync-emp me-2 shadow-sm" onclick="syncEmployees()">
                <i class="bi bi-briefcase-fill"></i> 同步教職員帳號
            </button>
            <button class="btn btn-sync-stu shadow-sm" onclick="syncStudents()">
                <i class="bi bi-mortarboard-fill"></i> 同步學生帳號
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="d-flex mb-3 gap-2">
                <input type="text" id="searchInput" class="form-control w-auto" placeholder="搜尋帳號或姓名..." onkeyup="filterAccounts()">
                <select id="roleFilter" class="form-select w-auto" onchange="filterAccounts()">
                    <option value="">所有身分</option>
                    <option value="student">學生</option>
                    <option value="teacher">教師</option>
                    <option value="staff">職員</option>
                    <option value="admin">管理員</option>
                </select>
                <select id="statusFilter" class="form-select w-auto" onchange="filterAccounts()">
                    <option value="">所有狀態</option>
                    <option value="active">正常</option>
                    <option value="suspended">停用</option>
                </select>
                <button class="btn btn-outline-secondary ms-auto" onclick="loadAccounts()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>帳號</th>
                        <th>姓名</th>
                        <th>身分</th>
                        <th>狀態</th>
                        <th>密碼權限</th>
                        <th class="text-end" width="250">操作</th>
                    </tr>
                </thead>
                <tbody id="accTable">
                    <tr><td colspan="6" class="text-center py-5">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">編輯帳號</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="e_username_key">
                <div class="mb-3">
                    <label>帳號 (無法修改)</label>
                    <input type="text" id="e_username" class="form-control" disabled>
                </div>
                <div class="mb-3">
                    <label>姓名</label>
                    <input type="text" id="e_name" class="form-control">
                </div>
                <div class="mb-3">
                    <label>系統權限</label>
                    <select id="e_role" class="form-select">
                        <option value="admin">系統管理員</option>
                        <option value="teacher">教師</option>
                        <option value="staff">職員</option>
                        <option value="student">學生</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>帳號狀態</label>
                    <select id="e_status" class="form-select">
                        <option value="active">正常啟用</option>
                        <option value="suspended">停用 (禁止登入)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">儲存變更</button>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allAccounts = [];
    let editModal;

    document.addEventListener('DOMContentLoaded', () => {
        editModal = new bootstrap.Modal(document.getElementById('editModal'));
        loadAccounts();
    });

    // 1. 載入帳號
    async function loadAccounts() {
        const { data, error } = await window.db.from('system_users').select('*').order('username');
        if (error) { Swal.fire('錯誤', error.message, 'error'); return; }
        allAccounts = data || [];
        filterAccounts();
    }

    // 2. 渲染與篩選
    function filterAccounts() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;
        const tbody = document.getElementById('accTable');
        tbody.innerHTML = '';

        const filtered = allAccounts.filter(acc => {
            const matchKey = (acc.username + acc.name).toLowerCase().includes(key);
            const matchRole = role ? acc.role === role : true;
            const matchStatus = status ? (acc.status || 'active') === status : true;
            return matchKey && matchRole && matchStatus;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">無符合資料</td></tr>';
            return;
        }

        filtered.forEach(acc => {
            const isSuspended = acc.status === 'suspended';
            let roleBadge = 'bg-secondary';
            if (acc.role === 'admin') roleBadge = 'bg-danger';
            if (acc.role === 'teacher') roleBadge = 'bg-success';
            if (acc.role === 'student') roleBadge = 'bg-info text-dark';

            let statusHtml = isSuspended 
                ? '<span class="badge bg-secondary">停用</span>' 
                : '<span class="badge bg-success">正常</span>';
            
            let rowStyle = isSuspended ? 'opacity: 0.6;' : '';

            // 密碼狀態
            let pwdAuth = acc.can_change_password ? '<i class="bi bi-check text-success"></i>' : '<i class="bi bi-lock-fill text-muted"></i>';

            tbody.innerHTML += `
                <tr style="${rowStyle}">
                    <td class="font-monospace fw-bold">${acc.username}</td>
                    <td>${acc.name || '-'}</td>
                    <td><span class="badge ${roleBadge} role-badge">${acc.role}</span></td>
                    <td>${statusHtml}</td>
                    <td class="text-center">${pwdAuth}</td>
                    <td class="text-end">
                        <div class="action-btn-group">
                            <button class="btn btn-outline-primary" title="編輯" onclick='openEdit(${JSON.stringify(acc)})'>
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-warning text-dark" title="還原預設密碼" onclick="resetPassword('${acc.username}', '${acc.role}', '${acc.id_number}')">
                                <i class="bi bi-key"></i>
                            </button>
                            ${isSuspended 
                                ? `<button class="btn btn-outline-success" title="啟用" onclick="toggleStatus('${acc.username}', 'active')"><i class="bi bi-play-fill"></i></button>`
                                : `<button class="btn btn-outline-danger" title="停用" onclick="toggleStatus('${acc.username}', 'suspended')"><i class="bi bi-pause-fill"></i></button>`
                            }
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    // 3. 同步教職員
    async function syncEmployees() {
        if(!(await confirmSync('教職員', '預設密碼 = 身分證字號 + @'))) return;
        
        try {
            const { data: emps } = await window.db.from('employees').select('id, employee_id, name, role, id_number');
            if (!emps || emps.length === 0) throw new Error("人事資料無資料");

            // 檢查 ID Number 是否存在
            const invalid = emps.filter(e => !e.id_number);
            if(invalid.length > 0) {
                 Swal.fire('部分資料不全', `有 ${invalid.length} 位教職員無身分證字號，無法建立預設密碼。`, 'warning');
            }

            const upsertData = emps.filter(e => e.id_number).map(e => ({
                username: e.employee_id,
                password: e.id_number + '@', // 規則：ID + @
                role: e.role || 'staff',
                name: e.name,
                ref_id: e.id,
                is_student: false,
                can_change_password: true,
                status: 'active',
                id_number: e.id_number // 存起來備用
            }));

            const { error } = await window.db.from('system_users').upsert(upsertData, { onConflict: 'username' });
            if (error) throw error;
            
            Swal.fire('同步完成', `已更新 ${upsertData.length} 筆教職員帳號`, 'success');
            loadAccounts();
        } catch (e) { Swal.fire('錯誤', e.message, 'error'); }
    }

    // 4. 同步學生
    async function syncStudents() {
        if(!(await confirmSync('學生', '預設密碼 = 身分證字號'))) return;

        try {
            const { data: stus } = await window.db.from('students').select('id, student_id, name_zh, id_number');
            if (!stus || stus.length === 0) throw new Error("學籍資料無資料");

            const upsertData = stus.filter(s => s.student_id && s.id_number).map(s => ({
                username: s.student_id,
                password: s.id_number, // 規則：ID
                role: 'student',
                name: s.name_zh,
                ref_id: s.id,
                is_student: true,
                can_change_password: false, // 學生不可改
                status: 'active',
                id_number: s.id_number
            }));

            const { error } = await window.db.from('system_users').upsert(upsertData, { onConflict: 'username' });
            if (error) throw error;

            Swal.fire('同步完成', `已更新 ${upsertData.length} 筆學生帳號`, 'success');
            loadAccounts();
        } catch (e) { Swal.fire('錯誤', e.message, 'error'); }
    }

    async function confirmSync(type, rule) {
        const res = await Swal.fire({
            title: `同步${type}帳號？`,
            html: `系統將自動建立/更新帳號。<br><strong>${rule}</strong>`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: '開始同步'
        });
        return res.isConfirmed;
    }

    // 5. 編輯帳號
    window.openEdit = (acc) => {
        document.getElementById('e_username_key').value = acc.username;
        document.getElementById('e_username').value = acc.username;
        document.getElementById('e_name').value = acc.name;
        document.getElementById('e_role').value = acc.role;
        document.getElementById('e_status').value = acc.status || 'active';
        editModal.show();
    }

    window.saveEdit = async () => {
        const username = document.getElementById('e_username_key').value;
        const updates = {
            name: document.getElementById('e_name').value,
            role: document.getElementById('e_role').value,
            status: document.getElementById('e_status').value
        };

        const { error } = await window.db.from('system_users').update(updates).eq('username', username);
        if(error) Swal.fire('失敗', error.message, 'error');
        else {
            editModal.hide();
            Swal.fire('成功', '帳號資料已更新', 'success');
            loadAccounts();
        }
    }

    // 6. 還原預設密碼
    window.resetPassword = async (username, role, idNumber) => {
        if (!idNumber || idNumber === 'null') {
            Swal.fire('無法還原', '此帳號系統內無身分證字號紀錄，請手動編輯資料庫或重新同步。', 'error');
            return;
        }

        // 判斷規則
        let newPwd = idNumber;
        let ruleText = "身分證字號";
        
        if (role !== 'student') {
            newPwd = idNumber + '@';
            ruleText = "身分證字號 + @";
        }

        const confirm = await Swal.fire({
            title: '還原預設密碼？',
            html: `將還原為：<b>${ruleText}</b>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            confirmButtonText: '確認還原'
        });

        if (confirm.isConfirmed) {
            const { error } = await window.db.from('system_users')
                .update({ password: newPwd })
                .eq('username', username);
            
            if(error) Swal.fire('失敗', error.message, 'error');
            else Swal.fire('成功', '密碼已還原', 'success');
        }
    }

    // 7. 停用/啟用 (快速切換)
    window.toggleStatus = async (username, targetStatus) => {
        let action = targetStatus === 'active' ? '啟用' : '停用';
        const { error } = await window.db.from('system_users').update({ status: targetStatus }).eq('username', username);
        
        if(error) Swal.fire('操作失敗', error.message, 'error');
        else {
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            Toast.fire({ icon: 'success', title: `帳號已${action}` });
            loadAccounts();
        }
    }
</script>
</body>
</html>
