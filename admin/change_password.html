<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改個人密碼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }</style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h3 class="fw-bold text-dark mb-4"><i class="bi bi-key-fill"></i> 修改個人密碼</h3>
            
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    
                    <div id="alertBox" class="alert alert-info d-none"></div>

                    <div id="step1">
                        <h5 class="card-title mb-3">步驟 1: 驗證身分</h5>
                        <div class="mb-3">
                            <label class="form-label">目前帳號</label>
                            <input type="text" id="username" class="form-control bg-light" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">輸入舊密碼</label>
                            <input type="password" id="oldPwd" class="form-control" placeholder="請輸入目前密碼">
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="verifyPassword()">下一步 (驗證)</button>
                        </div>
                    </div>

                    <div id="step2" style="display: none;">
                        <h5 class="card-title mb-3 text-success"><i class="bi bi-check-circle-fill"></i> 身分驗證成功</h5>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label">設定新密碼</label>
                            <input type="password" id="newPwd" class="form-control" placeholder="請輸入新密碼">
                            <div class="form-text">請使用英數混合，至少6碼。</div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">確認新密碼</label>
                            <input type="password" id="cfmPwd" class="form-control" placeholder="再次輸入">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="updatePassword()">確認修改</button>
                            <button class="btn btn-outline-secondary" onclick="resetFlow()">取消</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    let currentUser = null;
    let dbPassword = "";

    document.addEventListener('DOMContentLoaded', async () => {
        const userStr = localStorage.getItem('currentUser');
        if (!userStr) { window.location.href = '../login.html'; return; }
        currentUser = JSON.parse(userStr);
        document.getElementById('username').value = currentUser.username;

        // 檢查權限
        const { data } = await window.db.from('system_users')
            .select('password, can_change_password')
            .eq('username', currentUser.username)
            .single();

        if (data) {
            dbPassword = data.password;
            if (data.can_change_password === false) {
                const box = document.getElementById('alertBox');
                box.classList.remove('d-none');
                box.classList.add('alert-warning');
                box.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> 您的帳號權限無法修改密碼。';
                document.getElementById('step1').style.display = 'none'; // 隱藏操作區
            }
        }
    });

    // 驗證舊密碼
    function verifyPassword() {
        const inputPwd = document.getElementById('oldPwd').value;
        if (!inputPwd) { Swal.fire('提示', '請輸入舊密碼', 'warning'); return; }
        
        if (inputPwd === dbPassword) {
            // 動畫切換
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        } else {
            Swal.fire('驗證失敗', '舊密碼錯誤', 'error');
            document.getElementById('oldPwd').value = '';
        }
    }

    // 更新密碼
    async function updatePassword() {
        const newPwd = document.getElementById('newPwd').value;
        const cfmPwd = document.getElementById('cfmPwd').value;

        if (!newPwd || !cfmPwd) { Swal.fire('錯誤', '請填寫完整', 'warning'); return; }
        if (newPwd !== cfmPwd) { Swal.fire('錯誤', '兩次密碼不一致', 'error'); return; }
        if (newPwd === dbPassword) { Swal.fire('錯誤', '新密碼不可與舊密碼相同', 'warning'); return; }
        if (newPwd.length < 6) { Swal.fire('提示', '密碼長度過短 (至少6碼)', 'warning'); return; }

        try {
            const { error } = await window.db.from('system_users')
                .update({ password: newPwd })
                .eq('username', currentUser.username);

            if (error) throw error;

            await Swal.fire('成功', '密碼已修改，請重新登入', 'success');
            localStorage.removeItem('currentUser');
            window.parent.location.href = '../login.html'; // 強制登出回首頁

        } catch (err) {
            Swal.fire('失敗', err.message, 'error');
        }
    }

    function resetFlow() {
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step1').style.display = 'block';
        document.getElementById('oldPwd').value = '';
        document.getElementById('newPwd').value = '';
        document.getElementById('cfmPwd').value = '';
    }
</script>
</body>
</html>
