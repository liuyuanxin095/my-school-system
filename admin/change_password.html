<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ”¹å€‹äººå¯†ç¢¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light p-4">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 mt-5">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h5 class="mb-0">ğŸ”’ ä¿®æ”¹å€‹äººå¯†ç¢¼</h5>
                </div>
                <div class="card-body p-4">
                    
                    <div class="alert alert-info small">
                        ç‚ºäº†æ‚¨çš„å¸³è™Ÿå®‰å…¨ï¼Œå»ºè­°å®šæœŸæ›´æ›å¯†ç¢¼ã€‚<br>
                        æ–°å¯†ç¢¼é•·åº¦å»ºè­°è‡³å°‘ 6 ç¢¼ã€‚
                    </div>

                    <form id="pwdForm">
                        <div class="mb-3">
                            <label class="form-label">ç›®å‰èˆŠå¯†ç¢¼</label>
                            <input type="password" id="old_pwd" class="form-control" placeholder="è«‹è¼¸å…¥ç¾åœ¨ä½¿ç”¨çš„å¯†ç¢¼" required>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label">è¨­å®šæ–°å¯†ç¢¼</label>
                            <input type="password" id="new_pwd" class="form-control" placeholder="æ–°å¯†ç¢¼" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm_pwd" class="form-control" placeholder="è«‹å†è¼¸å…¥ä¸€æ¬¡æ–°å¯†ç¢¼" required>
                        </div>

                        <div class="d-grid">
                            <button type="submit" id="saveBtn" class="btn btn-primary">ç¢ºèªä¿®æ”¹</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    // å–å¾—ç•¶å‰ç™»å…¥è€…è³‡è¨Š
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));

    // å¦‚æœæ²’ç™»å…¥ï¼Œè¸¢å‡ºå»
    if (!currentUser) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        window.top.location.href = '../login.html'; // è·³è½‰å›æœ€å¤–å±¤ç™»å…¥é 
    }

    document.getElementById('pwdForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const oldPwd = document.getElementById('old_pwd').value;
        const newPwd = document.getElementById('new_pwd').value;
        const confirmPwd = document.getElementById('confirm_pwd').value;
        const btn = document.getElementById('saveBtn');

        // 1. åŸºæœ¬æª¢æŸ¥
        if (newPwd.length < 4) {
            alert('âŒ æ–°å¯†ç¢¼å¤ªçŸ­äº†ï¼Œè«‹è‡³å°‘è¼¸å…¥ 4 ç¢¼ï¼');
            return;
        }
        if (newPwd !== confirmPwd) {
            alert('âŒ å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ç›¸åŒï¼');
            return;
        }
        if (oldPwd === newPwd) {
            alert('âŒ æ–°å¯†ç¢¼ä¸èƒ½è·ŸèˆŠå¯†ç¢¼ä¸€æ¨£ï¼');
            return;
        }

        btn.disabled = true;
        btn.textContent = "é©—è­‰ä¸¦å„²å­˜ä¸­...";

        // 2. é©—è­‰èˆŠå¯†ç¢¼æ˜¯å¦æ­£ç¢º (å»è³‡æ–™åº«æŸ¥)
        const { data: userCheck, error: checkError } = await db
            .from('system_users')
            .select('*')
            .eq('username', currentUser.username)
            .eq('password', oldPwd) // æ¯”å°èˆŠå¯†ç¢¼
            .single();

        if (checkError || !userCheck) {
            alert('âŒ èˆŠå¯†ç¢¼è¼¸å…¥éŒ¯èª¤ï¼Œè«‹é‡æ–°ç¢ºèªï¼');
            btn.disabled = false;
            btn.textContent = "ç¢ºèªä¿®æ”¹";
            return;
        }

        // 3. æ›´æ–°å¯†ç¢¼
        const { error: updateError } = await db
            .from('system_users')
            .update({ password: newPwd })
            .eq('username', currentUser.username);

        if (updateError) {
            alert('âŒ ä¿®æ”¹å¤±æ•—ï¼š' + updateError.message);
            btn.disabled = false;
            btn.textContent = "ç¢ºèªä¿®æ”¹";
        } else {
            alert('âœ… å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼\nè«‹ä½¿ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚');
            
            // æ¸…é™¤ç™»å…¥ç‹€æ…‹ä¸¦è¸¢å›ç™»å…¥é 
            localStorage.removeItem('currentUser');
            window.top.location.href = '../login.html';
        }
    });
</script>

</body>
</html>
