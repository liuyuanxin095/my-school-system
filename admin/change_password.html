<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>修改密碼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light p-4">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0 text-center">
                    <h4 class="fw-bold"><i class="bi bi-shield-lock"></i> 修改個人密碼</h4>
                </div>
                <div class="card-body p-4">

                    <div id="step1">
                        <p class="text-muted text-center mb-4">為了確保安全，請先輸入您目前的密碼進行驗證。</p>
                        <form id="verifyForm">
                            <div class="mb-3">
                                <label class="form-label">目前帳號</label>
                                <input type="text" class="form-control bg-light" id="displayUser" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">舊密碼</label>
                                <input type="password" id="old_pwd" class="form-control" placeholder="請輸入舊密碼" required autofocus>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">下一步 <i class="bi bi-arrow-right"></i></button>
                        </form>
                    </div>

                    <div id="step2" style="display: none;">
                        <div class="alert alert-info small">
                            <i class="bi bi-info-circle-fill"></i> <strong>密碼規則：</strong>
                            <ul class="mb-0 ps-3">
                                <li>長度需 8 位數以上</li>
                                <li>包含至少一個大寫字母 (A-Z)</li>
                                <li>包含至少一個小寫字母 (a-z)</li>
                                <li>包含至少一個特殊符號 (!@#$%^&*)</li>
                                <li>不可與最近 3 次密碼重複</li>
                            </ul>
                        </div>
                        <form id="changeForm">
                            <div class="mb-3">
                                <label class="form-label">新密碼輸入</label>
                                <input type="password" id="new_pwd" class="form-control" placeholder="請輸入高強度密碼" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">再次確認新密碼</label>
                                <input type="password" id="confirm_pwd" class="form-control" placeholder="請再次輸入" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">送出修改 <i class="bi bi-check-lg"></i></button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script>
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if(!user) window.top.location.href = '../login.html';

    document.getElementById('displayUser').value = user.username + " (" + user.name + ")";

    // 階段一：驗證
    document.getElementById('verifyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const oldPwd = document.getElementById('old_pwd').value;

        // 查資料庫驗證
        const { data: validUser, error } = await db.from('system_users')
            .select('*')
            .eq('username', user.username)
            .eq('password', oldPwd)
            .single();

        if(error || !validUser) {
            Swal.fire({ icon: 'error', title: '驗證失敗', text: '舊密碼不正確，請重新輸入。' });
        } else {
            // 驗證通過，切換畫面
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            // 儲存最新的用戶資料供第二步使用 (包含歷史紀錄)
            window.currentUserData = validUser; 
        }
    });

    // 階段二：修改
    document.getElementById('changeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPwd = document.getElementById('new_pwd').value;
        const confirmPwd = document.getElementById('confirm_pwd').value;

        // 1. 基礎比對
        if(newPwd !== confirmPwd) {
            Swal.fire('錯誤', '兩次輸入的密碼不一致', 'warning'); return;
        }

        // 2. 規則檢查 (Regex)
        const rule = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
        if(!rule.test(newPwd)) {
            Swal.fire('密碼強度不足', '請確保密碼包含大寫、小寫、符號且長度超過8碼。', 'warning'); return;
        }

        // 3. 歷史檢查 (三代不可重複)
        // 注意：Supabase如果原本是 null, 需要轉成空陣列
        let history = window.currentUserData.password_history || [];
        // 確保 history 是陣列
        if (typeof history === 'string') history = JSON.parse(history);

        // 檢查最近 3 次
        const recentPasswords = history.slice(-3); 
        if(recentPasswords.includes(newPwd) || newPwd === window.currentUserData.password) {
            Swal.fire('重複密碼', '新密碼不可與最近 3 次使用的密碼相同。', 'error'); return;
        }

        // 4. 準備更新資料
        history.push(window.currentUserData.password); // 把舊密碼存入歷史
        
        const { error } = await db.from('system_users')
            .update({ 
                password: newPwd,
                password_history: history,
                last_pwd_update: new Date().toISOString().split('T')[0] // 更新日期
            })
            .eq('username', user.username);

        if(error) {
            Swal.fire('系統錯誤', error.message, 'error');
        } else {
            // 5. 成功浮動視窗
            Swal.fire({
                icon: 'success',
                title: '密碼修改完成',
                text: '為確保安全，系統將重新登入',
                showConfirmButton: false,
                timer: 2000
            }).then(() => {
                localStorage.removeItem('currentUser');
                window.top.location.href = '../login.html';
            });
        }
    });
</script>
</body>
</html>
