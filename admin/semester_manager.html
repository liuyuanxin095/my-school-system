<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學期資料管理 (系統)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; }
        .week-btn { width: 100%; text-align: left; margin-bottom: 2px; font-size: 0.9rem; }
        .table-weeks td { padding: 5px; text-align: center; vertical-align: middle; }
        .table-weeks input { text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; padding: 2px; width: 100%; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark"><i class="bi bi-calendar-range-fill"></i> 學期資料管理</h3>
            <small class="text-muted">全校學期與週次設定 (僅管理員可操作)</small>
        </div>
        <div>
            <a href="../index.html" class="btn btn-outline-secondary me-2">回首頁</a>
            <button class="btn btn-primary" onclick="openEditModal()"><i class="bi bi-plus-lg"></i> 新增學期</button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="120">學期代碼</th>
                            <th>學期名稱</th>
                            <th>狀態</th>
                            <th width="220" class="text-center">國小部週次</th>
                            <th width="220" class="text-center">國(高)中部週次</th>
                            <th width="120" class="text-end">操作</th>
                        </tr>
                    </thead>
                    <tbody id="semTable">
                        <tr><td colspan="6" class="text-center py-5 text-muted">資料讀取中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="semModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">學期基本資料</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-3">
                    <label>學期代碼 <span class="text-danger">*</span></label>
                    <input type="text" id="m_code" class="form-control" placeholder="例: 114-1">
                </div>
                <div class="mb-3">
                    <label>學期名稱 <span class="text-danger">*</span></label>
                    <input type="text" id="m_name" class="form-control" placeholder="例: 114學年度第1學期">
                </div>
                <div class="mb-3">
                    <label>系統狀態</label>
                    <select id="m_status" class="form-select">
                        <option value="archive">一般學期 (存檔/未來)</option>
                        <option value="current">目前系統學期 (Active)</option>
                    </select>
                    <div class="form-text text-danger">「目前系統學期」是全校預設顯示的學期，同一時間只能有一個。</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveSemester()">儲存</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="weekModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-range"></i> 週次管理與產生器</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="wk_sem_id">
                <input type="hidden" id="wk_dept_type">
                
                <div class="alert alert-primary d-flex align-items-center mb-3">
                    <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                    <div>
                        正在設定：<strong id="wk_title_display"></strong><br>
                        <small>此設定將連動影響「校務行事曆」與「課程週次」顯示。</small>
                    </div>
                </div>

                <div class="row g-2 align-items-end mb-3 bg-light p-3 rounded mx-0">
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted">開學日 (第一週週一)</label>
                        <input type="date" id="startDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold text-muted">總週數</label>
                        <input type="number" id="weekCount" class="form-control form-control-sm" value="21">
                    </div>
                    <div class="col-md-5">
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="generateWeeks()">
                            <i class="bi bi-magic"></i> 重新產生週次表
                        </button>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-bordered table-sm table-weeks">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="60">週次</th>
                                <th>開始日期</th>
                                <th>結束日期</th>
                                <th>行事曆備註 (例:段考)</th>
                            </tr>
                        </thead>
                        <tbody id="weekListBody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-success" onclick="saveWeeks()">儲存設定</button>
            </div>
        </div>
    </div>
</div>

<script src="../js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let semModal, weekModal;
    let currentWeeksData = [];

    document.addEventListener('DOMContentLoaded', () => {
        semModal = new bootstrap.Modal(document.getElementById('semModal'));
        weekModal = new bootstrap.Modal(document.getElementById('weekModal'));
        if(window.db) loadSemesters();
    });

    // 1. 載入學期與週次狀態
    async function loadSemesters() {
        const { data: sems, error } = await window.db.from('semesters').select('*').order('semester_code', { ascending: false });
        const { data: weeks } = await window.db.from('semester_weeks').select('semester_id, department_type');

        const tbody = document.getElementById('semTable');
        tbody.innerHTML = '';
        
        if (error || !sems) { tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5">無資料</td></tr>`; return; }

        sems.forEach(s => {
            const statusBadge = s.status === 'current' 
                ? '<span class="badge bg-success">目前系統學期</span>' 
                : '<span class="badge bg-secondary">存檔</span>';
            
            // 計算是否有資料
            const elemCount = weeks.filter(w => w.semester_id === s.id && w.department_type === 'elem').length;
            const highCount = weeks.filter(w => w.semester_id === s.id && w.department_type === 'high').length;

            const btnStyle = (cnt) => cnt > 0 ? 'btn-outline-success' : 'btn-outline-secondary text-muted';
            const btnIcon = (cnt) => cnt > 0 ? '<i class="bi bi-check-circle-fill"></i>' : '<i class="bi bi-dash-circle"></i>';
            const btnText = (cnt) => cnt > 0 ? `已設定 (${cnt}週)` : '未設定';

            tbody.innerHTML += `
                <tr>
                    <td class="font-monospace fw-bold ps-3">${s.semester_code}</td>
                    <td>${s.name}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm ${btnStyle(elemCount)} week-btn" onclick="openWeekModal(${s.id}, 'elem', '${s.semester_code} 國小部')">
                            ${btnIcon(elemCount)} ${btnText(elemCount)}
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm ${btnStyle(highCount)} week-btn" onclick="openWeekModal(${s.id}, 'high', '${s.semester_code} 國(高)中部')">
                            ${btnIcon(highCount)} ${btnText(highCount)}
                        </button>
                    </td>
                    <td class="text-end pe-3">
                        <button class="btn btn-sm btn-outline-primary" onclick='openEditModal(${JSON.stringify(s)})'><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="delSem('${s.id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    // --- 學期 CRUD ---
    window.openEditModal = (data = null) => {
        document.getElementById('editId').value = data ? data.id : '';
        document.getElementById('m_code').value = data ? data.semester_code : '';
        document.getElementById('m_name').value = data ? data.name : '';
        document.getElementById('m_status').value = data ? data.status : 'archive';
        semModal.show();
    }

    window.saveSemester = async () => {
        const id = document.getElementById('editId').value;
        const payload = {
            semester_code: document.getElementById('m_code').value,
            name: document.getElementById('m_name').value,
            status: document.getElementById('m_status').value
        };
        if (!payload.semester_code || !payload.name) return Swal.fire('欄位未填', '', 'warning');
        
        if (payload.status === 'current') await window.db.from('semesters').update({ status: 'archive' }).neq('id', 0);
        
        let error;
        if (id) error = (await window.db.from('semesters').update(payload).eq('id', id)).error;
        else error = (await window.db.from('semesters').insert([payload])).error;
        
        if (error) Swal.fire('失敗', error.message, 'error'); else { semModal.hide(); loadSemesters(); Swal.fire('成功', '資料已更新', 'success'); }
    }

    window.delSem = async (id) => {
        if((await Swal.fire({title:'確定刪除？',icon:'warning',showCancelButton:true})).isConfirmed) {
            await window.db.from('semesters').delete().eq('id', id); loadSemesters();
        }
    }

    // --- 週次管理邏輯 (整合進來) ---
    window.openWeekModal = async (semId, type, title) => {
        document.getElementById('wk_sem_id').value = semId;
        document.getElementById('wk_dept_type').value = type;
        document.getElementById('wk_title_display').textContent = title;
        
        // 載入資料庫現有資料
        const { data } = await window.db.from('semester_weeks')
            .select('*')
            .eq('semester_id', semId)
            .eq('department_type', type)
            .order('week_number');

        currentWeeksData = data || [];
        
        // 如果有資料，自動填入開學日供參考 (取第一週開始日)
        if(currentWeeksData.length > 0) {
            document.getElementById('startDate').value = currentWeeksData[0].start_date;
            document.getElementById('weekCount').value = currentWeeksData.length;
        } else {
            document.getElementById('startDate').value = '';
        }

        renderWeekTable();
        weekModal.show();
    }

    window.generateWeeks = () => {
        const startStr = document.getElementById('startDate').value;
        const count = parseInt(document.getElementById('weekCount').value);
        if(!startStr) { Swal.fire('請選擇開學日', '', 'warning'); return; }

        let startDate = new Date(startStr);
        // 校正為該週週一
        const day = startDate.getDay();
        const diff = startDate.getDate() - day + (day == 0 ? -6 : 1); 
        startDate.setDate(diff);

        currentWeeksData = [];
        for(let i=1; i<=count; i++) {
            let end = new Date(startDate);
            end.setDate(startDate.getDate() + 6); 
            currentWeeksData.push({
                week_number: i,
                start_date: startDate.toISOString().split('T')[0],
                end_date: end.toISOString().split('T')[0],
                note: ''
            });
            startDate.setDate(startDate.getDate() + 7);
        }
        renderWeekTable();
    }

    function renderWeekTable() {
        const tbody = document.getElementById('weekListBody');
        tbody.innerHTML = '';
        if(currentWeeksData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">請設定開學日並產生週次</td></tr>';
            return;
        }
        currentWeeksData.forEach((w, idx) => {
            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold text-muted">第 ${w.week_number} 週</td>
                    <td><input type="date" value="${w.start_date}" onchange="updateWk(${idx}, 'start_date', this.value)"></td>
                    <td><input type="date" value="${w.end_date}" onchange="updateWk(${idx}, 'end_date', this.value)"></td>
                    <td><input type="text" value="${w.note||''}" placeholder="無" onchange="updateWk(${idx}, 'note', this.value)"></td>
                </tr>
            `;
        });
    }

    window.updateWk = (idx, field, val) => { currentWeeksData[idx][field] = val; }

    window.saveWeeks = async () => {
        const semId = document.getElementById('wk_sem_id').value;
        const type = document.getElementById('wk_dept_type').value;
        if(currentWeeksData.length === 0) { Swal.fire('無資料', '', 'warning'); return; }

        // 先刪後加
        await window.db.from('semester_weeks').delete().eq('semester_id', semId).eq('department_type', type);
        
        const payload = currentWeeksData.map(w => ({
            semester_id: semId,
            department_type: type,
            week_number: w.week_number,
            start_date: w.start_date,
            end_date: w.end_date,
            note: w.note
        }));

        const { error } = await window.db.from('semester_weeks').insert(payload);
        if(error) Swal.fire('失敗', error.message, 'error');
        else { weekModal.hide(); loadSemesters(); Swal.fire('成功', '週次已更新', 'success'); }
    }
</script>
</body>
</html>
