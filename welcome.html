<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統首頁</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; padding: 30px; font-family: 'Microsoft JhengHei', sans-serif; }
        
        .announcement-card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: white; overflow: hidden; }
        .card-header { background-color: white; border-bottom: 2px solid #f0f2f5; padding: 20px 25px; display: flex; align-items: center; justify-content: space-between; }
        
        .list-group-item { border: none; border-bottom: 1px solid #f0f2f5; padding: 15px 25px; transition: background-color 0.2s; cursor: pointer; }
        .list-group-item:hover { background-color: #f8f9fa; }
        .list-group-item:last-child { border-bottom: none; }
        
        /* 分類標籤顏色 */
        .badge-sys { background-color: #0d6efd; }
        .badge-edu { background-color: #198754; }
        .badge-urg { background-color: #dc3545; }
        .badge-gen { background-color: #6c757d; }
        
        .pinned-icon { color: #dc3545; transform: rotate(45deg); display: inline-block; margin-right: 5px; }
        .date-text { font-size: 0.85rem; color: #adb5bd; min-width: 100px; text-align: right; }
        .title-text { font-weight: bold; color: #343a40; font-size: 1.05rem; }
        
        .welcome-section { margin-bottom: 30px; }
        .welcome-title { font-weight: bold; color: #343a40; }
    </style>
</head>
<body>

<div class="container">
    <div class="welcome-section">
        <h2 class="welcome-title"><i class="bi bi-sun-fill text-warning me-2"></i> 早安，歡迎回來！</h2>
        <p class="text-muted" id="dateDisplay">載入中...</p>
    </div>

    <div class="card announcement-card">
        <div class="card-header">
            <h5 class="mb-0 fw-bold"><i class="bi bi-megaphone-fill text-primary me-2"></i> 最新公告</h5>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="newsList">
                <div class="text-center py-5 text-muted"><span class="spinner-border spinner-border-sm text-primary"></span> 讀取中...</div>
            </div>
        </div>
    </div>
</div>

<script src="js/config.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        updateDate();
        loadAnnouncements();
    });

    function updateDate() {
        const now = new Date();
        const opts = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('dateDisplay').textContent = `今天是 ${now.toLocaleDateString('zh-TW', opts)}`;
    }

    async function loadAnnouncements() {
        // 改為讀取 announcements 表
        const { data, error } = await window.db.from('announcements')
            .select('*')
            .order('is_pinned', { ascending: false })
            .order('publish_date', { ascending: false })
            .limit(10);

        const list = document.getElementById('newsList');
        list.innerHTML = '';

        if (error || !data || data.length === 0) {
            list.innerHTML = `<div class="p-5 text-center text-muted"><i class="bi bi-inbox fs-1 d-block mb-2"></i> 目前沒有公告</div>`;
            return;
        }

        data.forEach(item => {
            let badgeClass = 'badge-gen';
            if(item.category === '系統') badgeClass = 'badge-sys';
            if(item.category === '教務') badgeClass = 'badge-edu';
            if(item.category === '緊急') badgeClass = 'badge-urg';

            const pinHtml = item.is_pinned ? `<i class="bi bi-pin-angle-fill pinned-icon"></i>` : '';
            const attachIcon = item.attachment_url ? `<i class="bi bi-paperclip text-muted ms-2" title="有附件"></i>` : '';
            
            // 安全處理標題
            const safeTitle = (item.title || '(無標題)').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            list.innerHTML += `
                <div class="list-group-item d-flex align-items-center justify-content-between" onclick="showDetail('${item.id}')">
                    <div class="d-flex align-items-center text-truncate">
                        <span class="badge ${badgeClass} me-3 rounded-pill px-3">${item.category || '一般'}</span>
                        ${pinHtml}
                        <span class="title-text text-truncate">${safeTitle}</span>
                        ${attachIcon}
                    </div>
                    <div class="date-text d-none d-md-block">
                        <i class="bi bi-calendar3 me-1"></i> ${item.publish_date}
                    </div>
                </div>
            `;
        });
    }

    window.showDetail = async (id) => {
        const { data } = await window.db.from('announcements').select('*').eq('id', id).single();
        if(data) {
            let fileHtml = '';
            if (data.attachment_url) {
                fileHtml = `
                    <div class="alert alert-light border mt-3 d-flex align-items-center">
                        <i class="bi bi-file-earmark-arrow-down fs-4 text-primary me-3"></i>
                        <div>
                            <div class="fw-bold">附件下載</div>
                            <a href="${data.attachment_url}" target="_blank" class="text-decoration-none stretched-link">
                                ${data.attachment_name || '點擊下載檔案'}
                            </a>
                        </div>
                    </div>
                `;
            }

            Swal.fire({
                title: data.title,
                html: `
                    <div class="text-start px-2">
                        <div class="mb-3 text-muted small">
                            <span class="badge bg-secondary me-2">${data.category || '一般'}</span> 
                            發布日期：${data.publish_date}
                        </div>
                        <div style="line-height: 1.8; white-space: pre-wrap; font-size: 1.05rem;">${data.content || ''}</div>
                        ${fileHtml}
                    </div>
                `,
                width: 700,
                confirmButtonText: '關閉',
                confirmButtonColor: '#6c757d'
            });
        }
    }
</script>
</body>
</html>
//表
