<div class="row mt-5">
        <div class="col-md-10 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>最新系統公告</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadNews()">重新整理</button>
                </div>
                <ul class="list-group list-group-flush" id="newsList">
                    <li class="list-group-item text-center text-muted py-4">正在載入公告...</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="js/config.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 顯示使用者名稱 (原本的功能)
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (user && user.name) {
        document.getElementById('welcomeName').textContent = "歡迎回來，" + user.name + " 老師";
    }

    // ▼▼▼ 新增：載入最新公告 ▼▼▼
    async function loadNews() {
        const list = document.getElementById('newsList');
        
        // 抓取最新的 5 筆公告
        const { data: news, error } = await db
            .from('announcements')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(5);

        if (error) {
            list.innerHTML = '<li class="list-group-item text-danger">載入失敗</li>';
            return;
        }

        if (news.length === 0) {
            list.innerHTML = '<li class="list-group-item text-muted text-center">目前沒有任何公告</li>';
            return;
        }

        list.innerHTML = ''; // 清空載入中訊息

        news.forEach(item => {
            // 計算是不是 "New" (3天內發布的)
            const created = new Date(item.created_at);
            const now = new Date();
            const diffTime = Math.abs(now - created);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            let badgeHtml = '';
            if (diffDays <= 3) {
                badgeHtml = '<span class="badge bg-danger rounded-pill ms-2">New</span>';
            }

            // 分類標籤樣式
            let catColor = 'text-secondary';
            if(item.category === '系統公告') catColor = 'text-dark fw-bold';
            if(item.category === '教務通知') catColor = 'text-primary';
            if(item.category === '學務通知') catColor = 'text-success';

            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-light ${catColor} me-2">${item.category}</span>
                        ${item.title}
                        ${badgeHtml}
                    </div>
                    <small class="text-muted">${item.created_at.split('T')[0]}</small>
                </li>
            `;
        });
    }

    // 啟動載入
    loadNews();
</script>
