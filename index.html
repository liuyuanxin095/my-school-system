<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚åœ‹å° - æ ¡å‹™æ•´åˆç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ================= å…¨å±€è¨­å®š (æ–‡å­—é¢¨æ ¼) ================= */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        /* é€šç”¨å®¹å™¨ */
        .container { background: white; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 40px; }
        
        /* 1. ç™»å…¥æ¡† (å›ºå®šå¤§å°) */
        .login-box { width: 350px; height: 320px; display: flex; flex-direction: column; justify-content: center; }

        /* 2. ä¸»é¸å–® (å¯¬æ•ä½ˆå±€) */
        .menu-box { width: 800px; text-align: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .menu-card { border: 1px solid #ddd; padding: 20px; cursor: pointer; transition: 0.2s; text-align: left; }
        .menu-card:hover { border-color: #3498db; background-color: #f8fbff; transform: translateY(-2px); }
        .menu-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .menu-item { font-size: 14px; color: #666; margin: 5px 0; padding-left: 10px; }

        /* 3. ç³»çµ±åŠŸèƒ½é é¢ (å…¨å¯¬) */
        .system-box { width: 90%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column; }
        
        /* æ¨™é¡Œåˆ— */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 24px; color: #333; }
        .version { font-size: 12px; background: #333; color: white; padding: 2px 6px; border-radius: 2px; }

        /* è¡¨å–®å…ƒä»¶ */
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 2px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }

        /* æŒ‰éˆ•ç³»çµ± (æ–‡å­—ç‚ºä¸») */
        .btn { padding: 8px 16px; border: none; cursor: pointer; font-size: 14px; border-radius: 2px; transition: 0.2s; }
        .btn-primary { background-color: #0056b3; color: white; }
        .btn-success { background-color: #198754; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn:hover { opacity: 0.9; }

        /* è¡¨æ ¼å„ªåŒ– */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 10px; text-align: left; font-weight: bold; color: #495057; }
        td { border-bottom: 1px solid #dee2e6; padding: 10px; color: #212529; }
        tr:hover { background-color: #f8f9fa; }

        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .page { display: none; }
        .active { display: block; } /* ç™»å…¥é ç‰¹æ®Šè™•ç† */
        .active-flex { display: flex; } /* ç™»å…¥æ¡†ç”¨ */

        /* -------------------------------------------
           ğŸ”¥ è©³ç´°è³‡æ–™ç·¨è¼¯è¦–çª— (Modal Form)
           ------------------------------------------- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-form { background: white; width: 600px; padding: 30px; border-radius: 4px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-label { font-size: 13px; color: #666; font-weight: bold; display: block; margin-bottom: 3px; }
        .full-width { grid-column: span 2; }
    </style>
</head>
<body>

    <div id="page-login" class="container login-box active-flex">
        <h2 style="text-align: center; margin-bottom: 20px;">æ ¡å‹™æ•´åˆç³»çµ± <span class="version">v8.0</span></h2>
        <input type="email" id="emailInput" placeholder="å¸³è™Ÿ (Email)">
        <input type="password" id="passwordInput" placeholder="å¯†ç¢¼">
        <button class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 10px;" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
        <p id="msg" style="color: red; text-align: center; font-size: 12px; margin-top: 10px;"></p>
    </div>

    <div id="page-menu" class="container menu-box page">
        <div class="header">
            <h1>ç³»çµ±åŠŸèƒ½é¸å–®</h1>
            <button class="btn btn-secondary" onclick="handleLogout()">ç™»å‡º</button>
        </div>
        <p>æ­¡è¿ä½¿ç”¨ï¼Œ<span id="currentUser"></span>ã€‚è«‹é¸æ“‡æ¬²åŸ·è¡Œçš„æ¨¡çµ„ï¼š</p>

        <div class="menu-grid">
            <div class="menu-card" onclick="navTo('page-academic')">
                <div class="menu-title">æ•™å‹™ç³»çµ±</div>
                <div class="menu-item">â–ª å­¸ç”Ÿå­¸ç±è³‡æ–™è™•ç†</div>
                <div class="menu-item">â–ª å­¸ç”Ÿæˆç¸¾ç®¡ç†</div>
                <div class="menu-item">â–ª é›²ç«¯æ’èª²/èª¿èª²</div>
            </div>

            <div class="menu-card" onclick="alert('å­¸å‹™ç³»çµ±å»ºç½®ä¸­...')">
                <div class="menu-title">å­¸å‹™ç³»çµ±</div>
                <div class="menu-item">â–ª ç·šä¸Šé»åç³»çµ±</div>
                <div class="menu-item">â–ª å­¸ç”Ÿè«‹å‡ç®¡ç†</div>
                <div class="menu-item">â–ª çæ‡²ç™»éŒ„</div>
            </div>

            <div class="menu-card" onclick="alert('äººäº‹ç³»çµ±å»ºç½®ä¸­...')">
                <div class="menu-title">äººäº‹ç³»çµ±</div>
                <div class="menu-item">â–ª äººè³‡ç®¡ç†</div>
                <div class="menu-item">â–ª ç·šä¸Šè€ƒå‹¤</div>
                <div class="menu-item">â–ª é˜é»è¨ˆç®—</div>
            </div>
        </div>
    </div>

    <div id="page-academic" class="container system-box page">
        <div class="header">
            <div>
                <h1>å­¸ç”Ÿå­¸ç±è³‡æ–™è™•ç†</h1>
                <span style="font-size: 14px; color: #666;">æ•™å‹™ç³»çµ± > å­¸ç±ç®¡ç†</span>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="navTo('page-menu')">å›ä¸»é¸å–®</button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px;">
            <div style="flex: 1;">
                <select id="filterClass" onchange="fetchStudents()" style="width: 150px;">
                    <option value="ALL">å…¨éƒ¨ç­ç´š</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="openModal('add')">+ æ–°å¢å­¸ç”Ÿè³‡æ–™</button>
        </div>

        <div style="flex: 1; overflow-y: auto;">
            <table id="studentTable">
                <thead>
                    <tr>
                        <th>ç­ç´š</th>
                        <th>å­¸è™Ÿ</th>
                        <th>å§“å</th>
                        <th>æ€§åˆ¥</th>
                        <th>ç§‘åˆ¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="studentModal" class="modal-overlay">
        <div class="modal-form">
            <h3 id="modalTitle" style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">ç·¨è¼¯è³‡æ–™</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">ç­ç´š</label>
                    <input type="text" id="editClass">
                </div>
                <div class="form-group">
                    <label class="form-label">å­¸è™Ÿ</label>
                    <input type="text" id="editId">
                </div>

                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" id="editName">
                </div>
                <div class="form-group">
                    <label class="form-label">æ€§åˆ¥</label>
                    <select id="editGender">
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ç§‘åˆ¥</label>
                    <select id="editDept">
                        <option value="å¹¼å…’åœ’">å¹¼å…’åœ’</option>
                        <option value="åœ‹å°">åœ‹å°</option>
                        <option value="åœ‹ä¸­">åœ‹ä¸­</option>
                        <option value="é«˜ä¸­">é«˜ä¸­</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å…¥å­¸å¹´åº¦</label>
                    <input type="number" id="editYear">
                </div>

                <div class="form-group">
                    <label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label>
                    <input type="text" id="editNationalId">
                </div>
                <div class="form-group">
                    <label class="form-label">ç”Ÿæ—¥</label>
                    <input type="date" id="editBirthday">
                </div>

                <div class="form-group full-width">
                    <label class="form-label">å®¶åº­ç›¸é—œè³‡æ–™ (ç›£è­·äººã€é›»è©±ã€åœ°å€ç­‰)</label>
                    <textarea id="editFamily"></textarea>
                </div>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveStudentData()">å„²å­˜ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”¥ğŸ”¥ğŸ”¥ è¨­å®šå€ ğŸ”¥ğŸ”¥ğŸ”¥
        const supabaseUrl = 'https://blzkbhjjoqylinywxtyy.supabase.co';
        const supabaseKey = 'sb_publishable_k5DR0vYzR9-GKrHoysRFjA_iTMlJPjh';
        // =======================

        const db = supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentMode = 'add'; // 'add' æˆ– 'edit'
        let currentEditingDbId = null; // è³‡æ–™åº«çš„ id

        // === ç³»çµ±å°èˆªé‚è¼¯ ===
        function navTo(pageId) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.container').forEach(el => {
                el.classList.remove('active', 'active-flex');
                el.classList.add('page');
            });

            // é¡¯ç¤ºç›®æ¨™é é¢
            const target = document.getElementById(pageId);
            target.classList.remove('page');
            
            if (pageId === 'page-login') target.classList.add('active-flex'); // ç™»å…¥é è¦ç½®ä¸­
            else target.classList.add('active');

            if (pageId === 'page-academic') fetchStudents(); // é€²å…¥æ•™å‹™ç³»çµ±è‡ªå‹•æŠ“è³‡æ–™
        }

        // === ç™»å…¥æµç¨‹ ===
        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            
            if (error) {
                document.getElementById('msg').innerText = "ç™»å…¥å¤±æ•—ï¼š" + error.message;
            } else {
                document.getElementById('currentUser').innerText = data.user.email;
                navTo('page-menu'); // ç™»å…¥æˆåŠŸï¼Œè·³è½‰åˆ°ä¸»é¸å–®
            }
        }

        async function handleLogout() {
            await db.auth.signOut();
            location.reload();
        }

        // === æ•™å‹™ç³»çµ±é‚è¼¯ ===
        async function fetchStudents() {
            const filterClass = document.getElementById('filterClass').value;
            
            let query = db.from('students').select('*').order('class_name', { ascending: true }).order('student_id', { ascending: true });
            
            if (filterClass !== 'ALL') {
                query = query.eq('class_name', filterClass);
            }

            const { data, error } = await query;
            if (error) { console.error(error); return; }

            // æ›´æ–°ç­ç´šé¸å–®
            updateClassOptions(data);
            
            // æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.class_name || '-'}</td>
                        <td>${s.student_id}</td>
                        <td>${s.name}</td>
                        <td>${s.gender || ''}</td>
                        <td>${s.department || ''}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="prepareEdit('${s.id}')">ç·¨è¼¯è©³æƒ…</button>
                        </td>
                    </tr>
                `;
            });
            // æš«å­˜è³‡æ–™ä¾›ç·¨è¼¯ä½¿ç”¨
            window.allStudents = data;
        }

        function updateClassOptions(data) {
            const select = document.getElementById('filterClass');
            const current = select.value;
            const classes = [...new Set(data.map(s => s.class_name).filter(c => c))];
            
            select.innerHTML = '<option value="ALL">å…¨éƒ¨ç­ç´š</option>';
            classes.forEach(c => {
                select.innerHTML += `<option value="${c}">${c}</option>`;
            });
            if (classes.includes(current)) select.value = current;
        }

        // === ç·¨è¼¯/æ–°å¢è¦–çª—é‚è¼¯ ===
        function openModal(mode) {
            currentMode = mode;
            document.getElementById('studentModal').style.display = 'flex';
            
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = 'æ–°å¢å­¸ç”Ÿè³‡æ–™';
                // æ¸…ç©ºæ¬„ä½
                document.querySelectorAll('#studentModal input, #studentModal select, #studentModal textarea').forEach(el => el.value = '');
            } else {
                document.getElementById('modalTitle').innerText = 'ç·¨è¼¯å­¸ç”Ÿè³‡æ–™';
            }
        }

        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        function prepareEdit(dbId) {
            const student = window.allStudents.find(s => s.id == dbId);
            if (!student) return;

            currentEditingDbId = dbId;
            
            // å¡«å…¥è³‡æ–™åˆ°è¦–çª—
            document.getElementById('editClass').value = student.class_name || '';
            document.getElementById('editId').value = student.student_id || '';
            document.getElementById('editName').value = student.name || '';
            document.getElementById('editGender').value = student.gender || 'ç”·';
            document.getElementById('editDept').value = student.department || 'åœ‹å°';
            document.getElementById('editYear').value = student.admission_year || '';
            document.getElementById('editNationalId').value = student.national_id || '';
            document.getElementById('editBirthday').value = student.birthday || '';
            document.getElementById('editFamily').value = student.family_info || '';

            openModal('edit');
        }

        async function saveStudentData() {
            const newData = {
                class_name: document.getElementById('editClass').value,
                student_id: document.getElementById('editId').value,
                name: document.getElementById('editName').value,
                gender: document.getElementById('editGender').value,
                department: document.getElementById('editDept').value,
                admission_year: document.getElementById('editYear').value,
                national_id: document.getElementById('editNationalId').value,
                birthday: document.getElementById('editBirthday').value || null, // æ—¥æœŸç©ºå€¼è™•ç†
                family_info: document.getElementById('editFamily').value
            };

            if (!newData.student_id || !newData.name) {
                alert('å­¸è™Ÿèˆ‡å§“åç‚ºå¿…å¡«ï¼');
                return;
            }

            let error;
            if (currentMode === 'add') {
                const res = await db.from('students').insert(newData);
                error = res.error;
            } else {
                const res = await db.from('students').update(newData).eq('id', currentEditingDbId);
                error = res.error;
            }

            if (error) {
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            } else {
                alert('å„²å­˜æˆåŠŸï¼');
                closeModal();
                fetchStudents();
            }
        }

    </script>
</body>
</html>
