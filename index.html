<script>
    // ... (保留原本的 user 檢查與 logout 程式碼) ...

    // ▼▼▼ 新增這個函式來動態生成選單 ▼▼▼
    async function renderDynamicMenu() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) return;

        // 1. 從資料庫撈取所有啟用選單
        const { data: allMenus } = await window.db
            .from('system_menus')
            .select('*')
            .eq('is_active', true)
            .order('sort_order', { ascending: true });

        if (!allMenus) return;

        const menuContainer = document.getElementById('menuAccordion');
        menuContainer.innerHTML = ''; // 清空目前內容

        // 2. 篩選權限 (只留下此角色能看到的)
        const allowedMenus = allMenus.filter(m => 
            !m.allowed_roles || m.allowed_roles.includes(user.role)
        );

        // 3. 分離父層與子層
        const parents = allowedMenus.filter(m => !m.parent_id);

        // 4. 產生 HTML
        parents.forEach(parent => {
            const children = allowedMenus.filter(m => m.parent_id === parent.id);
            
            if (children.length > 0) {
                // === 情況 A: 折疊式選單 (有子項目) ===
                const collapseId = `menu-${parent.id}`;
                const html = `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <i class="bi ${parent.icon || 'bi-folder'} me-2"></i> ${parent.title}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                            ${children.map(child => `
                                <a href="${child.link}" target="content-frame" class="submenu-link" onclick="handleMenuClick(this)">
                                    ${child.title}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
                menuContainer.innerHTML += html;
            } else {
                // === 情況 B: 單一連結 (沒有子項目) ===
                // 如果父層自己有連結，就顯示；如果是空目錄則不顯示
                if (parent.link) {
                    const html = `
                        <div class="accordion-item">
                            <a href="${parent.link}" target="content-frame" class="menu-btn" onclick="handleMenuClick(this)">
                                <i class="bi ${parent.icon || 'bi-link'} me-2"></i> ${parent.title}
                            </a>
                        </div>
                    `;
                    menuContainer.innerHTML += html;
                }
            }
        });
        
        // 最後加一點底部留白
        menuContainer.innerHTML += '<div style="height: 20px;"></div>';
    }

    // 在頁面載入時執行
    document.addEventListener('DOMContentLoaded', () => {
        renderDynamicMenu();
    });
</script>
