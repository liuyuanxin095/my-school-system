<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚åœ‹å° - æ ¡å‹™æ•´åˆç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ================= å…¨å±€è¨­å®š ================= */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 40px; }
        
        /* 1. ç™»å…¥æ¡† */
        .login-box { width: 350px; height: 320px; display: flex; flex-direction: column; justify-content: center; }

        /* 2. ä¸»é¸å–® */
        .menu-box { width: 800px; text-align: center; }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .menu-card { border: 1px solid #ddd; padding: 20px; cursor: pointer; transition: 0.2s; text-align: left; }
        .menu-card:hover { border-color: #3498db; background-color: #f8fbff; transform: translateY(-2px); }
        .menu-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .menu-item { font-size: 14px; color: #666; margin: 5px 0; padding-left: 10px; }

        /* 3. ç³»çµ±åŠŸèƒ½é é¢ */
        .system-box { width: 90%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 24px; color: #333; }
        .version { font-size: 12px; background: #d35400; color: white; padding: 2px 6px; border-radius: 2px; } /* V9 æ”¹æ©˜ç´…è‰² */

        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 2px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }

        .btn { padding: 8px 16px; border: none; cursor: pointer; font-size: 14px; border-radius: 2px; transition: 0.2s; }
        .btn-primary { background-color: #0056b3; color: white; }
        .btn-success { background-color: #198754; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-warning { background-color: #fd7e14; color: white; } /* åŒ¯å…¥æŒ‰éˆ• */
        .btn:hover { opacity: 0.9; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 10px; text-align: left; font-weight: bold; color: #495057; }
        td { border-bottom: 1px solid #dee2e6; padding: 10px; color: #212529; }
        tr:hover { background-color: #f8f9fa; }

        .page { display: none; }
        .active { display: block; }
        .active-flex { display: flex; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-form { background: white; width: 600px; padding: 30px; border-radius: 4px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-label { font-size: 13px; color: #666; font-weight: bold; display: block; margin-bottom: 3px; }
        .full-width { grid-column: span 2; }

        /* åŒ¯å…¥å°ˆç”¨æ¨£å¼ */
        .import-area { width: 100%; height: 200px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ccc; background: #fdfdfd; }
        .hint-text { font-size: 12px; color: #666; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px; line-height: 1.6; }
    </style>
</head>
<body>

    <div id="page-login" class="container login-box active-flex">
        <h2 style="text-align: center; margin-bottom: 20px;">æ ¡å‹™æ•´åˆç³»çµ± <span class="version">v9.0</span></h2>
        <input type="email" id="emailInput" placeholder="å¸³è™Ÿ (Email)">
        <input type="password" id="passwordInput" placeholder="å¯†ç¢¼">
        <button class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 10px;" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
        <p id="msg" style="color: red; text-align: center; font-size: 12px; margin-top: 10px;"></p>
    </div>

    <div id="page-menu" class="container menu-box page">
        <div class="header">
            <h1>ç³»çµ±åŠŸèƒ½é¸å–®</h1>
            <button class="btn btn-secondary" onclick="handleLogout()">ç™»å‡º</button>
        </div>
        <p>æ­¡è¿ä½¿ç”¨ï¼Œ<span id="currentUser"></span>ã€‚è«‹é¸æ“‡æ¬²åŸ·è¡Œçš„æ¨¡çµ„ï¼š</p>
        <div class="menu-grid">
            <div class="menu-card" onclick="navTo('page-academic')">
                <div class="menu-title">æ•™å‹™ç³»çµ±</div>
                <div class="menu-item">â–ª å­¸ç”Ÿå­¸ç±è³‡æ–™è™•ç†</div>
                <div class="menu-item">â–ª å­¸ç”Ÿæˆç¸¾ç®¡ç†</div>
                <div class="menu-item">â–ª é›²ç«¯æ’èª²/èª¿èª²</div>
            </div>
            <div class="menu-card" onclick="alert('å­¸å‹™ç³»çµ±å»ºç½®ä¸­...')">
                <div class="menu-title">å­¸å‹™ç³»çµ±</div>
                <div class="menu-item">â–ª ç·šä¸Šé»åç³»çµ±</div>
                <div class="menu-item">â–ª å­¸ç”Ÿè«‹å‡ç®¡ç†</div>
            </div>
            <div class="menu-card" onclick="alert('äººäº‹ç³»çµ±å»ºç½®ä¸­...')">
                <div class="menu-title">äººäº‹ç³»çµ±</div>
                <div class="menu-item">â–ª äººè³‡ç®¡ç†</div>
                <div class="menu-item">â–ª ç·šä¸Šè€ƒå‹¤</div>
            </div>
        </div>
    </div>

    <div id="page-academic" class="container system-box page">
        <div class="header">
            <div>
                <h1>å­¸ç”Ÿå­¸ç±è³‡æ–™è™•ç†</h1>
                <span style="font-size: 14px; color: #666;">æ•™å‹™ç³»çµ± > å­¸ç±ç®¡ç†</span>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="navTo('page-menu')">å›ä¸»é¸å–®</button>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px;">
            <div style="flex: 1;">
                <select id="filterClass" onchange="fetchStudents()" style="width: 150px;">
                    <option value="ALL">å…¨éƒ¨ç­ç´š</option>
                </select>
            </div>
            <button class="btn btn-warning" onclick="openImportModal()">ğŸ“‚ åŒ¯å…¥ Excel è³‡æ–™</button>
            <button class="btn btn-success" onclick="openModal('add')">+ æ–°å¢å­¸ç”Ÿè³‡æ–™</button>
        </div>
        <div style="flex: 1; overflow-y: auto;">
            <table id="studentTable">
                <thead>
                    <tr>
                        <th>ç­ç´š</th>
                        <th>å­¸è™Ÿ</th>
                        <th>å§“å</th>
                        <th>æ€§åˆ¥</th>
                        <th>ç§‘åˆ¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="studentModal" class="modal-overlay">
        <div class="modal-form">
            <h3 id="modalTitle" style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">ç·¨è¼¯è³‡æ–™</h3>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">ç­ç´š</label><input type="text" id="editClass"></div>
                <div class="form-group"><label class="form-label">å­¸è™Ÿ</label><input type="text" id="editId"></div>
                <div class="form-group"><label class="form-label">å§“å</label><input type="text" id="editName"></div>
                <div class="form-group"><label class="form-label">æ€§åˆ¥</label>
                    <select id="editGender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
                </div>
                <div class="form-group"><label class="form-label">ç§‘åˆ¥</label>
                    <select id="editDept"><option value="å¹¼å…’åœ’">å¹¼å…’åœ’</option><option value="åœ‹å°">åœ‹å°</option><option value="åœ‹ä¸­">åœ‹ä¸­</option><option value="é«˜ä¸­">é«˜ä¸­</option></select>
                </div>
                <div class="form-group"><label class="form-label">å…¥å­¸å¹´åº¦</label><input type="number" id="editYear"></div>
                <div class="form-group"><label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="editNationalId"></div>
                <div class="form-group"><label class="form-label">ç”Ÿæ—¥</label><input type="date" id="editBirthday"></div>
                <div class="form-group full-width"><label class="form-label">å®¶åº­è³‡æ–™</label><textarea id="editFamily"></textarea></div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('studentModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveStudentData()">å„²å­˜ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal-overlay">
        <div class="modal-form" style="width: 700px;">
            <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">æ‰¹æ¬¡åŒ¯å…¥å­¸ç”Ÿè³‡æ–™</h3>
            
            <div class="hint-text">
                <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                1. è«‹åœ¨ Excel ä¸­æ•´ç†å¥½è³‡æ–™ï¼Œæ¬„ä½é †åºå¿…é ˆç‚ºï¼š<br>
                <span style="color: #d35400;">[ç­ç´š] [å­¸è™Ÿ] [å§“å] [æ€§åˆ¥] [ç§‘åˆ¥] [å…¥å­¸å¹´] [èº«åˆ†è­‰] [ç”Ÿæ—¥] [å®¶åº­è³‡æ–™]</span><br>
                2. é¸å– Excel ä¸­çš„å…§å®¹ (ä¸å«æ¨™é¡Œåˆ—)ï¼Œè¤‡è£½ (Ctrl+C)ã€‚<br>
                3. åœ¨ä¸‹æ–¹æ–‡å­—æ¡†è²¼ä¸Š (Ctrl+V)ã€‚
            </div>

            <textarea id="importText" class="import-area" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š Excel è³‡æ–™...&#10;101	S001	ç‹å°æ˜	ç”·	åœ‹å°	112	A123...	2015-01-01	å®¶é•·:ç‹å¤§æ˜..."></textarea>
            
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">å–æ¶ˆ</button>
                <button class="btn btn-warning" onclick="processImport()">ğŸš€ é–‹å§‹åŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”¥ğŸ”¥ğŸ”¥ è¨­å®šå€ (è«‹ç¢ºèª URL èˆ‡ Key) ğŸ”¥ğŸ”¥ğŸ”¥
        const supabaseUrl = 'https://blzkbhjjoqylinywxtyy.supabase.co';
        const supabaseKey = 'sb_publishable_k5DR0vYzR9-GKrHoysRFjA_iTMlJPjh';
        // =======================

        const db = supabase.createClient(supabaseUrl, supabaseKey);
        let currentMode = 'add';
        let currentEditingDbId = null;

        // === å°èˆª ===
        function navTo(pageId) {
            document.querySelectorAll('.container').forEach(el => {
                el.classList.remove('active', 'active-flex');
                el.classList.add('page');
            });
            const target = document.getElementById(pageId);
            target.classList.remove('page');
            if (pageId === 'page-login') target.classList.add('active-flex');
            else target.classList.add('active');
            if (pageId === 'page-academic') fetchStudents();
        }

        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) document.getElementById('msg').innerText = "ç™»å…¥å¤±æ•—ï¼š" + error.message;
            else { document.getElementById('currentUser').innerText = data.user.email; navTo('page-menu'); }
        }

        async function handleLogout() { await db.auth.signOut(); location.reload(); }

        // === æ•™å‹™ç³»çµ± ===
        async function fetchStudents() {
            const filterClass = document.getElementById('filterClass').value;
            let query = db.from('students').select('*').order('class_name', { ascending: true }).order('student_id', { ascending: true });
            if (filterClass !== 'ALL') query = query.eq('class_name', filterClass);
            const { data, error } = await query;
            if (error) { console.error(error); return; }

            updateClassOptions(data);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach(s => {
                tbody.innerHTML += `<tr><td>${s.class_name||'-'}</td><td>${s.student_id}</td><td>${s.name}</td><td>${s.gender||''}</td><td>${s.department||''}</td><td><button class="btn btn-secondary" onclick="prepareEdit('${s.id}')">ç·¨è¼¯è©³æƒ…</button></td></tr>`;
            });
            window.allStudents = data;
        }

        function updateClassOptions(data) {
            const select = document.getElementById('filterClass');
            const current = select.value;
            const classes = [...new Set(data.map(s => s.class_name).filter(c => c))];
            select.innerHTML = '<option value="ALL">å…¨éƒ¨ç­ç´š</option>';
            classes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
            if (classes.includes(current)) select.value = current;
        }

        // === ç·¨è¼¯ Modal ===
        function openModal(mode) {
            currentMode = mode;
            document.getElementById('studentModal').style.display = 'flex';
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = 'æ–°å¢å­¸ç”Ÿè³‡æ–™';
                document.querySelectorAll('#studentModal input, #studentModal select, #studentModal textarea').forEach(el => el.value = '');
            } else {
                document.getElementById('modalTitle').innerText = 'ç·¨è¼¯å­¸ç”Ÿè³‡æ–™';
            }
        }

        function prepareEdit(dbId) {
            const s = window.allStudents.find(x => x.id == dbId);
            if (!s) return;
            currentEditingDbId = dbId;
            document.getElementById('editClass').value = s.class_name || '';
            document.getElementById('editId').value = s.student_id || '';
            document.getElementById('editName').value = s.name || '';
            document.getElementById('editGender').value = s.gender || 'ç”·';
            document.getElementById('editDept').value = s.department || 'åœ‹å°';
            document.getElementById('editYear').value = s.admission_year || '';
            document.getElementById('editNationalId').value = s.national_id || '';
            document.getElementById('editBirthday').value = s.birthday || '';
            document.getElementById('editFamily').value = s.family_info || '';
            openModal('edit');
        }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        async function saveStudentData() {
            const yearInput = document.getElementById('editYear').value;
            const validYear = yearInput === "" ? null : yearInput;

            const newData = {
                class_name: document.getElementById('editClass').value,
                student_id: document.getElementById('editId').value,
                name: document.getElementById('editName').value,
                gender: document.getElementById('editGender').value,
                department: document.getElementById('editDept').value,
                admission_year: validYear,
                national_id: document.getElementById('editNationalId').value,
                birthday: document.getElementById('editBirthday').value || null,
                family_info: document.getElementById('editFamily').value
            };

            if (!newData.student_id || !newData.name) { alert('å­¸è™Ÿèˆ‡å§“åç‚ºå¿…å¡«ï¼'); return; }

            let error;
            if (currentMode === 'add') { const res = await db.from('students').insert(newData); error = res.error; }
            else { const res = await db.from('students').update(newData).eq('id', currentEditingDbId); error = res.error; }

            if (error) alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            else { alert('å„²å­˜æˆåŠŸï¼'); closeModal('studentModal'); fetchStudents(); }
        }

        // === ğŸ”¥ V9.0 åŒ¯å…¥åŠŸèƒ½é‚è¼¯ ===
        function openImportModal() {
            document.getElementById('importText').value = ''; // æ¸…ç©º
            document.getElementById('importModal').style.display = 'flex';
        }

        async function processImport() {
            const rawText = document.getElementById('importText').value;
            if (!rawText.trim()) { alert("å…§å®¹æ˜¯ç©ºçš„å–”ï¼"); return; }

            // 1. æ‹†è§£æ¯ä¸€è¡Œ (Excel è¤‡è£½éä¾†æ˜¯ç”¨ \n æ›è¡Œ)
            const rows = rawText.trim().split('\n');
            const records = [];
            
            // 2. é€è¡Œåˆ†æ
            for (let row of rows) {
                // Excel æ¬„ä½æ˜¯ç”¨ \t (Tab) åˆ†éš”çš„
                const cols = row.split('\t');
                
                // ç°¡å–®é˜²å‘†ï¼šå¦‚æœä¸æ»¿ 3 å€‹æ¬„ä½ï¼Œå¯èƒ½æ˜¯æœ‰å•é¡Œçš„ç©ºè¡Œï¼Œè·³é
                if (cols.length < 3) continue;

                // å»ºç«‹è³‡æ–™ç‰©ä»¶ (å°æ‡‰è³‡æ–™åº«æ¬„ä½)
                // é †åºï¼šç­ç´š | å­¸è™Ÿ | å§“å | æ€§åˆ¥ | ç§‘åˆ¥ | å…¥å­¸å¹´ | èº«åˆ†è­‰ | ç”Ÿæ—¥ | å®¶åº­è³‡æ–™
                const record = {
                    class_name: cols[0]?.trim() || null,
                    student_id: cols[1]?.trim(),
                    name: cols[2]?.trim(),
                    gender: cols[3]?.trim() || null,
                    department: cols[4]?.trim() || null,
                    admission_year: cols[5]?.trim() === "" ? null : cols[5]?.trim(),
                    national_id: cols[6]?.trim() || null,
                    birthday: cols[7]?.trim() === "" ? null : cols[7]?.trim(), // æ—¥æœŸæ ¼å¼è¦å° (YYYY-MM-DD)
                    family_info: cols[8]?.trim() || null
                };

                // å­¸è™Ÿå§“åå¿…å¡«ï¼Œå¦å‰‡ä¸å­˜
                if (record.student_id && record.name) {
                    records.push(record);
                }
            }

            if (records.length === 0) { alert("æ²’æœ‰è®€å–åˆ°æœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼"); return; }

            if (confirm(`æº–å‚™åŒ¯å…¥ ${records.length} ç­†å­¸ç”Ÿè³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                const { error } = await db.from('students').insert(records);
                
                if (error) {
                    console.error(error);
                    alert("åŒ¯å…¥å¤±æ•—ï¼š" + error.message);
                } else {
                    alert(`æˆåŠŸåŒ¯å…¥ ${records.length} ç­†è³‡æ–™ï¼ğŸ‰`);
                    closeModal('importModal');
                    fetchStudents(); // é‡æ–°æ•´ç†åˆ—è¡¨
                }
            }
        }
    </script>
</body>
</html>
