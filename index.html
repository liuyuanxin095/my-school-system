<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚åœ‹å° - æ ¡å‹™ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* åŸºç¤è¨­å®šï¼šæ¥µç°¡é¢¨æ ¼ */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f7fa; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 600px; }
        
        /* æ¨™é¡Œèˆ‡ç‰ˆæœ¬è™Ÿ */
        h1 { color: #2c3e50; margin-bottom: 20px; display: flex; align-items: baseline; justify-content: center; gap: 10px; }
        .version-tag { font-size: 14px; color: #fff; background-color: #95a5a6; padding: 2px 8px; border-radius: 4px; vertical-align: middle; font-weight: normal; }

        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e0e0e0; border-radius: 6px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: #3498db; outline: none; }

        /* æŒ‰éˆ•å„ªåŒ–ï¼šæ‰å¹³åŒ–è¨­è¨ˆ */
        .btn { width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #2ecc71; }
        .btn-gray { background-color: #95a5a6; }
        
        /* è¡¨æ ¼å…§çš„å°æŒ‰éˆ• */
        .btn-sm { padding: 6px 12px; font-size: 14px; margin: 0 4px; width: auto; display: inline-block; }
        .btn-red { background-color: #e74c3c; }
        .btn-yellow { background-color: #f1c40f; color: #333; }

        #dashboard { display: none; }
        #loading { display: none; color: #7f8c8d; text-align: center; margin-top: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; color: #34495e; }
        th { background-color: #fafafa; color: #7f8c8d; font-weight: 600; }
        
        .add-box { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .add-box h3 { margin-top: 0; color: #2c3e50; font-size: 18px; margin-bottom: 15px; }

        /* =========================================
           ğŸ”¥ é‡é»ï¼šè‡ªè£½æµ®å‹•è¦–çª— (Modal) çš„ CSS
           ========================================= */
        .modal-overlay {
            display: none; /* å¹³å¸¸éš±è— */
            position: fixed; /* å›ºå®šåœ¨è¢å¹•ä¸Š */
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 350px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: popUp 0.3s ease-out; /* å½ˆå‡ºå‹•ç•« */
        }

        /* å½ˆå‡ºå‹•ç•«æ•ˆæœ */
        @keyframes popUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-btn-group { display: flex; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="login-page" class="container">
        <h1>æ ¡å‹™ç³»çµ±ç™»å…¥ <span class="version-tag">v5.0</span></h1>
        <p style="color: #7f8c8d; margin-bottom: 20px;">è«‹ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥</p>
        <input type="email" id="emailInput" placeholder="Email">
        <input type="password" id="passwordInput" placeholder="å¯†ç¢¼">
        <button class="btn btn-blue" onclick="handleLogin()">ç™»å…¥</button>
        <p id="loading">é©—è­‰ä¸­...</p>
    </div>

    <div id="dashboard" class="container">
        <h1>æ ¡å‹™ç®¡ç†å¾Œå° <span class="version-tag">v5.0</span></h1>
        
        <div class="add-box">
            <h3>æ–°å¢å­¸ç”Ÿè³‡æ–™</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newId" placeholder="å­¸è™Ÿ" style="flex: 1;">
                <input type="text" id="newName" placeholder="å§“å" style="flex: 1;">
                <input type="number" id="newScore" placeholder="æˆç¸¾" style="flex: 1;">
            </div>
            <button class="btn btn-green" onclick="addData()">ç¢ºèªæ–°å¢</button>
        </div>

        <h3>å­¸ç”Ÿåˆ—è¡¨</h3>
        <table id="studentTable">
            <thead>
                <tr>
                    <th>å­¸è™Ÿ</th>
                    <th>å§“å</th>
                    <th>æˆç¸¾</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <button class="btn btn-gray" onclick="handleLogout()" style="margin-top: 30px;">ç™»å‡ºç³»çµ±</button>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top: 0;">ä¿®æ”¹æˆç¸¾</h3>
            <p id="modalStudentName" style="color: #666; margin-bottom: 20px;">å­¸ç”Ÿå§“å</p>
            
            <input type="number" id="modalScoreInput" placeholder="è¼¸å…¥æ–°æˆç¸¾">
            
            <div class="modal-btn-group">
                <button class="btn btn-gray" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-blue" onclick="saveEdit()">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        // ==============================
        // è¨­å®šå€
        // ==============================
        const supabaseUrl = 'https://blzkbhjjoqylinywxtyy.supabase.co';
        const supabaseKey = 'sb_publishable_k5DR0vYzR9-GKrHoysRFjA_iTMlJPjh';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        // ç”¨ä¾†æš«å­˜ã€Œç¾åœ¨æ­£åœ¨ä¿®æ”¹å“ªä¸€å€‹å­¸ç”Ÿã€çš„ ID
        let currentEditingId = null;

        checkSession();

        async function checkSession() {
            const { data: { session } } = await db.auth.getSession();
            if (session) showDashboard();
        }

        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            document.getElementById('loading').style.display = 'block';

            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) {
                alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
                document.getElementById('loading').style.display = 'none';
            } else {
                showDashboard();
            }
        }

        async function handleLogout() {
            await db.auth.signOut();
            location.reload();
        }

        function showDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            fetchData();
        }

        async function fetchData() {
            const { data, error } = await db
                .from('students')
                .select('*')
                .order('student_id', { ascending: true });

            if (error) console.error(error);
            else {
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = ""; 
                data.forEach(s => {
                    tableBody.innerHTML += `
                    <tr>
                        <td>${s.student_id}</td>
                        <td>${s.name}</td>
                        <td><span style="font-weight:bold; color: #2c3e50;">${s.score}</span></td>
                        <td>
                            <button class="btn btn-sm btn-yellow" onclick="openModal('${s.id}', '${s.name}', '${s.score}')">ä¿®æ”¹</button>
                            <button class="btn btn-sm btn-red" onclick="deleteStudent('${s.id}', '${s.name}')">åˆªé™¤</button>
                        </td>
                    </tr>`;
                });
            }
        }

        async function addData() {
            const id = document.getElementById('newId').value;
            const name = document.getElementById('newName').value;
            const score = document.getElementById('newScore').value;
            if (!id || !name || !score) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }

            const { error } = await db.from('students').insert({ student_id: id, name: name, score: score });
            if (error) alert("æ–°å¢å¤±æ•—ï¼š" + error.message);
            else {
                document.getElementById('newId').value = '';
                document.getElementById('newName').value = '';
                document.getElementById('newScore').value = '';
                fetchData();
            }
        }

        async function deleteStudent(id, name) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${name} å—ï¼Ÿ`)) {
                const { error } = await db.from('students').delete().eq('id', id);
                if (!error) fetchData();
            }
        }

        // =========================================
        // ğŸ”¥ æ–°åŠŸèƒ½ï¼šæµ®å‹•è¦–çª—çš„æ§åˆ¶é‚è¼¯
        // =========================================

        // 1. æ‰“é–‹è¦–çª—
        function openModal(id, name, currentScore) {
            currentEditingId = id; // è¨˜ä½ç¾åœ¨è¦æ”¹èª°
            document.getElementById('modalStudentName').innerText = `æ­£åœ¨ä¿®æ”¹ï¼š${name}`;
            document.getElementById('modalScoreInput').value = currentScore; // æŠŠèˆŠæˆç¸¾å¡«é€²å»
            
            // é¡¯ç¤ºè¦–çª— (æ”¹æˆ flex æ‰èƒ½ç½®ä¸­)
            document.getElementById('editModal').style.display = 'flex';
        }

        // 2. é—œé–‰è¦–çª—
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingId = null; // æ¸…ç©ºè¨˜æ†¶
        }

        // 3. æŒ‰ä¸‹ã€Œå„²å­˜ä¿®æ”¹ã€
        async function saveEdit() {
            const newScore = document.getElementById('modalScoreInput').value;
            
            if (!newScore) { alert("è«‹è¼¸å…¥æˆç¸¾"); return; }

            // é€å‡ºä¿®æ”¹çµ¦ Supabase
            const { error } = await db
                .from('students')
                .update({ score: newScore })
                .eq('id', currentEditingId);

            if (error) {
                alert("ä¿®æ”¹å¤±æ•—");
            } else {
                closeModal(); // é—œé–‰è¦–çª—
                fetchData();  // é‡æ–°æ•´ç†è¡¨æ ¼
            }
        }
    </script>

</body>
</html>
