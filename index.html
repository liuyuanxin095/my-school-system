<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚åœ‹å° - æ ¡å‹™ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* V7.0 é¢¨æ ¼è¨­å®š */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f5f7fa; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 800px; } /* å†å¯¬ä¸€é»å®¹ç´æ›´å¤šè³‡è¨Š */
        
        h1 { color: #2c3e50; margin-bottom: 20px; display: flex; align-items: baseline; justify-content: center; gap: 10px; }
        .version-tag { font-size: 14px; color: #fff; background-color: #e67e22; padding: 2px 8px; border-radius: 4px; vertical-align: middle; font-weight: normal; }

        /* è¼¸å…¥æ¡†èˆ‡é¸å–®å„ªåŒ– */
        input, select { padding: 10px; margin: 5px 0; border: 1px solid #e0e0e0; border-radius: 6px; box-sizing: border-box; background: white; }
        input:focus, select:focus { border-color: #3498db; outline: none; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn { width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #2ecc71; } /* æ–°å¢æŒ‰éˆ• */
        .btn-purple { background-color: #9b59b6; } /* æ‰¹æ¬¡é»åæŒ‰éˆ• */
        .btn-gray { background-color: #95a5a6; }
        
        /* è¡¨æ ¼å…§å°æŒ‰éˆ• */
        .btn-sm { padding: 5px 10px; font-size: 14px; margin: 0 2px; width: auto; border-radius: 4px; border:none; color:white; cursor:pointer;}
        .btn-red { background-color: #e74c3c; }
        .btn-yellow { background-color: #f1c40f; color: #333; }

        #dashboard { display: none; }
        #loading { display: none; color: #7f8c8d; text-align: center; margin-top: 10px; }

        /* è³‡æ–™è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; color: #34495e; }
        th { background-color: #fafafa; color: #7f8c8d; font-weight: 600; }
        
        .control-panel { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px;}
        .filter-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .input-row { display: flex; gap: 10px; }

        /* æµ®å‹•è¦–çª— (Modal) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 12px; width: 500px; text-align: center; /* æ‰¹æ¬¡é»åè¦–çª—è¦å¯¬ä¸€é» */
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popUp 0.3s ease-out; max-height: 80vh; overflow-y: auto;
        }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-btn-group { display: flex; gap: 10px; margin-top: 20px; }

        /* æ‰¹æ¬¡é»ååˆ—è¡¨æ¨£å¼ */
        .batch-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .batch-select { width: 100px; padding: 5px; margin: 0; }
    </style>
</head>
<body>

    <div id="login-page" class="container">
        <h1>æ ¡å‹™ç³»çµ±ç™»å…¥ <span class="version-tag">v7.0</span></h1>
        <input type="email" id="emailInput" placeholder="Email">
        <input type="password" id="passwordInput" placeholder="å¯†ç¢¼">
        <button class="btn btn-blue" onclick="handleLogin()">ç™»å…¥</button>
        <p id="loading">é©—è­‰ä¸­...</p>
    </div>

    <div id="dashboard" class="container">
        <h1>æ ¡å‹™ç®¡ç†å¾Œå° <span class="version-tag">v7.0</span></h1>
        
        <div class="control-panel">
            <div class="filter-row">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ” ç­ç´šç¯©é¸ï¼š</span>
                    <select id="classFilter" onchange="fetchData()" style="width: 150px;">
                        <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
                        </select>
                </div>
                <button class="btn btn-purple" style="width: auto; margin:0;" onclick="openBatchModal()">âš¡ å…¨ç­æ‰¹æ¬¡é»å</button>
            </div>

            <div class="input-row">
                <input type="text" id="newClass" placeholder="ç­ç´š (ä¾‹: 101)" style="flex: 0.8;">
                <input type="text" id="newId" placeholder="å­¸è™Ÿ" style="flex: 1;">
                <input type="text" id="newName" placeholder="å§“å" style="flex: 1;">
                <input type="number" id="newScore" placeholder="æˆç¸¾" style="flex: 0.8;">
            </div>
            <button class="btn btn-green" style="margin-top:0;" onclick="addData()">æ–°å¢å­¸ç”Ÿ</button>
        </div>

        <table id="studentTable">
            <thead>
                <tr>
                    <th>ç­ç´š</th>
                    <th>å­¸è™Ÿ</th>
                    <th>å§“å</th>
                    <th>æˆç¸¾</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <button class="btn btn-gray" onclick="handleLogout()" style="margin-top: 30px;">ç™»å‡ºç³»çµ±</button>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box" style="width: 350px;">
            <h3>âœï¸ ä¿®æ”¹æˆç¸¾</h3>
            <p id="modalStudentName" style="color: #666;">...</p>
            <input type="number" id="modalScoreInput" placeholder="è¼¸å…¥æ–°æˆç¸¾">
            <div class="modal-btn-group">
                <button class="btn btn-gray" onclick="document.getElementById('editModal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-blue" onclick="saveEdit()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="batchModal" class="modal-overlay">
        <div class="modal-box">
            <h3>âš¡ å¿«é€Ÿé»å</h3>
            <p style="color:#666; font-size: 14px;">é è¨­ç‚ºã€Œå‡ºå¸­ã€ï¼Œè«‹æ‰‹å‹•èª¿æ•´ç¼ºå¸­å­¸ç”Ÿ</p>
            
            <div style="margin-bottom: 15px; text-align: left;">
                <label>æ—¥æœŸï¼š</label>
                <input type="date" id="batchDate" style="width: 100%;">
            </div>

            <div id="batchListArea" style="text-align: left; max-height: 300px; overflow-y: auto;">
                </div>

            <div class="modal-btn-group">
                <button class="btn btn-gray" onclick="document.getElementById('batchModal').style.display='none'">å–æ¶ˆ</button>
                <button class="btn btn-purple" onclick="saveBatchAttendance()">é€å‡ºå…¨ç­ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <script>
        // =======================================================
        // ğŸ”¥ğŸ”¥ğŸ”¥ è¨­å®šå€ï¼šè«‹å¡«å…¥ä½ çš„ URL å’Œ Key ğŸ”¥ğŸ”¥ğŸ”¥
        // =======================================================
        const supabaseUrl = 'https://blzkbhjjoqylinywxtyy.supabase.co';
        const supabaseKey = 'sb_publishable_k5DR0vYzR9-GKrHoysRFjA_iTMlJPjh';
        // =======================================================

        const db = supabase.createClient(supabaseUrl, supabaseKey);
        let currentEditingId = null;
        let allStudentsCache = []; // æš«å­˜æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œæ–¹ä¾¿æ‰¹æ¬¡è™•ç†

        checkSession();

        async function checkSession() {
            const { data: { session } } = await db.auth.getSession();
            if (session) showDashboard();
        }

        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            document.getElementById('loading').style.display = 'block';
            const { error } = await db.auth.signInWithPassword({ email, password });
            if (error) { alert("ç™»å…¥å¤±æ•—"); document.getElementById('loading').style.display = 'none'; }
            else showDashboard();
        }

        async function handleLogout() { await db.auth.signOut(); location.reload(); }

        function showDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            fetchData();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å–èˆ‡ç¯©é¸ ---
        async function fetchData() {
            // 1. æŠ“å–æ‰€æœ‰å­¸ç”Ÿ
            const { data, error } = await db
                .from('students')
                .select('*')
                .order('class_name', { ascending: true }) // å…ˆç…§ç­ç´šæ’
                .order('student_id', { ascending: true }); // å†ç…§å­¸è™Ÿæ’

            if (error) { console.error(error); return; }
            
            allStudentsCache = data; // å­˜èµ·ä¾†çµ¦æ‰¹æ¬¡åŠŸèƒ½ç”¨

            // 2. è™•ç†ã€Œç­ç´šé¸å–®ã€çš„é¸é … (è‡ªå‹•æ‰¾å‡ºæœ‰å“ªäº›ç­ç´š)
            updateClassFilterOptions(data);

            // 3. æ ¹æ“šé¸å–®ç¯©é¸è³‡æ–™
            const filterValue = document.getElementById('classFilter').value;
            const filteredData = filterValue === 'ALL' 
                ? data 
                : data.filter(s => s.class_name === filterValue);

            // 4. é¡¯ç¤ºè¡¨æ ¼
            renderTable(filteredData);
        }

        function updateClassFilterOptions(students) {
            const filterSelect = document.getElementById('classFilter');
            const currentVal = filterSelect.value; // è¨˜ä½ç¾åœ¨é¸çš„ï¼Œé¿å…é‡æ•´å¾Œè·³æ‰
            
            // æ‰¾å‡ºæ‰€æœ‰ä¸é‡è¤‡çš„ç­ç´š
            const classes = [...new Set(students.map(s => s.class_name).filter(c => c))];
            
            // é‡æ–°ç”¢ç”Ÿé¸é …
            filterSelect.innerHTML = '<option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>';
            classes.forEach(c => {
                filterSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            
            // å˜—è©¦é¸å›å‰›å‰›é¸çš„å€¼
            if (classes.includes(currentVal)) {
                filterSelect.value = currentVal;
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ""; 
            data.forEach(s => {
                // å¦‚æœæ²’æœ‰ç­ç´šï¼Œé¡¯ç¤ºæœªåˆ†ç­
                const className = s.class_name || "æœªåˆ†ç­";
                tableBody.innerHTML += `
                <tr>
                    <td><span style="background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:12px;">${className}</span></td>
                    <td>${s.student_id}</td>
                    <td>${s.name}</td>
                    <td>${s.score}</td>
                    <td>
                        <button class="btn-sm btn-yellow" onclick="openEditModal('${s.id}', '${s.name}', '${s.score}')">ä¿®æ”¹</button>
                        <button class="btn-sm btn-red" onclick="deleteStudent('${s.id}', '${s.name}')">åˆªé™¤</button>
                    </td>
                </tr>`;
            });
        }

        // --- CRUD åŠŸèƒ½ ---
        async function addData() {
            const cls = document.getElementById('newClass').value;
            const id = document.getElementById('newId').value;
            const name = document.getElementById('newName').value;
            const score = document.getElementById('newScore').value;
            if (!id || !name || !score) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }

            const { error } = await db.from('students').insert({ 
                class_name: cls, // æ–°å¢ç­ç´šæ¬„ä½
                student_id: id, 
                name: name, 
                score: score 
            });
            
            if (error) alert("æ–°å¢å¤±æ•—");
            else {
                document.getElementById('newId').value = '';
                document.getElementById('newName').value = '';
                document.getElementById('newScore').value = '';
                fetchData();
            }
        }

        async function deleteStudent(id, name) {
            if (confirm(`ç¢ºå®šåˆªé™¤ ${name}?`)) {
                await db.from('students').delete().eq('id', id);
                fetchData();
            }
        }

        function openEditModal(id, name, score) {
            currentEditingId = id;
            document.getElementById('modalStudentName').innerText = name;
            document.getElementById('modalScoreInput').value = score;
            document.getElementById('editModal').style.display = 'flex';
        }

        async function saveEdit() {
            const val = document.getElementById('modalScoreInput').value;
            await db.from('students').update({ score: val }).eq('id', currentEditingId);
            document.getElementById('editModal').style.display='none';
            fetchData();
        }

        // =========================================
        // ğŸ”¥ æ‰¹æ¬¡é»åé‚è¼¯ (Batch Attendance)
        // =========================================
        function openBatchModal() {
            // 1. å–å¾—ç›®å‰ç¯©é¸çš„ç­ç´š
            const filterValue = document.getElementById('classFilter').value;
            
            // 2. æ±ºå®šè¦é»åå“ªäº›äºº
            const targets = filterValue === 'ALL' 
                ? allStudentsCache 
                : allStudentsCache.filter(s => s.class_name === filterValue);

            if (targets.length === 0) { alert("ç›®å‰åˆ—è¡¨æ²’æœ‰å­¸ç”Ÿå¯ä»¥é»åå–”ï¼"); return; }

            // 3. è¨­å®šæ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('batchDate').value = new Date().toISOString().split('T')[0];

            // 4. ç”¢ç”Ÿé»ååˆ—è¡¨ HTML
            const listArea = document.getElementById('batchListArea');
            listArea.innerHTML = ""; // æ¸…ç©º

            targets.forEach(s => {
                // æ¯å€‹äººéƒ½æœ‰ä¸€å€‹éš±è—çš„ ID æ¨™ç±¤ï¼Œå’Œä¸€å€‹ä¸‹æ‹‰é¸å–®
                listArea.innerHTML += `
                <div class="batch-list-item">
                    <span>${s.student_id} ${s.name}</span>
                    <select class="batch-select" data-student-id="${s.student_id}">
                        <option value="å‡ºå¸­" selected>âœ… å‡ºå¸­</option>
                        <option value="é²åˆ°">âš ï¸ é²åˆ°</option>
                        <option value="ç¼ºå¸­">âŒ ç¼ºå¸­</option>
                        <option value="äº‹å‡">ğŸ“„ äº‹å‡</option>
                        <option value="ç—…å‡">ğŸ˜· ç—…å‡</option>
                    </select>
                </div>`;
            });

            document.getElementById('batchModal').style.display = 'flex';
        }

        async function saveBatchAttendance() {
            const date = document.getElementById('batchDate').value;
            
            // 1. æŠ“å–æ‰€æœ‰é¸å–®çš„çµæœ
            const selects = document.querySelectorAll('.batch-select');
            const records = [];

            selects.forEach(select => {
                records.push({
                    student_id: select.getAttribute('data-student-id'),
                    record_date: date,
                    status: select.value
                });
            });

            // 2. ä¸€æ¬¡æŠŠæ‰€æœ‰è³‡æ–™é€é€² Supabase (é€™å« Bulk Insert)
            const { error } = await db.from('attendance').insert(records);

            if (error) {
                console.error(error);
                alert("é»åå¤±æ•—ï¼è«‹æª¢æŸ¥ Console");
            } else {
                alert(`æˆåŠŸé€å‡º ${records.length} ç­†é»åç´€éŒ„ï¼`);
                document.getElementById('batchModal').style.display = 'none';
            }
        }

    </script>
</body>
</html>
